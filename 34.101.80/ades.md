-------------------------------------------------------------
**СТБ 34.101.80-2019**

**Информационные технологии и безопасность**

**РАСШИРЕННЫЕ ЭЛЕКТРОННЫЕ ЦИФРОВЫЕ ПОДПИСИ**

**Інфармацыйныя тэхналогіі і бяспека**

**ПАШЫРАНЫЯ ЭЛЕКТРОННЫЯ ЛІЧБАВЫЯ ПОДПІСЫ**

**Information technology and security**

**Advanced digital signatures**

-------------------------------------------------------------

# <a name="con"></a>Содержание

### [1 Область применения](#logo)
### [2 Нормативные ссылки](#refs)
### [3 Термины и определения](#terms)
### [4 Обозначения и сокращения](#defs)
### [5 Общие положения](#common)
### [6 Атрибуты](#attrs)
### [7 Профили](#profiles)
### [8 Процессы](#processes)
### [9 Формат CAdES](#cades)
### [10 Формат XAdES](#xades)
### [11 Формат PADES](#pades)
### [Приложение А (рекомендуемое) Расширенные профили](#profileEx)
### [Библиография](#biblio)

# 1 <a name="logo"></a> Область применения

Настоящий стандарт устанавливает форматы расширенной электронной цифровой
подписи, которая, дополнительно к базовой, включает (и при необходимости
контролирует) атрибуты подписанного документа и подписавшей его стороны.
Расширенная подпись повышает гарантии целостности и подлинности электронного
документа при его проверке, уточняет правила проверки, облегчает проверку.

Настоящий стандарт применяется при создании и обработке электронных документов
форматов АСН.1, XML и PDF.

# 2 <a name="refs"></a>Нормативные ссылки

В настоящем стандарте использованы ссылки на следующие 
технические нормативные правовые акты в области 
технического нормирования и стандартизации (далее — ТНПА):

СТБ 34.101.19-2012 Информационные технологии и безопасность. 
Форматы сертификатов и списков отозванных сертификатов 
инфраструктуры открытых ключей

СТБ 34.101.23-2012 Информационные технологии и безопасность. 
Синтаксис криптографических сообщений

СТБ 34.101.26-2012 Информационные технологии и безопасность. 
Онлайновый протокол проверки статуса сертификата (OCSP)

СТБ 34.101.31-2011 Информационные технологии. Защита информации.
Криптографические алгоритмы шифрования и контроля целостности

СТБ 34.101.45-2013 Информационные технологии и безопасность. 
Алгоритмы электронной цифровой подписи и транспорта ключа на основе
эллиптических кривых

СТБ 34.101.50-2019 Информационные технологии и безопасность. 
Правила регистрации объектов информационных технологий

СТБ 34.101.67-2013 Информационные технологии и безопасность. 
Инфраструктура атрибутных сертификатов

СТБ 34.101.82-2019 Информационные технологии и безопасность. Протокол
постановки штампа времени 

ГОСТ 34.973-91 (ИСО 8824-87) Информационная технология. Взаимосвязь
открытых систем. Спецификация абстрактно-синтаксической нотации
версии 1 (АСН.1)

ГОСТ 34.974-91 (ИСО 8825-87) Информационная технология. Взаимосвязь 
открытых систем. Описание базовых правил кодирования для 
абстрактно-синтаксической нотации версии 1 (АСН.1)

>Примечание — При пользовании настоящим стандартом целесообразно проверить
действие ТНПА по каталогу, составленному по состоянию на 1 января текущего года,
и по соответствующим информационным указателям, опубликованным в текущем году.

>Если ссылочные ТНПА заменены (изменены), то при пользовании настоящим
стандартом следует руководствоваться действующими взамен ТНПА. Если ссылочные
ТНПА отменены без замены, то положение, в котором дана ссылка на них,
применяется в части, не затрагивающей эту ссылку.


# 3 <a name="terms"></a>Термины и определения

В настоящем стандарте применяют термины, установленные в СТБ 34.101.19,
СТБ 34.101.23, СТБ 34.101.45, СТБ 34.101.67, а также следующие термины с 
соответствующими определениями:

**3.1 атрибут**: 
Дополнительные данные, относящиеся к подписываемому документу, подписанту
или подписи, которые уточняют назначение расширенной электронной цифровой
подписи и используются для повышения гарантий ее действительности.

**3.2 аттестат (validation data)**: 
Данные, которые используются при проверке расширенной электронной цифровой 
подписи или других аттестатов, хранятся отдельно от подписи или вместе с 
ней в виде атрибутов. 

> Примечание – К аттестатам относятся сертификаты открытых 
ключей, цепочки сертификатов, списки отозванных сертификатов, штампы и 
рапорты времени. 

<!--
Validation Data: additional data that may be used by a verifier of
electronic signatures to determine that the signature is valid.
-->

**3.3 аттестат отзыва (revocation value)**: 
Аттестат, который описывает статус отзыва одного или нескольких
сертификатов, например, список отозванных сертификатов или OCSP-ответ.

**3.4 аттестат существования**: 
Аттестат, который связывает данные или ссылки на них (как правило, через
хэш-значения) с определенным моментом времени, тем самым удостоверяя
существование данных к этому моменту.

> Примечание – Примерами аттестатов существования являются штамп и рапорт 
времени.

**3.5 базовая электронная цифровая подпись (digital signature value)**: 
Электронная цифровая подпись без дополнительных атрибутов.

**3.6 базовые правила кодирования (basic encoding rules, BER)**: 
Правила кодирования значений типов АСН.1, установленные в ГОСТ 34.974.

**3.7 верификатор; проверяющая сторона (verifier)**: 
Cторона, проверяющая расширенную электронную цифровую подпись.

**3.8 вложенная подпись (enveloped signature)**: 
Расширенная электронная цифровая подпись, включенная в подписанный документ.

> Примечание – Документ подписывается без подписи.

**3.9 действительная подпись (valid signature)**: 
Расширенная электронная цифровая подпись, прошедшая проверку. 

**3.10 доказательство существования (proof of existence, POE)**: 
Свидетельство существования определенных данных к определенному моменту
времени, извлекаемое из аттестата существования.

**3.11 документ**: 
Сообщение, двоичное слово конечной длины.

**3.12 дополнение подписи (signature augmentation)**: 
Процесс сбора и сохранения в расширенной электронной цифровой подписи
дополнительных данных, которые позволят сделать подпись
долгосрочной.

>Примечание – Под дополнительными данными понимаются аттестаты.

<!--
**издатель политики подписи (signature policy issuer)**: 
Сторона, определяющая и издающая политику подписи. 
-->

**3.13 модуль штампов времени (time-stamping unit)**: 
Компонент службы штампов времени, Набор программного и аппаратного
обеспечения с единственным активным в конкретный момент времени ключом
подписи штампов.

<!--
Time-Stamping Unit (TSU): a set of hardware and software that is
managed as a unit and has a single time-stamp token signing key
active at a time.
-->

**3.14 обертывающая подпись (enveloping signature)**: 
Расширенная электронная цифровая подпись, включающая подписанный документ.

**3.15 отделенная подпись (detached signature)**: 
Расширенная электронная цифровая подпись, которая по отношению к подписанному 
документу не является ни вложенной, ни обертывающей. 

**3.16 отличительные правила кодирования (distinguished encoding rules, DER)**:
Базовые правила кодирования с уточнениями, определенными в СТБ 34.101.19 
(приложение Б). 

**3.17 отметка времени (time-stamp)**: 
Последовательность символов, с некоторой точностью описывающая определенный 
момент времени. 

<!--
**период отсрочки (grace period)**: 
Промежуток времени, отведенный для передачи 
заинтересованным сторонам сведений об отзыве сертификата. 

Grace Period: a time period that permits the certificate revocation
information to propagate through the revocation process to relying
parties. 
-->

**3.18 подписант; подписывающая сторона; подписавшая сторона (signer)**: 
Сторона, создающая или создавшая расширенную электронную цифровую подпись. 

<!-- 
**последующая проверка (subsequent verification)**: 
Процесс, выполняемый верификатором для оценки действительности расширенной 
электронной цифровой подписи после ее создания и завершения исходной проверки. 
Для последующей проверки не требуются дополнительные аттестаты, кроме тех, что  
были получены во время исходной проверки. 
-->

**3.19 политика выработки подписи (signature creation policy)**: 
Часть политики подписи, которая определяет технические требования к
процессу выработки подписи, в рамках которых определяется состоятельность
подписи.

**3.20 политика подписи (signature policy)**: 
Правила создания и проверки расширенной электронной цифровой подписи,
которые учитывают особенности системы обработки электронных документов, 
и в рамках которых определяется состоятельность и действительность подписи
в этой системе.

<!--
Signature Policy: a set of rules for the creation and validation of
an electronic signature that defines the technical and procedural
requirements for electronic signature creation and validation, in
order to meet a particular business need, and under which the
signature can be determined to be valid.

A signature policy is a set of rules for the creation and validation of an 
electronic signature, under which the validity of signature can be determined. 
A given legal/contractual context may recognize a particular signature policy 
as meeting its requirements.
-->

**3.21 политика дополнения подписи (signature augmentation policy)**: 
Часть политики подписи, которая определяет технические требования к
процессу дополнения подписи новыми атрибутами, в рамках которых
определяется состоятельность подписи.

**3.22 политика проверки подписи (signature validation policy)**: 
Часть политики подписи, которая определяет технические требования к
процессу проверки подписи, в рамках которых определяется действительность
подписи.

<!--
Signature Validation Policy: part of the signature policy that
specifies the technical requirements on the signer in creating a
signature and verifier when validating a signature.
-->

**3.23 поставщик услуг доверия (trust service provider)**:
Сторона, которая помогает установить доверенные отношения между другими 
сторонами, предоставляя определенную информацию по их запросу.

<!-- trust service provider, TSP 
В новых стандартах именно "trust", хотя раньше было "trusted"
-->

**3.24 прикладная программа (driving application)**: 
Программа для работы с электронными документами, которая использует систему
выработки подписи, программу дополнения подписи или программу проверки
подписи.

**3.25 программа выработки подписи (signature creation application)**: 
Программа, которая создает расширенную электронную цифровую подпись,
обращаясь к средству выработки подписи и взаимодействуя с подписантом.

**3.26 программа проверки подписи (signature validation application)**: 
Программа, которая проверяет расширенную электронную цифровую подпись.

<!--
**программа дополнения подписи (signature augmentation application)**: 
Программа, которая дополняет расширенную электронную цифровую подпись
новыми неподписанными атрибутами, как правило, аттестатами проверки.
-->

<!--
**продление подписи**: 
Дополнение подписи, при котором в нее добавляется штамп времени от
предыдущих атрибутов. Штамп удостоверяет существование подписи к
определенному моменту времени, тем самым позволяя сохранить гарантии
действительности подписи даже при снижении стойкости криптографических
алгоритмов, которые использовались для построения предыдущих атрибутов.
-->

**3.27 профиль**:
Набор обязательных и необязательных атрибутов расширенной электронной
цифровой подписи, а также правила их формирования и разбора.

**3.28 рапорт времени (time-mark)**:
Аттестат существования, который представляет собой запись в журнале 
аудита специального поставщика услуг доверия.

<!--
Time-Mark: information in an audit trail from a Trusted Service
Provider that binds a representation of a datum to a particular time,
thus establishing evidence that the datum existed before that time.
-->

**3.29 расширенная электронная цифровая подпись (advanced electronic 
signature)**:
Электронная цифровая подпись документа и атрибутов
(подписанных) вместе с дополнительными атрибутами (неподписанными).

**3.30 система выработки подписи (signature creation system)**: 
Программа выработки подписи вместе со средством электронной цифровой подписи.

<!--
**служба рапортов времени (time-marking authority)**: 
Поставщик услуг доверия, который создает записи в журнале аудита, 
фиксируя существование определенных данных к определенному моменту времени. 
-->

<!--
Time-Marking Authority: a trusted third party that creates records in
an audit trail in order to indicate that a datum existed before a
particular point in time.
-->

<!--
**служба штампов времени (time-stamping authority)**: 
Поставщик услуг доверия, который создает штампы времени для подтверждения 
существования данных к определенному моменту времени. 
-->

<!--
Time-Stamping Authority (TSA): a trusted third party that creates
time-stamp tokens in order to indicate that a datum existed at a
particular point in time.
-->

**3.31 средство электронной цифровой подписи (signature creation device)**:
Средство криптографической защиты информации, которое хранит 
личный ключ подписанта и реализует выработку на нем базовой 
электронной цифровой подписи.

**3.32 цепочка сертификатов (certificate chain)**: 
Маршрут сертификации.

**3.33 штамп времени (time-stamp token)**: 
Аттестат существования, который представляет собой расширенную электронную 
цифровую подпись, одним из подписанных атрибутов которой является отметка 
времени.

<!--
Time-Stamp Token: a data object that binds a representation of a
datum to a particular time, thus establishing evidence that the datum
existed before that time.
-->

**3.34 электронный документ (electronic document)**: 
Документ с расширенной электронной цифровой подписью, позволяющей проверить 
его целостность и подлинность. 

# 4 <a name="defs"></a>Сокращения

В настоящем стандарте применяют следующие сокращения:

АСН.1 — абстрактно-синтаксическая нотация версии 1 (см. ГОСТ 34.973);

ППП — программа проверки подписи;

РЭЦП — расширенная электронная цифровая подпись;

СВП — система выработки подписи;

СОК — сертификат открытого ключа (см. СТБ 34.101.19);

CОС — список отозванных сертификатов (см. СТБ 34.101.19);

ПСОС — приращение списка отозванных сертификатов (см. СТБ 34.101.19);

УЦ — удостоверяющий центр (см. СТБ 34.101.19);

ЭД — электронный документ;

ЭЦП — электронная цифровая подпись;

CAdES — РЭЦП в формате АСН.1;

Base64 — правила кодирования двоичных данных словами в алфавите из 64 
символов см. [[19]](#biblio.BASE64);

MIME — multipurpose Internet mail extensions (многоцелевые расширения 
интернет-почты, см. [[16]](#biblio.MIME); 

PAdES — РЭЦП для PDF;

PDF — portable data format (переносимый формат данных, см. [[18]](#biblio.PDF);

URI — uniform resource identifier (унифицированный идентификатор ресурса, 
см. [[1]](#biblio.URI); 

URN — uniform resource name (унифицированное имя ресурса, см. [[20]](#biblio.URN); 

XAdES — РЭЦП для XML;

XML — extensible markup language (расширяемый язык разметки, см. [[2]](#biblio.XML);

XML-DSig — XML digital signature (ЭЦП для XML, см. [[5]](#biblio.XML-DSIG);

XPointer — XML pointer (указатель XML, см. [[3]](#biblio.XPointer).

Ключевое слово «ДОЛЖЕН» означает, что действия, к которым применены данные
ключевые слова, необходимо в точности выполнять. Ключевое слово «НЕ ДОЛЖЕН»
выражает абсолютный запрет на выполнение соответствующих действий. Ключевые
слова «СЛЕДУЕТ» и «РЕКОМЕНДУЕТСЯ» необходимо понимать так, что в некоторых
случаях существует реальная причина их игнорировать, но последствия таких
действий должны быть очевидными и хорошо взвешенными. Ключевое слово
«НЕ СЛЕДУЕТ» применяется в тех случаях, когда действие, к которому применено
данное ключевое слово, будет в некоторых случаях правильным и даже полезным,
однако при этом его последствия должны быть очевидными и хорошо взвешенными.
Ключевое слово «МОЖЕТ» применяется к действиям (предметам), выполнение или
невыполнение (наличие или отсутствие) которых не влияет на ситуацию в целом. Это
означает, что программы, работающие с чем-то, помеченным данными ключевыми
словами, должны учитывать обе ситуации и корректно их обрабатывать.


# 5 <a name="common"></a> Общие положения

## 5.1 <a name="common1"></a>Назначение

Настоящий стандарт устанавливает форматы РЭЦП, а также правила выработки, 
дополнения и проверки расширенных подписей. Стандарт основан на документах 
[[6]](#biblio.XADES1)-[[15]](#biblio.PROCESSES), разработанных Европейским институтом 
телекоммуникационных стандартов (ETSI).

Расширенная подпись дополнительно к базовой (вырабатываемой, например, с
помощью алгоритмов СТБ 34.101.45) включает атрибуты подписанного документа
и подписавшей его стороны. Подпись встраивается в документ (вложенная
подпись), включает документ (обертывающая подпись) или хранится отдельно от
него (отделенная подпись). Подпись делает документ электронным, т.е.
защищенным. Проверяя подпись, можно удостовериться в целостности и
подлинности ЭД. Атрибуты усиливают гарантии целостности и подлинности,
уточняют правила проверки подписи, облегчают проверку.

Атрибуты могут быть подписанными и неподписанными. РЭЦП контролирует
целостность и подлинность подписанных атрибутов. Фактически сам документ
представляется такими атрибутами — идентификатором алгоритма хэширования и
хэш-значением, полученным с помощью этого алгоритма. Примеры других
подписанных атрибутов — тип документа, время подписи, сертификат
подписанта. Неподписанные атрибуты — это, как правило, аттестаты, которые
используются при проверке подписи. Примеры неподписанных атрибутов —
цепочка сертификатов, список отозванных сертификатов, ссылка на цепочку или
список, штамп времени.

В разделе [6](#attrs) определяются возможные атрибуты РЭЦП: 
описывается их семантика (содержание, интерпретация), дается классификация 
(подписанный, неподписанный).

В зависимости от ситуации, т.е. нужд конкретной информационной системы,
в РЭЦП могут включаться те или иные атрибуты. Перечень обязательных и 
рекомендуемых атрибутов, правила их формирования и разбора описываются 
профилями атрибутов. В разделе [7](#profiles) определяются 4 таких профиля. 
Профили обозначаются аббревиатурами B-B, B-T, B-LT, B-LTA.
Профили в указанном порядке последовательно расширяют друг друга. 

Профиль B-B (базовый) требует включения в РЭЦП стандартных базовых
атрибутов. Профиль B-T (контроль времени подписи) дополнительно требует
включения штампа времени. Профиль B-LT (долгосрочный) обязывает добавлять в
РЭЦП все сертификаты, задействованные прямо или косвенно, вместе с
информацией об их текущем статусе. Профиль B-LTA (долгосрочный архивный)
требует включения штампа времени от всех атрибутов профиля B-LT. Штамп
подтверждает корректность всех предъявленных (в момент постановки штампа)
аттестатов. Вырабатывая штампы периодически (например, ежегодно) и
используя при этом сохранившие стойкость криптографические алгоритмы, можно
обеспечить надежное архивное хранение ЭД даже при снижении стойкости
первоначальных алгоритмов.

Кроме 4 перечисленных профилей, которые считаются базовыми, в приложении A
определяются 8 расширенных: E-BES, E-EPES, E-T, E-C, E-A, E-X, E-X-L,
E-X-Long. В расширенных профилях, в отличие от базовых, разрешается не
указывать сертификаты, списки отозванных сертификатов и другие аттестаты, 
а давать ссылки на них. 

В разделе [8](#processes) определяются процессы выработки и проверки РЭЦП 
базовых профилей, и при этом описываются процессы дополнения РЭЦП новыми
неподписанными атрибутами. Процессы дополнения встроены в процессы
выработки подписи, их выполняет подписант. Процессы дополнения имеют также
самостоятельное значение, их может выполнять верификатор.

## 5.2 <a name="common2"></a>Форматы

Формат РЭЦП определяет ее синтаксис, т.е. правила записи и кодирования
атрибутов и базовой ЭЦП. Формат может также определять правила встраивания
РЭЦП в ЭД. В настоящем стандарте определены три формата: CAdES, XAdES и
PAdES.

Формат CAdES (от англ. CMS Advanced Electronic Signature) является
уточнением формата подписанных данных, определенного в СТБ 34.101.23
(раздел 8). Подпись CAdES описывается на языке АСН.1, определенном 
в ГОСТ 34.973, и задается типом `SignedData`. Подписываемый документ
может иметь произвольный формат.

Формат XAdES (от англ. XML Advanced Electronic Signature) является
уточнением формата XML-DSig, представленного в СТБ 34.101.50 (приложение E).
Подпись XAdES описывается на языке XML, определенном в [[2]](#biblio.XML). 
Подписываются части (элементы) XML-документа или весь XML-документ целиком.

Подпись PAdES (от англ. PDF Advanced Electronic Signature) встраивается в
документы формата PDF, определенного в [[18]](#biblio.PDF). 
Подпись представляется либо в формате CAdES, либо в формате XAdES.

Каждый из форматов уточняется профилем атрибутов. Профиль добавляется к 
названию формата через дефис. Например, через CAdES-B-LTA обозначается 
долгосрочная архивная РЭЦП формата CAdES.

## 5.3 <a name="common3"></a>Стороны

В создании и проверке РЭЦП участвуют следующие стороны:

- подписант;
- верификатор;
- поставщики услуг доверия.

Подписант вырабатывает РЭЦП документа. Выработка подписи означает взятие на себя
ответственности за содержимое документа.

Верификатор проверяет РЭЦП. Одну и ту же РЭЦП могут проверять несколько
верификаторов.

Поставщики услуг доверия создают доверенные отношения между подписантом и
верификатором, выпуская сертификаты, штампы времени, СОС, ответы OCSP и другие.
данные. Эти данные могут использоваться в качестве аттестатов.

В настоящем стандарте рассматриваются следующие поставщики услуг доверия: 

- удостоверяющие центры;
- издатели СОС;
- регистрационные центры;
- серверы OCSP;
- службы хранения;
- службы штампов времени;
- службы рапортов времени;
- издатели политик подписи.

УЦ выпускают СОК, оказывают владельцам услуги по их отзыву, информируют других
пользователей об отзыве, выпуская СОС. УЦ может делегировать функцию выпуска СОС
отдельной службе. Логика работы УЦ, форматы СОК и СОС определены в СТБ
34.101.19.

РЦ проверяют подлинность пользователей перед тем, как УЦ выдаст им сертификат.

Серверы OCSP обрабатывают запросы о статусе сертификатов и выпускают
соответствующие ответы. Логика работы серверов, форматы запросов и ответов
определены в СТБ 34.101.26.

Службы хранения публикуют СОK и СОС, выпущенные УЦ, политики подписей,
выпущенные издателями политик, другие данные.

Службы штампов (рапортов) времени удостоверяют (регистрируют) существование
определенных данных к определенному моменту времени.

Наконец, издатели политик подписи определяют правила, которые обеспечивают
согласованность результатов проверки подписи различными верификаторами. При этом
либо подписант явно задает используемую политику (например, через атрибут), либо
политика неявно определяется по подписанным данным. Политика определяется
достаточно подробно, чтобы результаты проверки подписи различными верификаторами
не отличались.

Дополнительно в качестве поставщиков услуг доверия могут использоваться центры
атрибутных сертификатов. Эти центры фиксируют полномочия владельцев СОК,
выпуская для них атрибутные сертификаты.


# 6 <a name="attrs"></a>Атрибуты

<!--- при описании атрибутов в коментариях даются ссылки на разделы 
в первоисточниках: ETSI TS 101 733 v020202; ETSI TS 119 122 01 v010001
-->

## 6.1 <a name="attr1"></a>Общие положения

Атрибуты содержат информацию, которая уточняет интерпретацию и назначение РЭЦП.
Атрибуты формируются подписантом или системой выработки РЭЦП в соответствии с
политикой подписи и выбранным профилем РЭЦП.

Атрибуты МОГУТ быть подписанными или неподписанными. Подписанные атрибуты
фиксируются при выработке ЭЦП. Неподписанные атрибуты могут быть добавлены или
удалены позже; целостность и подлинность таких атрибутов контролируется неявно.
Набор атрибутов, включаемых в РЭЦП, определяется политикой РЭЦП.

Атрибут МОЖЕТ не включаться в РЭЦП, включаться в единственном экземпляре или
включаться несколько раз.

Формат подписанных данных МОЖЕТ содержать несколько подписей, выработанных
различными подписантами (утверждающая подпись включается как неподписанный
атрибут утверждаемой подписи, а не отдельная, независимая подпись). Атрибуты
формируются подписантами независимо. Подписи, сформированные различными
подписантами, МОГУТ соответствовать различным профилям.

Семантика и правила включения атрибутов МОГУТ отличаться в зависимости от
формата. В этом случае при описании атрибута указывается явно, в РЭЦП какого
формата он применяется.

Атрибуты можно разбить на 4 класса:

- базовые атрибуты, относящиеся к подписанту, подписываемым данным или подписи;
- атрибуты, содержащие штамп времени подписи; 
- атрибуты, содержащие проверочные данные;
- атрибуты, содержащие данные для архивной проверки.

РЭЦП МОЖЕТ содержать другие атрибуты, специфичные для приложения.

## 6.2 <a name="attr2"></a>Базовые атрибуты РЭЦП

### 6.2.1 <a name="attr21"></a>Атрибут `ContentType`
<!--- 5.7.1; 5.1.1 -->

Подписанный атрибут `ContentType` определяет тип подписанного документа.
Включается в единственном экземпляре. Данный атрибут применяется в РЭЦП формата
CAdES.

### 6.2.2 <a name="attr22"></a>Атрибут `MessageDigest`
<!--- 5.7.2; 5.1.2 -->

Подписанный атрибут `MessageDigest` определяет хэш-значение подписанного
документа. Включается в единственном экземпляре. Данный атрибут применяется в
РЭЦП формата CAdES.

### 6.2.3 <a name="attr23"></a>Атрибут `SigningTime`
<!--- 5.9.1; 5.2.1 -->

Подписанный атрибут `SigningTime` определяет время выработки ЭЦП по утверждению
подписанта. Включается в единственном экземпляре.

### 6.2.4 <a name="attr24"></a>Атрибут `SigningCertificate`
<!--- 5.7.3; 5.2.2 -->

Подписанный атрибут `SigningCertificate` определяет список ссылок на
сертификаты, используемые при проверке подписи. Включается в единственном
экземпляре.

Список ссылок ДОЛЖЕН быть непустым, первая ссылка в списке ДОЛЖНА указывать на
сертификат подписанта. Атрибут предназначен для предотвращения простых атак с
подменой и повторной выдачей сертификата, а также ограничивает набор
сертификатов для проверки подписи. Без этого атрибута подмена недействительного
сертификата подписанта на действительный, выпущенный для того же открытого
ключа, не будет обнаружена. Ссылка однозначно идентифицирует сертификат по
хэш-значению. Хэшируется сертификат, закодированный по отличительным правилам.
Алгоритм хэширования либо подразумевается неявно, либо явно указывается в
ссылке. Для поиска сертификата может использоваться необязательный компонент,
содержащий имя издателя и серийный номер. При несовпадении указанного и
вычисленного хэш-значений, подпись ДОЛЖНА считаться недействительной.

>Примечание — Если атрибутный сертификат используется подписантом для связи его
роли или других атрибутов с подписью, то данные сведения указываются в атрибуте
`SignerAttributes`.

### 6.2.5 <a name="attr25"></a>Атрибут `CommitmentTypeIndication`
<!--- 5.11.1; 5.2.3 -->

Подписанный атрибут `CommitmentTypeIndication` определяет обязательства
подписанта перед проверяющей стороной. Включается в единственном экземпляре.

Тип обязательства может быть определен как часть политики подписи или быть
зарегистрированным определенной службой регистрации, например, торговой
ассоциацией или законодательным органом. В обоих случаях тип обязательства
должен обладает точной семантикой.

Политика подписи определяет набор атрибутов, которые она поддерживает.
Поддерживаемый набор атрибутов включает все типы обязательств, определенных в
политике подписи, а также все внешне заданные типы обязательств, которые
политика может распознавать.

В настоящем стандарте определены следующие общие типы обязательств:

- доказательство происхождения (proof of origin) указывает, что подписант
признает создание, утверждение и отправку сообщения;
- доказательство получения (proof of receipt) указывает, что подписант признает
получение содержимого сообщения;
- доказательство доставки (proof of delivery) указывает, что поставщик услуг
доверия, предоставляющий эту информацию, доставил сообщение в локальное
хранилище, доступное получателю сообщения;
- доказательство отправителя (proof of sender) указывает, что сторона,
предоставляющая эту информацию, отправила сообщение (но необязательно создала
его);
- доказательство утверждения (proof of approval) указывает, что подписант
утвердил содержимое сообщения;
- доказательство создания (proof of creation) указывает, что подписант создал
содержимое сообщения (но необязательно утвердил или отправил его).

### 6.2.6 <a name="attr26"></a>Атрибут `ContentHints`
<!--- 5.10.3; 5.2.4.1 -->

Подписанный атрибут `ContentHints` содержит сведения о наиболее глубоко
вложенном подписанном содержимом многоуровневого документа, в котором одно
содержимое вложено в другое.

Данный атрибут применяется в РЭЦП формата CAdES и НЕ МОЖЕТ быть атрибутом
удостоверяющей подписи.

### 6.2.7 <a name="attr27"></a>Атрибут `MimeType`
<!--- ; 5.2.4.2 -->

Подписанный атрибут `MimeType` содержит MIME-тип подписываемого содержимого. 

Данный атрибут применяется в РЭЦП формата CAdES и НЕ МОЖЕТ быть атрибутом
удостоверяющей подписи.

### 6.2.8 <a name="attr28"></a>Атрибут `DataObjectFormat`
<!--- ; 5.2.4 XAdES -->

Подписанный атрибут `DataObjectFormat` содержит информацию о формате
подписываемого содержимого, такую как описание и идентификатор содержимого,
MIME-тип, метод кодирования.

Данный атрибут применяется в РЭЦП формата XAdES.

### 6.2.9 <a name="attr29"></a>Атрибут `SignerLocation`
<!--- 5.11.2; 5.2.5 -->

Подписанный атрибут `SignerLocation` содержит географический адрес подписанта.
Включается в единственном экземпляре.

### 6.2.10 <a name="attr210"></a>Атрибут `SignerAttributes`
<!--- 5.11.3; 5.2.6.1 -->

Подписанный атрибут `SignerAttributes` содержит дополнительные атрибуты
подписанта (например, роль). Включается в единственном экземпляре. Этот атрибут
МОЖЕТ включать:

- запрашиваемые подписантом атрибуты, в том числе SAML-утверждения, не
подписанные (не удостоверенные) центром атрибутных сертификатов;
- атрибутные сертификаты — атрибуты подписанта, подписанные (удостоверенные)
центром атрибутных сертификатов;
- утверждения, подписанные третьей стороной.

### 6.2.11 <a name="attr211"></a>Атрибут `Countersignature`
<!--- 5.9.2; 5.2.7 -->

Неподписанный атрибут `Countersignature` содержит удостоверяющую подпись. РЭЦП
МОЖЕТ содержать несколько экземпляров данного атрибута. Удостоверяющая подпись
обычно представляет собой РЭЦП, в которой в качестве подписываемых данных
выступает удостоверяемая РЭЦП.

### 6.2.12 <a name="attr212"></a>Атрибут `ContentTimeStamp`
<!--- 5.11.4; 5.2.8 -->

Подписанный атрибут `ContentTimeStamp` содержит штамп времени содержимого
подписываемых данных до их подписания. РЭЦП МОЖЕТ содержать несколько
экземпляров данного атрибута. Данный атрибут применяется в РЭЦП формата CAdES.

### 6.2.13 <a name="attr213"></a>Атрибут `AllDataObjectsTimeStamp`
<!--- ; 5.2.8.1 XAdES -->

Подписанный атрибут `AllDataObjectsTimeStamp` содержит штамп времени
конкатенации всех объектов данных после форматирования. Данный атрибут
применяется в РЭЦП формата XAdES.

### 6.2.14 <a name="attr214"></a>Атрибут `IndividualDataObjectsTimeStamp`
<!--- ; 5.2.8.2 XAdES -->

Подписанный атрибут `IndividualDataObjectsTimeStamp` содержит штамп времени
конкатенации некоторых объектов данных после форматирования. Данный атрибут
применяется в РЭЦП формата XAdES.

### 6.2.15 <a name="attr215"></a>Атрибут `SignaturePolicyIdentifier`
<!--- 5.8.1; 5.2.9 -->

Подписанный атрибут `SignaturePolicyIdentifier` содержит либо явный
идентификатор политики подписи, либо указание о наличии неявной политики
подписи. Указание о наличии неявной политики используется только в формате
XAdES. Включается в единственном экземпляре.

### 6.2.16 <a name="attr216"></a>Атрибут `SignaturePolicyStore`
<!--- ; 5.2.10 -->

Неподписанный атрибут `SignaturePolicyStore` содержит документ, содержащий
политику подписи, идентификатор которого указан в атрибуте
`SignaturePolicyIdentifier`, либо URI, указывающий на локальное хранилище,
содержащее документ с политикой подписи. Включается в единственном экземпляре.

### 6.2.17 <a name="attr217"></a>Атрибут `ContentReference`
<!--- 5.10.1; 5.2.11 -->

Подписанный атрибут `ContentReference` содержит ссылку на другую РЭЦП. Ссылка
может использоваться для связи документа-ответа с документом-запросом.
Включается в единственном экземпляре. Данный атрибут применяется в РЭЦП формата
CAdES.

### 6.2.18 <a name="attr218"></a>Атрибут `ContentIdentifier`
<!--- 5.10.2; 5.2.12 -->

Подписанный атрибут `ContentIdentifier` содержит идентификатор подписанного
содержимого, используемый в качестве метки при ссылке на текущую подпись,
например, в атрибуте `ContentReference`. Включается в единственном экземпляре.
Данный атрибут применяется в РЭЦП формата CAdES.

## 6.3 <a name="attr3"></a>Атрибут штампа времени подписи

### 6.3.1 <a name="attr31"></a>Атрибут `SignatureTimeStamp`
<!--- 6.1; 5.3 -->

Неподписанный атрибут `SignatureTimeStamp` содержит штамп времени, вычисленный
от значения подписи. РЭЦП МОЖЕТ содержать несколько экземпляров данного
атрибута.

Штампы времени ДОЛЖНЫ выставляться до истечения срока действия или отзыва
сертификата подписанта.

## 6.4 <a name="attr4"></a>Атрибуты для указания проверочных данных

<!--- Атрибуты проверки цепочки сертификатов-->

### 6.4.1 <a name="attr41"></a>Атрибут `CompleteCertificateReferences`
<!--- 6.2.1; A.1.1.1 -->

Неподписанный атрибут `CompleteCertificateReferences` содержит набор ссылок на
сертификаты, используемые для проверки подписи:

а) ДОЛЖЕН содержать ссылки на сертификаты цепочки, включая сертификат точки
доверия, промежуточных УЦ и не включая сертификат подписанта.

б) МОЖЕТ содержать ссылки на сертификаты цепочек от точки доверия до конечных
сертификатов, использованных для подписи списков отзыва и OCSP-ответов,
используемых для проверки статуса сертификатов, ссылки на которые указаны в
списке 1.

в) НЕ ДОЛЖЕН включать ссылки на сертификаты, входящие только в цепочки проверки
атрибутных сертификатов или подписанных утверждений.

>Примечание 1 — Ссылка на сертификат подписанта указывается в атрибуте
`SigningCertificate`.

>Примечание 2 — Ссылки на сертификаты, входящие только в цепочки проверки
атрибутных сертификатов или подписанных утверждений, указываются в атрибуте
`AttributeCertificateReferences`.

### 6.4.2 <a name="attr42"></a>Атрибут `CertificateValues`
<!--- 6.3.3; A.1.1.2 -->

Неподписанный атрибут `CertificateValues` содержит сертификаты из перечня,
определенного при описании атрибута `CompleteCertificateReferences`. В список
`CertificateValues` включаются сертификаты, не входящие в стандартные списки
CAdES (компонент `SignedData.certificates`)  или XAdES (внутри элемента
`ds:KeyInfo`). В РЭЦП формата CAdES атрибут `CertificateValues` может также
содержать сертификаты, ссылки на которые указаны в атрибутах
`AttributeCertificateReferences` и `SigningCertificate`.

<!--- Атрибуты проверки отзыва сертификатов-->

### 6.4.3 <a name="attr43"></a>Атрибут `CompleteRevocationReferences`
<!--- 6.2.2; A.1.2.1 -->

Неподписанный атрибут `CompleteRevocationReferences` содержит набор ссылок на
аттестаты отзыва (списки отзыва, OCSP-ответы):

а) ДОЛЖЕН содержать ссылки на аттестаты отзыва сертификатов, ссылки на которые
указаны в атрибуте `CompleteCertificateReferences`, не включая сертификаты точек
доверия и включая сертификат подписанта.

б) МОЖЕТ содержать ссылки на аттестаты отзыва сертификатов, используемых для
подписи элементов отзыва, ссылки на которые указаны в списке 1.

в) НЕ ДОЛЖЕН включать ссылки на аттестаты отзыва сертификатов, входящих только в
цепочки проверки атрибутных сертификатов или подписанных утверждений.

>Примечание 1 — Информация об отзыве сертификатов точек доверия не указывается,
т.к. доверие к ним безусловное.

>Примечание 2 — Ссылки на аттестаты отзыва сертификатов, входящих только в
цепочки проверки атрибутных сертификатов или подписанных утверждений,
указываются в атрибуте `AttributeRevocationReferences`.

### 6.4.4 <a name="attr44"></a>Атрибут `RevocationValues`
<!--- 6.3.4; A.1.2.2 -->

Неподписанный атрибут `RevocationValues` содержит аттестаты отзыва из перечня,
определенного при описании атрибута `CompleteRevocationReferences`. В список
`RevocationValues` включаются аттестаты отзыва, не входящие в стандартные списки
CAdES (компонент `SignedData.crls`) или XAdES (внутри элемента `ds:KeyInfo`). В
РЭЦП формата CAdES атрибут `RevocationValues` может также содержать аттестаты,
ссылки на которые указаны в атрибуте `AttributeRevocationReferences`.

### 6.4.5 <a name="attr45"></a>Атрибут `AttributeCertificateReferences`
<!--- 6.2.3; A.1.3 -->

Неподписанный атрибут `AttributeCertificateReferences` содержит ссылки на
сертификаты, используемые для проверки атрибутных сертификатов и подписанных
утверждений:

а) ДОЛЖЕН содержать ссылки на сертификаты цепочки, включая сертификат точки
доверия, промежуточных УЦ и включая сертификат, использованный для подписи
атрибутного сертификата или утверждения, исключая сертификаты, ссылки на которые
уже содержатся в атрибуте `CompleteCertificateReferences`.

б) МОЖЕТ содержать ссылки на сертификаты цепочек от точки доверия до конечных
сертификатов, не содержащихся в атрибуте `CompleteCertificateReferences` и
использованных для подписи списков отзыва и OCSP-ответов, используемых для
проверки статуса сертификатов, использованных для подписи атрибутных
сертификатов и утверждений.
 
### 6.4.6 <a name="attr46"></a>Атрибут `AttributeCertificateValues`
<!--- ; XAdES 5.4.3 -->

Неподписанный атрибут `AttributeCertificateValues` содержит сертификаты из
перечня, определенного при описании атрибута `AttributeCertificateReferences`.

### 6.4.7 <a name="attr47"></a>Атрибут `AttributeRevocationReferences`
<!--- 6.2.4; A.1.4 -->

Неподписанный атрибут `AttributeRevocationReferences` содержит набор ссылок на
аттестаты отзыва сертификатов, ссылки на которые указаны в списках 1 и 2 при
описании атрибута `AttributeCertificateReferences`, включая ссылки на
сертификаты, содержащиеся в `CompleteCertificateReferences`. Ссылки на аттестаты
отзыва, уже содержащиеся в атрибуте `CompleteRevocationReferences`, НЕ ДОЛЖНЫ
включаться в набор.

### 6.4.8 <a name="attr48"></a>Атрибут `AttributeRevocationValues`
<!--- ; XAdES 5.4.4 -->

Неподписанный атрибут `AttributeRevocationValues` содержит аттестаты отзыва из
перечня, определенного при описании атрибута `AttributeRevocationReferences`.

### 6.4.9 <a name="attr49"></a>Атрибут `RefsOnlyTimeStamp`
<!--- 6.3.6; A.1.5.1 -->

Неподписанный атрибут `RefsOnlyTimeStamp` содержит штамп времени атрибутов,
содержащих ссылки на аттестаты отзыва.

В РЭЦП формата CAdES разрешается ставить штамп времени на атрибуты
`CompleteCertificateReferences` и `CompleteRevocationReferences`. В РЭЦП формата
XAdES разрешается ставить штамп времени также на атрибуты
`AttributeCertificateReferences` и `AttributeRevocationReferences`.

### 6.4.10 <a name="attr410"></a>Атрибут `SigAndRefsTimeStamp`
<!--- 6.3.5; A.1.5.2 -->

Неподписанный атрибут `SigAndRefsTimeStamp` содержит штамп времени, покрывающий
следующие объекты:

- значение подписи,
- штампы времени подписи, указанные в атрибуте `SignatureTimeStamp`,
- атрибуты, содержащие ссылки на аттестаты отзыва и перечисленные при описании
атрибута `RefsOnlyTimeStamp`.

## 6.5 <a name="attr5"></a>Атрибуты архивной проверки

### 6.5.1 <a name="attr51"></a>Атрибут `TimeStampValidationData`
<!--- ; 5.5.2 -->

<!--- CAdES name - ats-hash-index-v2 -->
Неподписанный атрибут `TimeStampValidationData` содержит данные для проверки
штампов времени, такие как сертификаты и аттестаты отзыва либо их хэш-значения.

### 6.5.2 <a name="attr52"></a>Атрибут `ArchiveTimeStamp`
<!--- ; 5.5.3 -->

Неподписанный атрибут `ArchiveTimeStamp` содержит штамп времени документа и
РЭЦП, включая подписанные атрибуты и другие существенные компоненты подписи,
защищенные атрибутом `TimeStampValidationData`.

### 6.5.3 <a name="attr53"></a>Атрибут `RenewedDigests`
<!--- ; XAdES 5.5.3 -->

Неподписанный атрибут `RenewedDigests` содержит хэш-значение от внешних
подписываемых объектов, вычисленное алгоритмом хэширования, отличным от
алгоритма, используемого при указании таких объектов.

Данный атрибут применяется в РЭЦП формата XAdES.

>Примечание — Данный атрибут вычисляется с использованием криптографически
стойких алгоритмов хэширования, когда текущие алгоритмы становятся слабыми.

# 7 <a name="profiles"></a>Профили

## 7.1 <a name="profiles1"></a>Общие положения

В данном разделе определяются 4 базовых профиля: B-B, B-T, B-LT и B-LTA. Профиль
задается набором атрибутов. Атрибут может быть общим, специфичным для формата
CAdES и специфичным для формата XAdES. Требования по управлению специфичными
атрибутами задаются в разделах, посвященных форматам.

При реализации РЭЦП определенного формата необходимо использовать лишь общие
атрибуты и атрибуты, специфичные для выбранного формата. Остальные атрибуты
СЛЕДУЕТ игнорировать.

## 7.2 <a name="profiles2"></a>Профиль B-B

РЭЦП профиля B-B ДОЛЖНА содержать следующие общие атрибуты:

- `SigningTime`;
- `SigningCertificate`.

РЭЦП профиля XAdES-B-B МОЖЕТ содержать следующие атрибуты, специфичные для 
данного формата:
 
- `DataObjectFormat`.

При этом подпись ДОЛЖНА содержать атрибут `DataObjectFormat`, если подпись
покрывает объекты неопределенного в настоящем стандарте формата и НЕ ДОЛЖНА,
если формат каждого подписанного объекта определен (подписана другая подпись или
стандартизированные атрибуты).

РЭЦП класса CAdES-B-B ДОЛЖНА содержать следующие атрибуты, 
специфичные для данного формата:
 
- `ContentType`;
- `MessageDigest`.

РЭЦП профиля B-B МОЖЕТ содержать следующие общие атрибуты:

- `SignerAttributes`;
- `CommitmentTypeIndication`; 
- `SignerLocation`;
- `CounterSignature`;
- `SignaturePolicyIdentifier`;
- `SignaturePolicyStore`.

РЭЦП класса XAdES-B-B МОЖЕТ содержать следующие атрибуты, 
специфичные для данного формата:

- `AllDataObjectsTimeStamp`;
- `IndividualDataObjectsTimeStamp`.

РЭЦП класса CAdES-B-B МОЖЕТ содержать следующие атрибуты, 
специфичные для данного формата:

- `ContentHints`;
- `MimeType`;
- `ContentTimeStamp`;
- `ContentReference`;
- `ContentIdentifier`.

В РЭЦП профиля B-B НЕ РЕКОМЕНДУЕТСЯ включать атрибуты
`SignatureTimeStamp`, `CompleteCertificateReferences`, 
`CertificateValues`, `CompleteRevocationReferences`, `RevocationValues`, 
`AttributeCertificateReferences`, `AttributeCertificateValues`, 
`AttributeRevocationReferences`, `AttributeRevocationValues`, 
`RefsOnlyTimeStamp`, `SigAndRefsTimeStamp`, `TimeStampValidationData`, 
`ArchiveTimeStamp`. 

В РЭЦП класса XAdES-B-B НЕ РЕКОМЕНДУЕТСЯ включать атрибут `RenewedDigests`.

## 7.3 <a name="profiles3"></a>Профиль B-T

Профиль B-T уточняет и расширяет профиль B-B в следующих аспектах.

РЭЦП профиля B-T ДОЛЖНА содержать следующие атрибуты:

- `SignatureTimeStamp`.

Остальные требования остаются прежними.

## 7.4 <a name="profiles4"></a>Профиль B-LT 

Профиль B-LT уточняет и расширяет профиль B-T в следующих аспектах.

РЭЦП класса XAdES-B-LT ДОЛЖНА содержать либо атрибут `TimeStampValidationData`,
либо СОК и информацию об отзыве для штампа времени непосредственно в штампе
времени. РЕКОМЕНДУЕТСЯ помещать СОК и информацию об отзыве для штампа времени в
атрибут `TimeStampValidationData` и включать данный атрибут в подпись.

РЭЦП класса СAdES-B-LT ДОЛЖНА содержать либо атрибут `SignedData.crls.crl`, если
вся информация об отзыве представлена в формате СОС, либо атрибут
`SignedData.crls.other`, если вся информация об отзыве представлена в формате
OCSP-ответов.

РЭЦП профиля B-LT НЕ ДОЛЖНА содержать следующие атрибуты:

- `CompleteCertificateReferences`;
- `AttributeCertificateReferences`;
- `SigAndRefsTimeStamp`;
- `RefsOnlyTimeStamp`.

РЭЦП данного профиля формата CAdES и формата XAdES имеют различные требования к
включению атрибутов `CertificateValues`, `AttributeCertificateValues`,
`RevocationValues` и `AttributeRevocationValues`. Данные атрибуты НЕ ДОЛЖНЫ
включаться в РЭЦП формата CAdES, однако, МОГУТ включаться в РЭЦП формата XAdES
при определенных условиях. Условия указаны в соответствующих данным атрибутам
частях раздела [10](#xades).

Остальные требования остаются прежними.

## 7.5 <a name="profiles5"></a>Профиль B-LTA

Профиль B-LTA уточняет и расширяет профиль B-LT в следующих аспектах.

РЭЦП профиля B-LTA ДОЛЖНА содержать атрибут `ArchiveTimeStamp`.

РЭЦП класса XAdES-B-LTA МОЖЕТ содержать атрибут `RenewedDigests`.

Остальные требования остаются прежними.

<!----Сопоставления CAdES и XAdES:
signing-time = SigningTime
commitment-type-indication = CommitnentTypeIndication
signer-location = SignatureProductionPlace/SignerLocation
signer-attributes-v2 = SignerRole/SignerAttributes
countersignature = Countersignature
signature-policyidentifier = SignaturePolicyIdentifier
signature-policy-store = SignaturePolicyStore
signature-time-stamp = SignatureTimestamp
certificate-values = CertificateValues
revocation-values = RevocationValues
complete-revocationreferences = CompleteRevocationReferences
attribute-certificatereferences = AttributeCertificateRefs
attribute-revocationreferences  = AttributeRevocationReferences 
time-stamped-certs-crlsreferences = RefsOnlyTimeStamp 
(здесь можно еще включать ссылки на атрибутные сертификаты 
и информацию об отзыве атрибутного сертификата)???
-------->

# 8 <a name="processes"></a>Процессы

## 8.1 <a name="processes1"></a>Выработка подписи

### 8.1.1 <a name="processes11"></a>Соглашения

Подпись вырабатывается с помощью средства ЭЦП, аппаратного или программного.
Средство ДОЛЖНО соответствовать требованиям СТБ 34.101.27. В пределах
криптографической границы средства ДОЛЖЕН храниться личный ключ вместе с
соответствующим СОК или однозначной ссылкой на него. Средство ДОЛЖНО
реализовывать сервис выработки подписи. ДОЛЖНА быть предусмотрена возможность
аутентификации подписанта для доступа к сервису.

Со средством ЭЦП взаимодействует программа выработки подписи. Программа передает
средству документ, который требуется подписать, организует взаимодействие между
средством и подписантом. В совокупности средство ЭЦП и программа выработки
подписи составляют СВП.

С СВП, в свою очередь, взаимодействует прикладная программа. Именно здесь
готовится подписываемый документ, формируются атрибуты, аттестаты и прочие
данные, необходимые для выработки РЭЦП. Подготовленные данные передаются
системе. Перечень передаваемых данных определяется политикой выработки подписи.
Политика описывается специальным документом, задается конфигурационными файлами
прикладной программы или жестко фиксируется в ее коде. Политика определяет
формат подписи (CAdES, XAdES или PAdES), задает профиль, определяет размещение
подписи (вложенная, обертывающая или отделенная). Прикладная программа МОЖЕТ
указать СВП подписывать только определенные части документа.

Подписываемый документ МОЖЕТ передаваться СВП напрямую или косвенно — через
хэш-значение. Если документ передается напрямую, то хэш-значение формируется в
самой системе. Перед выработкой хэш-значения документ МОЖЕТ предварительно
подготавливаться (канонизироваться, нормализироваться).

Выработка РЭЦП профилей B-T, B-LT, B-LTA состоит в дополнении РЭЦП предыдущего
профиля. Дополнение МОЖЕТ выполнять не только подписант с помощью СВП, но и
верификатор или любая другая заинтересованная сторона. Для этого вместо СВП
может использоваться специальная программа дополнения подписи.

### 8.1.2 <a name="processes12"></a>Выработка подписи профиля B-B

При выработке РЭЦП профиля B-B входными данными являются:

- подписываемый документ или его хэш-значение;
- СОК подписанта;
- другие атрибуты.

Сертификат и атрибуты передаются прикладной программой, загружаются из
конфигурационных файлов СВП или задаются подписантом. СОК МОЖЕТ загружаться из
средства ЭЦП.

Прикладная программа ДОЛЖНА отобразить документ, который подписывается.
Подписант ДОЛЖЕН иметь возможность просмотреть отображаемый документ и
подписываемые атрибуты. Отображаемый документ (внешнее представление) ДОЛЖЕН
соответствовать подписываемому (внутреннее представление). Отображение документа
МОЖЕТ быть организовано в СВП.

Если подписывается уже подписанный документ, то подписанту ДОЛЖНА быть
предоставлена возможность проверки всех предыдущих подписей. Для этого ДОЛЖНА
использоваться программа проверки подписи, описанная в [8.2](#processes2). Если
программа возвращает вердикт `FAILED` или `INDETERMINATE`, то подписанту ДОЛЖНО
быть выдано предупреждение.

Если политика подписи требует получения согласия на подпись, то оно ДОЛЖНО быть
получено от подписанта прикладной программой или СВП.

После получения входных данных СВП формирует подписываемые атрибуты (в том числе
хэш-значение документа), форматирует их, хэширует. После этого средство ЭЦП
вырабатывает базовую подпись подписываемых атрибутов. Подпись вырабатывается на
личном ключе подписанта. Перед выработкой подписи СВП следует проверить
действительность СОК подписанта. После того, как базовая подпись выработана,
программе выработки подписи СЛЕДУЕТ ее проверить на открытом ключе
соответствующего сертификата.

>Примечание — РЭЦП формата XAdES может содержать несколько атрибутов с 
хэш-значениями отдельных частей одного или даже нескольких документов.

Перед выработкой базовой ЭЦП МОЖЕТ выполняться аутентификация подписанта перед
средством. Аутентификация МОЖЕТ быть организована прикладной программой,
программой выработки подписи или выполнена напрямую.

<!--
Может использоваться несколько факторов аутентификации. 

Странная фраза:

A signer authentication mechanism may be of a form that prevents impersonation 
attacks even from the DA or the SCA and their environment.

DA / SCA не могут выдать себя за средство? за подписанта?
-->

После выработки базовой ЭЦП формируется расширенная. СВП возвращает РЭЦП
прикладной программе, либо сообщает об ошибке.

### 8.1.3 <a name="processes13"></a>Выработка подписи профиля B-T

Выработка РЭЦП профиля B-T состоит в дополнении РЭЦП профиля B-B. Входными
данными при этом являются:

- РЭЦП профиля B-B;
- политика дополнения подписи (опционально).

Сначала выполняется запрос к службе штампов времени. В качестве запроса
выступает базовая ЭЦП. Полученный от службы штамп добавляется к РЭЦП как
неподписанный атрибут. МОЖЕТ использоваться несколько служб и, соответственно,
штампов. Перечень служб задается входной политикой или определяется другим
образом.

Штамп времени является доказательством того, что базовая ЭЦП была выработана к
определенному моменту времени. Другой формой доказательства является рапорт
времени, который фиксируется службой рапортов времени и не добавляется в
подпись. Управление рапортами в настоящем стандарте не рассматривается.

Штамп времени подписи создает основу для долгосрочного действия РЭЦП. Штамп
СЛЕДУЕТ получить до истечения срока действия СОК подписанта, и тогда РЭЦП может
быть проверена даже по окончании действия СОК. РЕКОМЕНДУЕТСЯ получать штамп
сразу после выработки базовой ЭЦП.

Если верификатор или другая заинтересованная сторона не доверяет службе,
выдавшей штамп, то они МОГУТ получить альтернативный штамп у другой службы и
добавить штамп в РЭЦП.

Перед обращением к службе штампов времени входная РЭЦП профиля B-B МОЖЕТ
предварительно проверяться. При отрицательном результате проверки процесс
дополнения подписи ДОЛЖЕН быть прекращен.

### 8.1.4 <a name="processes14"></a>Выработка подписи профиля B-LT

Выработка РЭЦП профиля B-LT состоит в дополнении РЭЦП профиля B-T. Входными
данными при этом являются:

- РЭЦП профиля B-T;
- политика дополнения подписи (опционально).

Сначала проверяется входная подпись. Если проверка дала отрицательный результат,
то дополнение подписи прекращается. В противном случае в РЭЦП добавляются
аттестаты, заданные входной политикой или определенные другим способом.
Аттестаты оформляются как неподписанные атрибуты.

Включение аттестатов в РЭЦП делает ее автономной и позволяет организовать
проверку даже при отсутствии онлайн-доступа к задействованным поставщикам услуг
доверия.

### 8.1.5 <a name="processes15"></a>Выработка подписи профиля B-LTA

Выработка РЭЦП профиля B-LTA состоит в дополнении РЭЦП профиля B-LT или B-LTA.
Входными данными при этом являются:

- РЭЦП профиля B-LT или B-LTA;
- политика дополнения подписи (опционально).

Сначала проверяется входная подпись. Если проверка дала отрицательный результат,
то дополнение подписи прекращается. В противном случае в РЭЦП добавляются все
аттестаты, которые подтверждают состоятельность подписи на данный момент
времени. ДОЛЖНЫ быть добавлены аттестаты, которые касаются предыдущих штампов
времени. Аттестаты добавляются как неподписанные атрибуты.

После добавления аттестатов выполняется запрос к службе штампов времени. Запрос
ДОЛЖЕН покрывать базовую ЭЦП и все неподписанные атрибуты. Полученный от службы
штамп добавляется к РЭЦП как неподписанный атрибут. Может использоваться
несколько служб и, соответственно, штампов. Перечень служб задается входной
политикой или определяется другим образом.

<!--
Не очень понятно про дополнительные аттестаты:

Request one or more time-assertions from appropriate TSAs as defined in the 
signature policy or local configuration. The time-assertion shall cover the 
signer's document as well as all data objects contained in the signature
-->

## 8.2 <a name="processes2"></a>Проверка подписи

### 8.2.1 <a name="processes21"></a>Cоглашения

Для проверки подписи прикладная программа обращается к ППП. ППП получает
подпись, которую требуется проверить, и, в случае отделенной или вложенной
подписи, соответствующий документ или его хэш-значение. Дополнительными входными
данными являются допустимые политики проверки подписи, время проверки,
аттестаты. ППП может получать аттестаты не от прикладной программы, а напрямую
от поставщиков услуг доверия. ППП возвращает вердикт проверки и отчет, который
описывает детали проверки и объясняет вердикт.

Политика проверки подписи определяет политику применения сертификатов,
криптографические ограничения (наборы допустимых криптографических алгоритмов,
их долговременных параметров, длин их ключей), другие аспекты проверки. Политики
описываются специальными документами, задаются конфигурационными файлами
прикладной программы или жестко фиксируются в ее коде. Нужная политика
определяется во время проверки РЭЦП.

Прикладная программа может дополнительно указать профиль подписи, в соответствии
с которым следует организовать проверку. Например, профиль B-B может быть
выбран, если в момент проверки срок действия СОК подписанта не истек (или истек
недавно) и сертификат не был отозван. Если профиль не задан, то ППП выбирает его
сама. ДОЛЖЕН быть выбран максимальный из поддерживаемых профилей, подходящих к
проверяемой РЭЦП.

<!--
the time of validation lies beyond the validity period of the signing 
certificate when the certification authority provides revocation 
information for expired certificates. 

NOTE: Validation of signatures where involved certificates are expired at 
validation time, but not revoked, depends on the signature validation 
policy in use. A policy can e.g. well allow using the Validation Process 
for Basic Signatures for validating a signature that has been created two 
days ago, and the involved certificate expired yesterday.
-->

ППП проводит проверки, определяемые профилем подписи и уточняемые ее политикой.
Окончательный вердикт принимает одно из трех значений:

- `PASSED` (действительная подпись): все проверки прошли успешно и все
  ограничения политики выполнены;
- `FAILED` (недействительная подпись): одна из проверок завершена с ошибкой
  или одно из ограничений политики не выполнено или установлено, что
  подпись выработана после отзыва СОК подписанта;
- `INDETERMINATE` (незавершенная проверка): полученные в ходе проверки
  результаты не позволяют сделать однозначный вывод в пользу `PASSED` или
  `FAILED`.

Вердикт `INDETERMINATE` может быть изменен (как в пользу `PASSED`, так и в
пользу `FAILED`), если ППП будут переданы дополнительные аттестаты (например,
обновленный СОC).

Вердикт `FAILED` уточняется следующими статусами (дополнительными пояснениями):

- `FORMAT_FAILURE` — ошибка формата;
- `HASH_FAILURE` — некорректное хэш-значение;
- `SIG_CRYPTO_FAILURE` — некорректная базовая ЭЦП;
- `REVOKED` — сертификат подписанта отозван к моменту проверки подписи 
  (что подтверждено аттестатом отзыва). 

Вердикт `INDETERMINATE` уточняется следующими статусами: 

- `SIG_CONSTRAINTS_FAILURE` — один из атрибутов РЭЦП не удовлетворяет 
  политике проверки; 
- `CHAIN_CONSTRAINTS_FAILURE` — цепочка сертификатов не удовлетворяет 
  политике применения сертификатов; 
- `CERTIFICATE_CHAIN_GENERAL_FAILURE` — общая ошибка при проверке цепочки 
  сертификатов;
- `CRYPTO_CONSTRAINTS_FAILURE` — нарушены криптографические ограничения, 
  например, криптографические алгоритмы перестали быть надежными;
- `EXPIRED` — подпись выработана после окончания срока 
  действия сертификата подписанта (что подтверждено штампом времени); 
- `NOT_YET_VALID` — подпись выработана до начала срока действия 
  сертификата подписанта (что подтверждено штампом времени);
- `POLICY_PROCESSING_ERROR` — ошибка при обработке политики проверки 
  подписи; 
- `SIGNATURE_POLICY_NOT_AVAILABLE` — недоступна политика проверки 
  подписи;
- `TIMESTAMP_ORDER_FAILURE` — нарушены соглашения об очередности штампов 
  времени; 
- `NO_SIGNING_CERTIFICATE_FOUND` — не найден сертификат подписанта; 
- `NO_CERTIFICATE_CHAIN_FOUND` — не найдена цепочка сертификатов; 
- `REVOKED_NO_POE` — сертификат подписанта отозван, но возможно он 
  действовал в момент выработки подписи; 
- `REVOKED_CA_NO_POE` — сертификат УЦ отозван, но возможно он действовал в 
  момент выработки подписи; 
- `OUT_OF_BOUNDS_NO_POE` — сертификат подписанта прекратил действие, но 
  возможно он действовал в момент выработки подписи;
- `CRYPTO_CONSTRAINTS_FAILURE_NO_POE` — криптографические ограничения не 
  выполнены, но возможно они выполнялись в момент выработки подписи;
- `NO_POE` — отсутствует доказательство существования;
- `TRY_LATER` — выполнены не все условия, но возможно они будут выполнены 
  в будущем;
- `SIGNED_DATA_NOT_FOUND` — не найден подписанный документ;
- `GENERIC` — другое.

Вердикт `PASSED` может представляться статусом `OK`.

Отчет о проверке, который готовит ППП, ДОЛЖЕН содержать следующую информацию:

- вердикт:  `PASSED`, `FAILED` или `INDETERMINATE`;
- использованную политику проверки;
- время проверки;
- использованный профиль.

Отчет МОЖЕТ включать другие данные, например: 

- электронный документ, подпись которого проверена;
- информацию о подписанте;
- атрибуты подписи;
- статус в случае вынесения вердиктов `FAILED` и `INDETERMINATE`;
- при вынесении вердикта `FAILED` причины, по которым подпись 
  признана недействительной;
- при вынесении промежуточного вердикта `INDETERMINATE` шаги, которые
  должны быть выполнены, чтобы определить окончательный вердикт.

### 8.2.2 <a name="processes22"></a>Вспомогательные алгоритмы

#### 8.2.2.1 <a name="processes221"></a>Проверка актуальности аттестата отзыва

Алгоритм проверки актуальности аттестата отзыва получает на вход: 

- аттестат отзыва;
- время проверки;
- политику применения сертификатов.

Алгоритм проверяет, является ли аттестат актуальным в заданный момент времени.
Алгоритм возвращает `PASSED`, если аттестат признан актуальным, и `FAILED` в
противном случае.

**Шаг 1**. По политике применения сертификатов определить интервал обновления
аттестата отзыва входного типа. Если интервал не определен в политике явно, но
аттестат представляет собой СОС или OCSP-ответ, и в этих объектах задано поле
`nextUpdate`, то искомый интервал определить как разницу между `nextUpdate` и
`thisUpdate`. Если интервал определить не удалось, то возвратить `FAILED`.

**Шаг 2**. Если разность между временем проверки и временем выпуска аттестата
больше интервала, определенного на шаге 1, то возвратить `FAILED`. Иначе —
возвратить `PASSED`.

#### 8.2.2.2 <a name="processes222"></a>Проверка сертификата

Алгоритм проверки сертификата получает на вход:

- проверяемый СОК;
- время проверки;
- список точек доверия;
- аттестаты;
- политику применения сертификатов.

Алгоритм проверяет, является ли СОК корректным в заданный момент времени.
Доказательством корректности СОК является корректная цепочка сертификатов,
связывающая этот СОК с некоторой точкой доверия. Алгоритм возвращает максимально
подходящую цепочку и статус ее сертификатов в момент проверки.

**Шаг 1.** По аттестатам построить новую цепочку сертификатов, которая
начинается в некоторой точке доверия и заканчивается проверяемым СОК.

Если новую цепочку построить не удалось, то возвратить последнюю построенную
цепочку и ее статус.

Если ни одной цепочки не построено, то возвратить пустую цепочку и статус
`NO_CERTIFICATE_CHAIN_FOUND`.

**Шаг 2.** Верифицировать построенную цепочку с помощью алгоритма, определенного
в СТБ 34.101.19 (подраздел 8.1). На вход алгоритма подать заданное время
проверки.

При верификации проверяется, что эмитент следующего сертификата является
субъектом предыдущего. Базовая ЭЦП следующего сертификата проверяется на
открытом ключе предыдущего. Кроме этого, проверяется, что все сертификаты
цепочки действительны в заданный момент времени.

Для проверки действительности сертификатов искать среди входных аттестатов
подходящие аттестаты отзыва. Если имеется несколько подходящих аттестатов
относительно некоторого сертификата, то использовать самый последний аттестат.

**Шаг 3.** Обработать результат верификации следующим образом:

а) если верификация завершена успешно, то проверить актуальность выбранных
аттестатов отзыва. Использовать для этого алгоритм [8.2.2.1](#processes221).
Если алгоритм выносит вердикт `FAILED` хотя бы для одного аттестата, то
возвратить цепочку и статус `TRY_LATER`.

б) если верификация завершена с ошибкой из-за того, что промежуточный сертификат
(сертификат УЦ) был отозван к моменту проверки, то зафиксировать цепочку со
статусом `REVOKED_CA_NO_POE` и вернуться к шагу 1.

в) если верификация завершена с ошибкой из-за того, что последний (проверяемый)
сертификат был отозван к моменту проверки, то возвратить цепочку со статусом
`REVOKED_NO_POE`.

г) если верификация завершена с ошибкой из-за того, что последний сертификат был
приостановлен в момент проверки, то возвратить цепочку со статусом `TRY_LATER`.

д) если верификация завершена с ошибкой из-за того, что последний сертификат не
действовал в момент проверки, то возвратить цепочку со статусом
`OUT_OF_BOUNDS_NO_POE`.

При других ошибках верификации зафиксировать цепочку со статусом
`CERTIFICATE_CHAIN_GENERAL_FAILURE` и вернуться к шагу 1.

<!--
todo: разобраться, в СТБ 34.101.19 только первая модель

>Примечание — Могут использоваться две модели верификации:
- все сертификаты цепочки, кроме последнего, 
  действительны в указанное время проверки;
- каждый из сертификатов, кроме последнего, 
  был действителен в момент, когда он использовался для выпуска 
  следующего сертификата. 
>Модель определяется политикой проверки.
-->

**Шаг 4.** Для каждого сертификата цепочки проверить выполнение ограничений
политики применения сертификатов. Если ограничения не выполнены, то
зафиксировать цепочку со статусом `CHAIN_CONSTRAINTS_FAILURE` и вернуться к 
шагу 1.

**Шаг 5.** Для каждого сертификата цепочки проверить выполнение 
криптографических ограничений. Если ограничения не выполнены, то
зафиксировать цепочку со статусом `CRYPTO_CONSTRAINTS_FAILURE_NO_POE` и 
вернуться к шагу 1.

**Шаг 6.** Возвратить цепочку со статусом `OK`.

#### 8.2.2.3 <a name="processes223"></a>Проверка штампа времени

Алгоритм проверки штампа времени получает на вход:

- штамп времени;
- хэш-значение данных, для которых выпущен штамп;
- список политик проверки подписи (опционально);
- сертификат службы штампов времени (опционально);
- список точек доверия (опционально).

Алгоритм проверяет корректность штампа времени как электронного документа
формата CAdES. Содержимое документа описывается типом `TSTInfo`, определенным в
СТБ 34.101.82. Компонент `messageImprint` этого типа описывает хэш-значение
данных, для которых выпущен штамп, компонент `genTime ` — время выпуска.
Алгоритм возвращает вердикт проверки. Успешный вердикт сопровождается
извлеченным из штампа временем выпуска, неуспешный — статусом.

**Шаг 1.** Проверить подпись штампа как РЭЦП профиля B-B. Использовать алгоритм
[8.2.3](#processes23). Переадресовать алгоритму собственные входные данные, в
том числе сертификат службы штампов времени в качестве сертификата подписанта.

**Шаг 2.** Если алгоритм [8.2.3](#processes23) завершен с вердиктом `FAILED` или
`INDETERMINATE`, то возвратить этот вердикт вместе с соответствующим статусом.

**Шаг 3.** Проверить, что вложенная в штамп структура типа `TSTInfo`
соответствует ограничениям СТБ 34.101.82. Если ограничения нарушены, то
возвратить `FAILED` со статусом `FORMAT_FAILURE`.

**Шаг 4.** Извлечь из `TSTInfo` хэш-значение данных, для которых выпущен штамп,
и время выпуска. Сравнить извлеченное хэш-значение с входным. В случае
несовпадения возвратить `FAILED` со статусом `HASH_FAILURE`.

**Шаг 5.** Возвратить вердикт `PASSED` и время выпуска.

#### 8.2.2.4 <a name="processes224"></a>Сдвиг времени проверки

Алгоритм сдвига времени проверки получает на вход:

- цепочку сертификатов;
- список доказательств существования;
- аттестаты;
- политику применения сертификатов;
- криптографические ограничения.

Алгоритм определяет самый поздний момент времени, в который последний сертификат
входной цепочки будет признан действительным, в том числе тот, в который цепочка
будет успешно верифицирована. Искомый момент определяется многократными сдвигами
в прошлое текущего момента. Сдвиг выполняется при обработке отзывов сертификатов
цепочки, при нарушении криптографических ограничений, и при потере актуальности
аттестатов отзыва. Алгоритм возвращает `OK` и искомый момент времени. Если
момент определить не удалось, то алгоритм возвращает `NO_POE`.

**Шаг 1.** Инициализировать переменную `control-time` текущим моментом времени.

**Шаг 2.** Для каждого сертификата цепочки, начиная с первого (выданного точкой
доверия), выполнить следующие действия.

а) найти корректные аттестаты отзыва, касающиеся текущего сертификата, которые
выпущены ранее `control-time` и для которых имеется доказательство существования
к моменту `control-time`. Возвратить `NO_POE`, если не найдено ни одного
подходящего аттестата.

<!--
todo: в оригинале требуется док-во (одно?) и аттестата, и сертификата.
Но ведь если существует аттестат на сертификат, то существует и аттестат.
-->

б) обработать каждый из найденных аттестатов: 

- если аттестат определяет отзыв сертификата, то изменить `control-time` 
  на время отзыва;
- если аттестат не определяет отзыв сертификата, то проверить актуальность
  аттестата с помощью алгоритма [8.2.2.1](#Processes221p) на момент 
  `control-time`. Если алгоритм возвращает `FAILED`, то изменить 
  `control-time` на время выпуска аттестата;
- проверить, что сертификат и аттестат удовлетворяют криптографическим 
  ограничениям на момент `control-time`. Если ограничения не выполняются, то 
  изменить `control-time` на самое позднее время, когда они еще выполнялись. 

<!--
todo: control-time обновляется итерационно. Могут появиться противоречия.
Например, время отзыва м.б. позже `control-time`.
-->

**Шаг 3.** Возвратить `OK` и `control-time`.

#### 8.2.2.5 <a name="processes225"></a>Проверка сертификата в прошлом

Алгоритм проверки сертификата в прошлом получает на вход:

- РЭЦП (возможно штамп времени);
- проверяемый сертификат;
- список точек доверия;
- список доказательств существования;
- аттестаты;
- политику применения сертификатов;
- криптографические ограничения.

Алгоритм проверяет, являлся ли СОК корректным в некоторый момент времени в
прошлом. Доказательством корректности СОК является корректная цепочка
сертификатов, связывающая этот СОК с некоторой точкой доверия. Если цепочку
найти удалось, то она возвращается со статусом `OK` и максимально поздним
моментом времени, в который она еще была корректна. Если подходящую цепочку
найти не удалось, то возвращаются максимально подходящая цепочка и ее статус.

<!--
todo: нужно ли возвращать цепочку?
-->

<!--
todo: переработать или убрать

Суть алгоритма состоит в следующем. Цепочка является корректной, если 
для каждого ее сертификата либо имеется аттестат отзыва о корректности в настоящем,
либо имеется устаревший аттестат, который подтверждает существование сертификата
в момент в прошлом, когда эмитент сертификата был надежен. 
-->

**Шаг 1.** По аттестатам построить новую цепочку сертификатов, которая
начинается в некоторой точке доверия и заканчивается проверяемым СОК.

Если новую цепочку построить не удалось, то возвратить последнюю построенную
цепочку и ее статус.

Если ни одной цепочки не построено, то возвратить пустую цепочку и статус
`NO_CERTIFICATE_CHAIN_FOUND`.

**Шаг 2.** Верифицировать построенную цепочку с помощью алгоритма, определенного
в СТБ 34.101.19 (подраздел 8.1). На вход алгоритма подать любую отметку времени
из области пересечения сроков действия сертификатов цепочки. Если область
пересечения пуста, то зафиксировать цепочку со статусом
`CERTIFICATE_CHAIN_GENERAL_FAILURE` и вернуться к шагу 1.

При верификации проверяется, что эмитент следующего сертификата является
субъектом предыдущего. Базовая ЭЦП следующего сертификата проверяется на
открытом ключе предыдущего. Действительность сертификатов в выбранный момент
времени не проверять.

При ошибках верификации зафиксировать цепочку со статусом 
`CERTIFICATE_CHAIN_GENERAL_FAILURE` и вернуться к шагу 1. 

**Шаг 3.** Применить алгоритм [8.2.2.4](#processes224). Если алгоритм возвращает
статус, отличный от `OK`, то назначить этот статус цепочке и вернуться к шагу 1.
Если алгоритм возвращает статус `OK`, то зафиксировать дополнительный возврат —
самый поздний момент времени, когда все сертификаты цепочки признаются
действительными.

**Шаг 4.** Проверить, что цепочка удовлетворяет ограничениям политики применения
сертификатов. Если ограничения нарушены, то зафиксировать цепочку со статусом
`CHAIN_CONSTRAINTS_FAILURE` и вернуться к шагу 1.

**Шаг 5.** Возвратить цепочку со статусом `OK` и моментом времени,
зафиксированным на шаге 3.

#### 8.2.2.6 <a name="processes226"></a>Извлечение доказательств существования

Алгоритм извлечения доказательств существования получает на вход: 

- РЭЦП;
- штамп времени;
- список доказательств существования (возможно пустой).

Алгоритм, используя штамп времени, строит список доказательств существования 
объектов, входящих в РЭЦП. Список может быть пустым.

**Шаг 1.** Построить множество *S* объектов или ссылок на объекты, которые
входят в РЭЦП и контролируются штампом времени. Зафиксировать время *T* выпуска
штампа.

**Шаг 2.** Если некоторые объекты *S* содержат вложенные объекты, которые могут
использоваться при проверке подписи, то добавить эти объекты в *S*.

**Шаг 3.** Инициализировать пустой список *P* доказательств существования.

**Шаг 4.** Проанализировать ссылки на объекты, входящие в *S*. Если ссылка
на объект *O* представляет собой хэш-значение *h(O)* и функция хэширования
*h* удовлетворяла криптографическим ограничениям вплоть до момента *T*, то:

- добавить в *P* ссылку *h(O)*;
- если входной список доказательств существования содержит 
  доказательство для объекта *O* на момент времени после *T*, 
  то добавить в *P* доказательство существования *O* на момент *T*.

**Шаг 5.** Для каждого объекта *O* из *S* добавить в *P* доказательство 
существования *O* в момент *T*. 

**Шаг 6.** Возвратить *P*. 

#### 8.2.2.7 <a name="processes227"></a>Повторная проверка подписи

Алгоритм повторной проверки подписи получает на вход:

- РЭЦП;
- вердикт/статус предыдущей проверки;
- СОК подписанта;
- список точек доверия;
- список доказательств существования;
- аттестаты (опционально);
- политику применения сертификатов (опционально);
- криптографические ограничения (опционально). 

Алгоритм применяется после завершенной проверки, которая вынесла неопределенный
вердикт `INDETERMINATE`. Дополнительные доказательства существования могут
изменить вердикт, сделав его определенным. Алгоритм либо повторяет предыдущие
вердикт и статус, либо меняет его на `PASSED`, `FAILED` или `INDETERMINATE` со
статусом `NOT_YET_VALID`.

**Шаг 1.** Выполнить алгоритм [8.2.2.5](#processes225), переадресовав ему
необходимые входные данные. Если алгоритм возвращает статус `OK`, то
зафиксировать дополнительно возвращаемое время. В противном случае возвратить
входные вердикт и статус.

**Шаг 2.** Если имеется доказательство существования базовой подписи к моменту
времени, зафиксированному на шаге 1, то разобрать входной статус следующим
образом:

а) при статусе `REVOKED_NO_POE` возвратить вердикт `PASSED`;

б) при статусе `REVOKED_CA_NO_POE` искать доказательство существования аттестата
отзыва сертификата УЦ, приведшего к назначению вердикта. Если доказано
существование на момент времени, не позже зафиксированного на шаге 2, то
возвратить `PASSED`. Иначе — возвратить `INDETERMINATE` и статус
`REVOKED_CA_NO_POE`;

в) при статусе `OUT_OF_BOUNDS_NO_POE` определить `best-signature-time` — самое
раннее время в доказательствах существования базовой подписи. Если
`best-signature-time` раньше даты выпуска сертификата подписанта, то возвратить
`INDETERMINATE` со статусом `NOT_YET_VALID`. Если `best-signature-time` позже
даты выпуска сертификата подписанта, то возвратить `PASSED`.

**Шаг 3.** Если входной статус есть `CRYPTO_CONSTRAINTS_FAILURE_NO_POE`, то
проанализировать криптографические ограничения, приведшие к вынесению вердикта.
Если имеется доказательство того, что алгоритмы, покрытые ограничениями,
применялись до ввода ограничений, то возвратить `PASSED`.

**Шаг 4.** Возвратить вердикт и статус, полученные на шаге 1.

### 8.2.3 <a name="processes23"></a>Проверка подписи профиля B-B

При проверке подписи профиля B-B входными данными являются:

- РЭЦП профиля B-B;
- подписанный документ или его хэш-значение (опционально);
- список политик проверки подписи (опционально);
- СОК подписанта (опционально);
- время проверки (опционально);
- список точек доверия (опционально);
- другие аттестаты (опционально). 

Проверка подписи состоит из следующих шагов.

**Шаг 1 (проверка формата).** 
Проверить, что РЭЦП соответствует допустимому формату (CAdES, XAdES или PAdES).
Если формат нарушен, то возвратить `FAILED` со статусом `FORMAT_FAILURE`.

**Шаг 2 (идентификация COK подписанта).** 
Найти СОК подписанта, используя ссылки в атрибутах РЭЦП (например, в атрибуте
`SigningCertificate`). Если подходящий сертификат не найден, то возвратить
`INDETERMINATE` со статусом `NO_SIGNING_CERTIFICATE_FOUND`.

<!--
todo: Первую ссылку? В документе etsi идет речь о первой подходящей ссылке.
-->

Искомый сертификат может содержаться в РЭЦП (например, в атрибуте
`CertificateValues`), передаваться как входной параметр прикладной программой
или размещаться по доступному ППП адресу. Хэш-значение проверяемого сертификата
ДОЛЖНО сравниваться с хэш-значением, указанным в ссылке. Если в ссылке указаны
имя эмитента и серийный номер сертификата, то эти данные также ДОЛЖНЫ
проверяться.

**Шаг 3 (инициализация контекста).** 
Определить следующие данные, необходимые для проверки подписи:

- политику применения сертификатов;
- аттестаты;
- криптографические ограничения.

Если нужные данные не найдены или при их определении произошла ошибка,
то возвратить `INDETERMINATE` со статусами `SIGNATURE_POLICY_NOT_AVAILABLE`
и `POLICY_PROCESSING_ERROR` соответственно.

При поиске нужных данных сначала определяется политика проверки подписи.
Политика задается идентификатором, который содержится в атрибуте
`SignaturePolicyIdentifier` РЭЦП. Затем по идентификатору политики определяется
документ, который описывает политику и, в том числе, искомые выходные данные.
Искомый документ может быть размещен в атрибуте `SignaturePolicyStore` РЭЦП.

Если в атрибуте `SignaturePolicyIdentifier` указано хэш-значение документа с
описанием политики, то это хэш-значение ДОЛЖНО сравниваться с фактическим.

Если атрибут `SignaturePolicyIdentifier` не содержится в РЭЦП, то используется
политика по умолчанию. Если политики по умолчанию нет, то используется неявная
политика, которая, как правило, задает минимальные ограничения или определяется
предопределенными соглашениями.

Если прикладная программа задает список допустимых политик, то ДОЛЖНО быть
проверено, что выбранная политика содержится в этом списке. В противном случае,
в зависимости от настроек ППП, проверка либо прекращается с возвратом
`INDETERMINATE`, либо продолжается с выбранной политикой.

**Шаг 4 (проверка СОК подписанта).**
Выполнить алгоритм проверки сертификата, определенный в
[8.2.2.2](#processes222). Передать алгоритму входные данные и данные, полученные
на шаге 3. Если время проверки не задано, то передать текущее время.

Если алгоритм возвращает статус, отличный от `OK`, `TRY_LATER`,
`REVOKED_NO_POE`, `REVOKED_CA_NO_POE`, `OUT_OF_BOUNDS_NO_POE` и
`CRYPTO_CONSTRAINTS_FAILURE_NO_POE`, то завершить проверку подписи с вердиктом
`INDETERMINATE` и полученным статусом. В противном случае зафиксировать
возвращенные алгоритмом цепочку сертификатов и статус.

**Шаг 5 (проверка базовой подписи).**
Проверить базовую ЭЦП на открытом ключе из сертификата подписанта:

а) использовать хэш-значение подписанного документа, либо вычислить хэш-значение
самостоятельно. Если ни хэш-значение, ни документ не переданы на вход, то
возвратить `INDETERMINATE` и статус `SIGNED_DATA_NOT_FOUND`;

б) определить подписанный атрибут РЭЦП, в котором указано хэш-значение 
подписанного документа. Сравнить хэш-значение в атрибуте с хэш-значением, 
полученным на подшаге a). Если атрибут с хэш-значением не найден или 
хэш-значения отличаются, то возвратить `FAILED` и статус `HASH_FAILURE`;

>Примечание — При обработке РЭЦП формата XAdES проверяется каждый подписанный 
атрибут с хэш-значением документа или его части.

в) извлечь из СОК подписанта открытый ключ и долговременные параметры,
скомпоновать и хэшировать подписанные атрибуты, извлечь из РЭЦП базовую подпись,
передать полученные данные в алгоритм проверки подписи. При отрицательном
результате проверки возвратить `FAILED` и статус `SIG_CRYPTO_FAILURE`. Если
долговременные параметры представлены в сертификате через ссылку на параметры
УЦ, то параметры ДОЛЖНЫ быть восстановлены по цепочке, построенной на шаге 4.

**Шаг 6 (обработка статуса цепочки сертификатов).**
Обработать статус цепочки сертификатов, построенной на шаге 4, следующим
образом:

а) цепочка имеет статус `REVOKED_NO_POE`, если представлен аттестат отзыва
некоторого ее сертификата. При обработке данного статуса проверить наличие в
РЭЦП штампов времени в виде подписанных атрибутов (например,
`ContentTimeStamp`). Если имеется корректный штамп, выпущенный позже аттестата
отзыва (другими словами, подпись выработана после отзыва сертификата), то
закончить проверку с возвратом `FAILED` и статусом `REVOKED`. Если подходящий
штамп не обнаружен, то возвратить `INDETERMINATE` и статус `REVOKED_NO_POE`. Для
проверки штампа использовать алгоритм [8.2.2.3](#processes223);

б) цепочка имеет статус `OUT_OF_BOUNDS_NO_POE`, если в заданный момент проверки
один из ее сертификатов не был действительным. При обработке данного статуса
проверить наличие в РЭЦП штампов времени в виде подписанных атрибутов. Если
имеется действительный штамп, выпущенный позже окончания действия сертификата,
то возвратить `INDETERMINATE` и статус `EXPIRED`. В противном случае возвратить
`INDETERMINATE` и статус `OUT_OF_BOUNDS_NO_POE`. Для проверки штампа
использовать алгоритм [8.2.2.3](#processes223);

в) во всех остальных случаях когда статус цепочки отличен от `OK`,
возвратить `INDETERMINATE` и этот статус.

**Шаг 7 (проверка дополнительных ограничений).**
Проверить, что РЭЦП удовлетворяет ограничениям на атрибуты и криптографическим
ограничениям:

а) проверить каждый атрибут, который должен присутствовать в РЭЦП в соответствии
с ограничениями, построенными на шаге 3. Если атрибут присутствует, но имеет
неверный формат, то он считается отсутствующим. Для атрибута проверяются
ограничения, заданные в его описании (см. [6](attrs)). При нарушении
ограничений возвратить `INDETERMINATE` и статус `SIG_CONSTRAINTS_FAILURE`.

Контрподпись проверяется как РЭЦП. При проверке учитываются ограничения, 
построенные на шаге 3. Дополнительно проверяется, что подписанные данные 
контрподписи — это базовая подпись основной РЭЦП. При ошибках во время проверки 
возвращается `INDETERMINATE` и статус `SIG_CONSTRAINTS_FAILURE`.

Контрподпись проверяется как самостоятельная РЭЦП. В частности, время проверки 
основной РЭЦП (опциональный входной параметр) не должно учитываться при 
проверке контрподписи. Однако если имеются ограничения относительно времени 
выработки контрподписи (например о том, что контрподпись должна вырабатываться 
в течение определенного срока после выработки основной РЭЦП), то они должны 
учитываться.

Если ограничения, построенные на шаге 3, не касаются контрподписей, то 
контрподписи могут не проверяться. Если контроподпись все-таки проверяется и 
проверка завершается с ошибкой, то эта ошибка может игнорироваться и, таким 
образом, не влиять на результат проверки основной РЭЦП;

б) проверить, что все криптографические алгоритмы, использованные в РЭЦП (в том
числе в атрибутах и аттестатах), сохраняют стойкость в момент проверки.
Учитывать не только перечень алгоритмов, но и их настройки: долговременные
параметры, длины ключей.

Если криптографические ограничения не выполнены, то проверить наличие в РЭЦП
штампов времени в виде подписанных атрибутов. Если имеется действительный штамп,
выпущенный в момент, когда криптографические ограничения уже были введены, то
закончить проверку с возвратом `INDETERMINATE` и статусом
`CRYPTO_CONSTRAINTS_FAILURE`. Если подходящий штамп не обнаружен, то возвратить
`INDETERMINATE` и статус `CRYPTO_CONSTRAINTS_FAILURE_NO_POE`. Для проверки
штампа использовать алгоритм [8.2.2.3](#processes223).

**Шаг 8.** Возвратить `PASSED` вместе с цепочкой сертификатов, полученной на
шаге 4.

<!-- нужна ли выходная цепочка? -->

### 8.2.4 <a name="processes24"></a>Проверка подписи профилей B-T и B-LT

При проверке подписи профилей B-T и B-LT входными данными являются:

- РЭЦП профиля B-T или B-LT;
- подписанный документ или его хэш-значение (опционально);
- список допустимых политик проверки подписи (опционально);
- СОК подписанта (опционально);
- время проверки (опционально);
- список точек доверия (опционально);
- другие аттестаты (опционально);
- предполагаемое время выработки подписи (опционально).

Предполагаемое время выработки подписи определяется прикладной программой.
Это момент времени, к которому подпись предположительно уже была
выработана. Прикладная программа МОЖЕТ определить предполагаемое время по
атрибуту `SigningTime`.

При успешной проверке вердикт `PASSED` сопровождается дополнительной
информацией — самым ранним моментом времени, к которому подпись была
выработана согласно штампам времени. Этот момент фиксируется в переменной
`best-signature-time`.

Проверка подписи состоит из следующих шагов.

**Шаг 1 (список штампов времени).** 
Составить список штампов времени, представленных в РЭЦП в виде
неподписанных атрибутов (например, `SignatureTimeStamp`).

Инициализировать переменную `best-signature-time` предполагаемым временем 
выработки подписи. 

**Шаг 2 (проверка подписи профиля B-B).** 
Проверить РЭЦП как подпись профиля B-B. Использовать алгоритм
[8.2.3](#processes23). Переадресовать алгоритму собственные входные данные.
Перейти на следующий шаг, если алгоритм возвратил вердикт `PASSED` или вердикт
`INDETERMINATE` с одним из следующих статусов:
`CRYPTO_CONSTRAINTS_FAILURE_NO_POE`, `REVOKED_NO_POE`, `REVOKED_CA_NO_POE`, 
`TRY_LATER` или `OUT_OF_BOUNDS_NO_POE`. Иначе — завершить проверку, возвратив 
вердикт и статус алгоритма [8.2.3](#processes23). 

**Шаг 3 (проверка штампов времени).**
Для каждого штампа времени из списка, составленного на шаге 1, выполнить
следующие действия:

а) проверить, что указанное в штампе хэш-значение соответствует хэш-значению
подписанных атрибутов РЭЦП. В случае несоответствия исключить штамп из списка и
перейти к следующему штампу;

б) проверить штамп с помощью алгоритма [8.2.2.3](#processes223). Если алгоритм
возвращает `PASSED`, то зафиксировать отметку времени, указанную в штампе (время
выпуска). В противном случае, в зависимости от политики проверки подписи, либо
просто исключить штамп из списка и перейти к следующему штампу, либо завершить
проверку подписи. В случае завершения вердикт и статус определяются политикой;

в) если отметка времени в штампе меньше `best-signature-time`, то записать
отметку в `best-signature-time`.

**Шаг 4 (сравнение отметок времени).** 
Выполнить следующие действия:

а) если на шаге 2 получен вердикт `INDETERMINATE` со статусом `REVOKED_NO_POE`
или `REVOKED_CA_NO_POE`, то обработать аттестаты отзыва, которые привели к
вынесению вердикта. Если аттестаты выпущены позже `best-signature-time`, то
перейти к подшагу г). Иначе – закончить проверку с полученными на шаге 2
вердиктом и статусом;

б) если вердикт получен со статусом `OUT_OF_BOUNDS_NO_POE`, то обработать
сертификаты, которые привели к вынесению вердикта. Если сертификаты начали
действовать ранее `best-signature-time`, то закончить проверку с полученными на
шаге 2 вердиктом и статусом. Иначе — возвратить `FAILED` и статус
`NOT_YET_VALID`;

в) если вердикт получен со статусом `CRYPTO_CONSTRAINTS_FAILURE_NO_POE`, то
обработать криптографические ограничения, которые привели к вынесению вердикта.
Если ограничения вступили в действие позже `best-signature-time`, то перейти к
подшагу г). Иначе — закончить проверку с полученными на шаге 2 вердиктом и
статусом;

г) проверить, что штампы списка, составленного на шаге 1 и уточненного на шаге
3, непротиворечивы. Во-первых, штампы ДОЛЖНЫ быть выпущены позже штампов в виде
подписанных атрибутов (например, `ContentTimeStamp`). Во-вторых, если иное не
оговорено политикой проверки, ДОЛЖНЫ выполняться ограничения СТБ 34.101.82
относительно полей `accuracy` и `ordering` компонентов `TSTInfo` штампов,
выпущенных одной или несколькими службами. В случае обнаружения противоречий
закончить проверку с вердиктом  `INDETERMINATE` и статусом
`TIMESTAMP_ORDER_FAILURE`.

<!--
todo: связать с СТБ 34.101.82

For each time-stamp token remaining in the set of signature time-stamp
tokens, the process shall check the coherence in the values of the times
indicated in the time-stamp tokens. They shall be posterior to the times
indicated in any time-stamp token computed on the signed data
(content-time-stamp). The process shall apply the rules specified in IETF
RFC 3161 [3], clause 2.4.2 regarding the order of time-stamp tokens
generated by the same or different TSAs given the accuracy and ordering
fields' values of the TSTInfo field, unless stated differently by the
signature validation constraints. If all the checks end successfully, the
process shall go to the next step. Otherwise the process shall return the
indication INDETERMINATE with the sub-indication TIMESTAMP_ORDER_FAILURE.
-->

**Шаг 5 (контроль задержек).**
Если список, составленный на шаге 1 и уточненный на шаге 3 непуст, и политика
ограничивает задержку штампов времени, то проверить выполнение следующих
условий:

а) в РЭЦП присутствует атрибут `SigningTime`;

б) время, указанное в атрибуте `SigningTime`, увеличенное на задержку, указанную
в политике, больше чем `best-signature-time`.

Если условия не выполнены, то закончить проверку с вердиктом `INDETERMINATE` и
статусом `SIG_CONSTRAINTS_FAILURE`.

<!--
todo: странно, что штампы времени могут отсутствовать

В оригинале:
if the signature contains a signature time-stamp token and the validation 
constrains specify a time-stamp delay ...
-->

**Шаг 6 (проверка обновления).**
Если на шаге 2 получен вердикт `INDETERMINATE` со статусом `TRY_LATER`, то
проверить актуальность аттестатов отзыва, приведших к вынесению вердикта. Для
этого выполнить алгоритм [8.2.2.1](#processes221), использовав
`best-signature-time` в качестве времени проверки. Если алгоритм возвращает
`TRY_LATER`, то закончить проверку с вердиктом `INDETERMINATE` и статусом
`TRY_LATER`.

**Шаг 7 (проверка дополнительных ограничений).**
Повторить шаг 7 алгоритма [8.2.3](#processes23) проверки подписи профиля B-B,
использовав `best-signature-time` в качестве времени проверки.

**Шаг 8.** Возвратить `PASSED` вместе с цепочкой сертификатов, полученной
на шаге 2, и `best-signature-time`.

<!-- нужна ли выходная цепочка? -->

### 8.2.5 <a name="processes25"></a>Проверка подписи профиля B-LTA

При проверке подписи профиля B-LTA входными данными являются:

- РЭЦП профиля B-LTA;
- подписанный документ или его хэш-значение (опционально);
- список допустимых политик проверки подписи (опционально);
- СОК подписанта (опционально);
- время проверки (опционально);
- список точек доверия (опционально);
- другие аттестаты (опционально);
- список доказательств существования (опционально).

<!--
todo: Дополнительный вход - evidence records
Пока его игнорируем. Иначе нужно вводить rfc4998, rfc6283
-->

Проверка подписи состоит из следующих шагов.

**Шаг 1 (сбор доказательств существования).** 
Включить в список доказательств существования все объекты РЭЦП. 
Зафиксировать их существование на текущий момент времени.

**Шаг 2 (проверка подписи профиля B-T/B-LT).** 
Проверить РЭЦП как подпись профиля B-T/B-LT. Использовать алгоритм
[8.2.4](#processes24), переадресовав ему собственные входные данные.

Обработать результат работы алгоритма следующим образом:

а) искать в РЭЦП архивные атрибуты, специфичные для профиля B-LTA
((например, атрибут `ArchiveTimeStamp` с архивным штампом времени).
Если РЭЦП не содержит архивных атрибутов, то возвратить вердикт и статус 
алгоритма [8.2.4](#processes24); 

б) если алгоритм [8.2.4](#processes24) возвратил `PASSED` и политика проверки 
подписи не требует проверки архивных атрибутов, то возвратить `PASSED`.
Если проверка архивных атрибутов все-таки нужна, то перейти на шаг 3;

в) Если алгоритм [8.2.4](#processes24) возвратил `INDETERMINATE` с одним из
статусов `REVOKED_NO_POE`, `REVOKED_CA_NO_POE`, `OUT_OF_BOUNDS_NO_POE` или
`CRYPTO_CONSTRAINTS_FAILURE_NO_POE`, то перейти на шаг 3;

г) Возвратить вердикт и статус алгоритма [8.2.4](#processes24).

**Шаг 3 (доказательство для подписи).**
Добавить подпись в список доказательств существования. Зафиксировать ее
существование в момент времени `best-signature-time`, который является
дополнительным выходом алгоритма [8.2.4](#processes24), выполненного на шаге 2.

<!--
todo: разобраться, для базовой подписи или просто для подписи
-->

**Шаг 4 (обработка штампов времени).**
Обработать штампы времени, от выпущенных раньше к выпущенным позже. 
Для каждого штампа выполнить следующие действия:

а) проверить штамп с помощью алгоритма [8.2.2.3](#processes223);

б) если алгоритм [8.2.2.3](#processes223) возвращает `PASSED` и функция
хэширования, использованная в штампе, удовлетворяет криптографическим
ограничениям на момент выпуска штампа, то извлечь из штампа доказательства
существования. Использовать алгоритм [8.2.2.6](#processes226). Передать на вход
алгоритма текущий список доказательств. Возвращенный алгоритмом список добавить
к текущему;

в) если алгоритм [8.2.2.3](#processes223) возвращает вердикт `INDETERMINATE` с
одним из статусов `REVOKED_NO_POE`, `REVOKED_CA_NO_POE`, `OUT_OF_BOUNDS_NO_POE`
или `CRYPTO_CONSTRAINTS_FAILURE_NO_POE`, то выполнить алгоритм
[8.2.2.7](#processes227) повторной проверки подписи. Подать на вход алгоритма
следующие данные:

- штамп времени, 
- вердикт и статус, полученные на подшаге а), 
- сертификат службы штампов времени,
- список точек доверия, 
- текущий список доказательств существования, 
- аттестаты, 
- политику применения сертификатов, 
- криптографические ограничения.

Если алгоритм [8.2.2.7](#processes227) возвращает `PASSED` и функция
хэширования, использованная в штампе, удовлетворяет криптографическим
ограничениям на момент выпуска штампа, то извлечь из штампа доказательства
существования. Использовать алгоритм [8.2.2.6](#processes226). Подать на вход
алгоритма текущий список доказательств. Возвращенный алгоритмом список добавить
к текущему;

г) в остальных случаях, если противное не оговорено политикой проверки подписи,
игнорировать штамп времени. Однако если политика требует проверки корректности
штампов времени, то возвратить вердикт и статус, определяемые политикой.

**Шаг 5 (повторная проверка подписи).**
Выполнить алгоритм [8.2.2.7](#processes227) повторной проверки подписи со
следующими входными данными:

- РЭЦП;
- вердикт и статус, полученные на шаге 2;
- СОК подписанта;
- список точек доверия;
- текущий список доказательств существования;
- аттестаты;
- политика применения сертификатов;
- криптографические ограничения.

Если вердикт алгоритма отличается от `PASSED`, то возвратить этот вердикт и 
соответствующий статус.

**Шаг 6 (самое раннее доказательство существования).**
По текущему списку доказательств существования определить самый ранний 
момент времени, когда подпись существовала.

<!--
todo: опять, базовая подпись или просто подпись.
-->

**Шаг 7 (проверка дополнительных ограничений).**
Повторить шаг 7 алгоритма [8.2.3](#processes23) проверки подписи профиля B-B,
использовав время, полученное на шаге 6, в качестве времени проверки.

**Шаг 8.** Возвратить `PASSED`.


# 9 <a name="cades"></a>Формат CAdES

## 9.1 <a name="cades1"></a>Общие положения

Формат CAdES определяет синтаксис РЭЦП и правила включения атрибутов, описанных
в разделе [6](#attrs).

Данные формата CAdES — это подписанные данные, синтаксис которых определен в СТБ
34.101.23 (разделы 8 и 15). Данные описываются с помощью языка АСН.1. Для
кодирования данных ДОЛЖНЫ использоваться базовые (BER) или отличительные (DER)
правила. В большинстве случаев разрешается использовать базовые правила.
Некоторые атрибуты, сертификаты, списки и аттестаты отзыва и другие элементы
должны кодироваться с помощью отличительных правил.

Некоторые типы АСН.1 являются динамическими, т.е. фактический тип элемента
определяется во время декодирования и зависит от значения специального
компонента, содержащего идентификатор типа. Такой прием используется для
определения типов атрибутов.

<!--- 5.4; 4.4 -->
Подписанные данные представляются типом АСН.1 `SignedData`, определенным в СТБ
34.101.23 (пункт 8.2). Значение этого типа вкладывается в контейнер
`ContentInfo`, определенный в СТБ 34.101.23 (раздел 6), как компонент `content`.
<!--- 5.3; 4.3 -->
Значение компонента `contentType` ДОЛЖНО содержать идентификатор
`id-signedData`.

В отличие от формата XAdES, позволяющего подписывать несколько объектов, в
качестве подписываемого содержимого РЭЦП формата CAdES может выступать только
один документ.
<!--- 5.5; 4.5 -->
Идентификатор типа подписываемых данных указывается в компоненте `eContentType`
типа `EncapsulatedContentInfo`, определенной в СТБ 34.101.23 (пункт 8.3).
<!--- 5.2; 4.2 -->
В качестве значения компонента `eContentType` МОЖЕТ выступать идентификатор
`id-data`, определенный в СТБ 34.101.23 (раздел 7). В этом случае РЕКОМЕНДУЕТСЯ
кодировать содержимое с помощью формата MIME и использовать тип MIME для
определения формата представления данных.

Согласно СТБ 34.101.23 компонент `eContent` является необязательным. При
наличии, он содержит подписанный документ, и подпись является обертывающей.
Иначе подписанный документ хранится отдельно, а подпись является отделенной.

<!--- 5.6; 4.6 -->
Тип `SignedData` позволяет сохранить несколько РЭЦП, выработанных различными
подписантами. Значение РЭЦП одного подписанта представляется типом `SignerInfo`,
определенным в СТБ 34.101.23 (пункт 8.4). Подписанные атрибуты указываются в
компоненте `signedAttrs`. Набор подписанных атрибутов ДОЛЖЕН включать атрибуты
`ContentType` и `MessageDigest`. Неподписанные атрибуты указываются в компоненте
`unsignedAttrs`.

Отнесение атрибута к подписанту, документу или подписи является логическим, а не
имеет синтаксического отражения в РЭЦП формата CAdES.

## 9.2 <a name="cades2"></a>Синтаксис базовых атрибутов РЭЦП

### 9.2.1 <a name="cades21"></a>Атрибут `ContentType`
<!--- 5.7.1; 5.1.1 -->

Синтаксис и правила включения атрибута `ContentType` определены в СТБ 34.101.23
(пункт 15.2).
<!--- CMS (RFC 3852 [4]), пункт 11.1. -->

>Примечание — Значение атрибута `ContentType` ДОЛЖНО соответствовать значению
компонента `eContentType` типа `EncapsulatedContentInfo`.

### 9.2.2 <a name="cades22"></a>Атрибут `MessageDigest`
<!--- 5.7.2; 5.1.2 -->

Синтаксис и правила включения атрибута `MessageDigest` определены в СТБ
34.101.23 (пункт 15.3).
<!--- CMS (RFC 3852 [4]). -->

### 9.2.3 <a name="cades23"></a>Атрибут `SigningTime`
<!--- 5.9.1; 5.2.1 -->

Синтаксис и правила включения атрибута `SigningTime` определены в СТБ 34.101.23
(пункт 15.4).

### 9.2.4 <a name="cades24"></a>Атрибут `SigningCertificate`
<!--- 5.7.3; 5.2.2 -->

В зависимости от используемого алгоритма хэширования атрибут
представляется одним из двух типов АСН.1: `SigningCertificate` или 
`SigningCertificateV2`. 

При использовании алгоритма хэширования SHA-1, определенного в
[[4]](#biblio.SHA1)], ДОЛЖЕН применяться тип `SigningCertificate`, а
атрибуту назначается следующий идентификатор:

    id-aa-signingCertificate OBJECT IDENTIFIER ::= {
        iso(1) member-body(2) us(840) rsadsi(113549)
            pkcs(1) pkcs9(9) smime(16) id-aa(2) 12
    }

При использовании алгоритмов хэширования, отличных от SHA-1, ДОЛЖЕН применяться
тип `SigningCertificateV2`, а атрибуту назначается следующий идентификатор:

    id-aa-signingCertificateV2 OBJECT IDENTIFIER ::= {
        iso(1) member-body(2) us(840) rsadsi(113549)
            pkcs(1) pkcs9(9) smime(16) id-aa(2) 47
    }

Тип `SigningCertificate` определен в [[17]](#biblio.ESS).
Тип `SigningCertificateV2` определен в [[21]](#biblio.ESSUPD).

    SigningCertificate ::=  SEQUENCE {
        certs        SEQUENCE OF ESSCertID,
        policies     SEQUENCE OF PolicyInformation OPTIONAL
    }
    ESSCertID ::= SEQUENCE {
         certHash       Hash,
         issuerSerial   IssuerSerial OPTIONAL
    }
    SigningCertificateV2 ::=  SEQUENCE {
        certs       SEQUENCE OF ESSCertIDv2,
        policies    SEQUENCE OF PolicyInformation OPTIONAL
    }
    id-sha256  OBJECT IDENTIFIER  ::=  { 
        joint-iso-itu-t(2) country(16) us(840) organization(1) gov(101)
            csor(3) nistalgorithm(4) hashalgs(2) 1
    }
    ESSCertIDv2 ::= SEQUENCE {
         hashAlgorithm  AlgorithmIdentifier DEFAULT {algorithm id-sha256},
         certHash       Hash,
         issuerSerial   IssuerSerial OPTIONAL
    }
    Hash ::= OCTET STRING
    IssuerSerial ::= SEQUENCE {
         issuer         GeneralNames,
         serialNumber   CertificateSerialNumber
    }

Компонент `certs` содержит ссылки на сертификаты, используемые при проверке
подписи. Ссылка на сертификат представляется типом `ESSCertID` или `ESSCertIDv2`
в зависимости от алгоритма хэширования. Первой в списке должна следовать ссылка
на сертификат подписанта, при кодировании которой СЛЕДУЕТ указывать компонент
`issuerSerial`.

Компонент `policies` НЕ ДОЛЖЕН использоваться.

Хэш-значение, вычисленное от кодового представления сертификата, полученного с
использованием отличительных правил, указывается в компоненте `certHash`.

В типах `ESSCertID` и `ESSCertIDv2` компонент `issuerSerial` не является точной
ссылкой на сертификат, а только подсказкой для его определения. Точной ссылкой
является хэш-значение, заданное в компоненте `certHash`.

>Примечание — Введение двух типов для описания атрибута `SigningCertificate`
позволяет устранить недостатки при изначальном проектировании и поддержать
совместимость с устаревшими реализациями. В тех случаях когда совместимость не
нужна, следует избегать использования в атрибуте алгоритма хэширования SHA-1,
признанного криптографически нестойким.

### 9.2.5 <a name="cades25"></a>Атрибут `CommitmentTypeIndication`
<!--- 5.11.1; 5.2.3 -->

Атрибуту назначается следующий идентификатор:

    id-aa-ets-commitmentType OBJECT IDENTIFIER ::= { 
        iso(1) member-body(2) us(840) rsadsi(113549) 
        pkcs(1) pkcs-9(9) smime(16) id-aa(2) 16
    }

Синтаксис атрибута описывается типом `CommitmentTypeIndication`:

    CommitmentTypeIndication ::= SEQUENCE {
        commitmentTypeId CommitmentTypeIdentifier,
        commitmentTypeQualifier SEQUENCE SIZE (1..MAX) 
                        OF CommitmentTypeQualifier OPTIONAL
    }
    CommitmentTypeIdentifier ::= OBJECT IDENTIFIER
    CommitmentTypeQualifier ::= SEQUENCE {
        commitmentTypeIdentifier CommitmentTypeIdentifier, 
        qualifier   ANY DEFINED BY commitmentTypeIdentifier
    }

Компонент `commitmentTypeId` содержит идентификатор обязательства.

Возможные значения компонента `commitmentTypeQualifier` типа
`CommitmentTypeIndication` не рассматриваются в настоящем стандарте.

Типам обязательств, объявленным при определении атрибута, 
назначаются идентификаторы:

    id-cti-ets-arc OBJECT IDENTIFIER ::= { 
        iso(1) member-body(2) us(840) rsadsi(113549) 
        pkcs(1) pkcs-9(9) smime(16) cti(6)
    }
    id-cti-ets-proofOfOrigin OBJECT IDENTIFIER ::= { id-cti-ets-arc 1 }
    id-cti-ets-proofOfReceipt OBJECT IDENTIFIER ::= { id-cti-ets-arc 2 }
    id-cti-ets-proofOfDelivery OBJECT IDENTIFIER ::= { id-cti-ets-arc 3}
    id-cti-ets-proofOfSender OBJECT IDENTIFIER ::= { id-cti-ets-arc 4}
    id-cti-ets-proofOfApproval OBJECT IDENTIFIER ::= { id-cti-ets-arc 5}
    id-cti-ets-proofOfCreation OBJECT IDENTIFIER ::= { id-cti-ets-arc 6}

Этот компонент может содержать только распознаваемые типы обязательств.

### 9.2.6 <a name="cades26"></a>Атрибут `ContentHints`
<!--- 5.10.3; 5.2.4.1 -->

Атрибуту назначается следующий идентификатор:

    id-aa-contentHint OBJECT IDENTIFIER ::= { iso(1) member-body(2) us(840)
        rsadsi(113549) pkcs(1) pkcs-9(9) smime(16) id-aa(2) 4}

Синтаксис атрибута описывается типом `ContentHints`, определенным в 
[[ESS]](#biblio.ESS). 

    ContentHints ::= SEQUENCE {
        contentDescription UTF8String (SIZE (1..MAX)) OPTIONAL,
        contentType ContentType
    }

Если этот атрибут используется для указания точного формата данных,
представляемых пользователю, применяются следующие правила:

- компонент `contentType` показывает тип связанного содержимого; это
идентификатор объекта (т. е. уникальная строка целых чисел), назначенная
службой, определяющей тип содержимого;
- если значением компонента `contentType` является идентификатор `id-data`,
определенный в СТБ 34.101.23, то компонент `contentDescription` должен
определять формат представления данных, который может быть задан типами MIME.

Если формат содержимого задан с помощью типов MIME, применяются следующие
правила:

- компонент `contentType` должен иметь значение `id-data`;
- компонент `contentDescription` должен использоваться для указания MIME-типа
данных, определенного в соответствии с правилами документа [[16]](#biblio.MIME).
<!--- Пример структурированного содержимого и типов MIME см. в приложении Е. -->

### 9.2.7 <a name="cades27"></a>Атрибут `MimeType`
<!--- ; 5.2.4.2 -->

Атрибуту назначается следующий идентификатор:

    id-aa-ets-mimeType OBJECT IDENTIFIER ::= { itu-t(0) identified-organization(4) etsi(0)
        electronic-signature-standard (1733) attributes(2) 1 }

Синтаксис атрибута описывается типом `MimeType`:

    MimeType::= UTF8String

Атрибут содержит MIME-тип подписанных данных. Значение атрибута должно
формироваться по правилам, определенным в [[16]](#biblio.MIME).

>Примечание — Этот атрибут схож с компонентом `contentDescription` атрибута
`ContentHints`, но МОЖЕТ быть использован не только в многоуровневом документе.

### 9.2.8 <a name="cades28"></a>Атрибут `SignerLocation`
<!--- 5.11.2; 5.2.5 -->

Атрибуту назначается следующий идентификатор:

    id-aa-ets-signerLocation OBJECT IDENTIFIER ::= { 
        iso(1) member-body(2) us(840) rsadsi(113549) 
        pkcs(1) pkcs-9(9) smime(16) id-aa(2) 17
    }
    
Синтаксис атрибута описывается типом `SignerLocation`:

    SignerLocation ::= SEQUENCE { 
        -- at least one of the following shall be present: 
        countryName [0] DirectoryString OPTIONAL,
        -- As used to name a Country in X.500 
        localityName [1] DirectoryString OPTIONAL,
        -- As used to name a locality in X.500 
        postalAddress [2] PostalAddress OPTIONAL
    }
    PostalAddress ::= SEQUENCE SIZE(1..6) OF DirectoryString

### 9.2.9 <a name="cades29"></a>Атрибут `SignerAttributes`
<!--- 5.11.3; 5.2.6.1 -->

Атрибуту назначается следующий идентификатор:

    id-aa-ets-signerAttrV2 OBJECT IDENTIFIER ::= { 
        itu-t(0) identified-organization(4)
        etsi(0) cades(19122) attributes(1) 1
    }

Синтаксис атрибута описывается типом `SignerAttributeV2`:

    SignerAttributeV2 ::= SEQUENCE {
        claimedAttributes [0] ClaimedAttributes OPTIONAL,
        certifiedAttributesV2 [1] CertifiedAttributesV2 OPTIONAL,
        signedAssertions [2] SignedAssertions OPTIONAL
    }
    ClaimedAttributes ::= SEQUENCE OF Attribute
    CertifiedAttributesV2 ::= SEQUENCE OF CHOICE {
        attributeCertificate [0] AttributeCertificate,
        otherAttributeCertificate [1] OtherAttributeCertificate
    }
    OtherAttributeCertificate ::= SEQUENCE {
        otherAttributeCertID OBJECT IDENTIFIER,
        otherAttributeCert ANY DEFINED BY otherAttributeCertID OPTIONAL
    }
    SignedAssertions ::= SEQUENCE OF SignedAssertion
    SignedAssertion ::= SEQUENCE {
        signedAssertionID OBJECT IDENTIFIER,
        signedAssertion ANY DEFINED BY signedAssertionID OPTIONAL
    }

Тип `AttributeCertificate` определен в СТБ 34.101.67.

Неудостоверенные атрибуты указываются в компоненте `claimedAttributes`.
Заявляемые SAML-утверждения могут указываться в компоненте `claimedAttributes`.
Следующий идентификатор атрибута определяет SAML-утверждения:

    id-aa-ets-claimedSAML OBJECT IDENTIFIER ::= { 
        itu-t(0) identified-organization(4)
        etsi(0) cades(19122) attributes(1) 2 
    }

Атрибут, содержащий SAML-утверждения, имеет следующий синтаксис:

    ClaimedSAMLAssertion ::= OCTET STRING

Удостоверенные атрибуты указываются в компоненте `certifiedAttributesV2`.
Удостоверенные атрибуты представляют собой атрибутные сертификаты. Атрибутный
сертификат согласно СТБ 34.101.67 указывается в компоненте
`attributeCertificate`. Атрибутный сертификат в ином синтаксисе указывается в
компоненте `otherAttributeCertificate`, при этом тип представления указывается в
компоненте `otherAttributeCertID`, а значение атрибутного сертификата — в
компоненте `otherAttributeCert`. Не рекомендуется использовать компонент
`otherAttributeCertificate`.

<!--- 
todo: Не рекомендуется использовать атрибутные сертификаты в ином синтаксисе.  
-->

Подписанные третьей стороной утверждения указываются в компоненте
`signedAssertions`. Тип представления утверждения указывается в компоненте
`signedAssertionID`, а значение утверждения — в компоненте `signedAssertion`.
Определения подписанных утверждений выходят за рамками настоящего стандарта.

### 9.2.10 <a name="cades210"></a>Атрибут `CounterSignature`
<!--- 5.9.2; 5.2.7 -->

Синтаксис атрибута описывается типом `Countersignature`, который определен
(вместе с правилами включения) в СТБ 34.101.23 (пункт 15.5).
<!--- CMS (RFC 3852 [4]). -->

### 9.2.11 <a name="cades211"></a>Атрибут `ContentTimeStamp`
<!--- 5.11.4; 5.2.8 -->

Атрибуту назначается следующий идентификатор:

    id-aa-ets-contentTimestamp OBJECT IDENTIFIER ::= { 
        iso(1) member-body(2) us(840) rsadsi(113549) 
        pkcs(1) pkcs-9(9) smime(16) id-aa(2) 20
    }

Синтаксис атрибута описывается типом `ContentTimestamp`, определенным в СТБ
34.101.82:

    ContentTimestamp::= TimeStampToken
    TimeStampToken ::= ContentInfo
     
Штамп времени вырабатывается от подписываемого содержимого. В случае
прикрепленной подписи хэшируется значение компонента `eContent`, без учета тега
и длины. В случае отделенной подписи хэшируются внешние данные.

>Примечание 1 — Атрибут `ContentTimeStamp` указывает, что подписанный документ
был сформирован до даты, заданной атрибутом `ContentTimeStamp`.

<!--- Замечание 5 -->
>Примечание 2 — Несколько значений атрибута, выработанных разными модулями
штампов времени, МОГУТ содержаться в РЭЦП. При этом в набор
`SignerInfo.signedAttrs` ДОЛЖЕН быть добавлен новый элемент, соответствующий
значению данного атрибута.

### 9.2.12 <a name="cades212"></a>Атрибут `SignaturePolicyIdentifier`
<!--- 5.8.1; 5.2.9 -->

Атрибуту назначается следующий идентификатор:

    id-aa-ets-sigPolicyId OBJECT IDENTIFIER ::= { 
        iso(1) member-body(2) us(840) rsadsi(113549) 
        pkcs(1) pkcs9(9) smime(16) id-aa(2) 15
    }

Синтаксис атрибута описывается типом `SignaturePolicyIdentifier`:

    SignaturePolicyIdentifier ::= CHOICE {
        signaturePolicyId SignaturePolicyId,
        signaturePolicyImplied SignaturePolicyImplied -- not used in this version
    }
    SignaturePolicyId ::= SEQUENCE {
        sigPolicyId SigPolicyId,
        sigPolicyHash SigPolicyHash,
        sigPolicyQualifiers SEQUENCE SIZE (1..MAX) 
                    OF SigPolicyQualifierInfo OPTIONAL
    }
    SignaturePolicyImplied ::= NULL

Ссылка на политику подписи указывается явно, поэтому вариант
`signaturePolicyImplied` НЕ ДОЛЖЕН использоваться.

Компонент `sigPolicyId` содержит идентификатор объекта, который однозначно
определяет версию политики подписи, и имеет тип:

    SigPolicyId ::= OBJECT IDENTIFIER
    
Компонент `sigPolicyHash` содержит идентификатор алгоритма хэширования и
хэш-значение политики подписи.
<!--- В оригинале допускается использовать нулевое хэш-значение,
в случае, если оно не известно. Так было сделано для обратной
совместимости. Но сейчас нам нет смысла вводить такую опциональность.
-->

Если политика подписи определена с помощью синтаксиса АСН.1, то хэш-значение
вычисляется без значений внешнего типа и длины, при этом должен использоваться
алгоритм хэширования, идентификатор которого указан в компоненте
`sigPolicyHash`. Тип компонента `sigPolicyHash` определен следующим образом:

    SigPolicyHash ::= OtherHashAlgAndValue
    OtherHashAlgAndValue ::= SEQUENCE {
        hashAlgorithm   AlgorithmIdentifier,
        hashValue   OtherHashValue 
    }
    OtherHashValue ::= OCTET STRING

Идентификатор политики подписи может быть уточнен с помощью квалификаторов,
указываемых в компоненте `sigPolicyQualifiers`. Квалификатор имеет следующий
тип:

    SigPolicyQualifierInfo ::= SEQUENCE {
        sigPolicyQualifierId  SigPolicyQualifierId,
        sigQualifier ANY DEFINED BY sigPolicyQualifierId 
    }

В настоящем стандарте определены следующие квалификаторы:

- URI или URL документа, содержащего политику подписи. Определяется
идентификатором `id-spq-ets-uri`;
- примечание, отображаемое пользователю при каждой проверке подписи.
Определяется идентификатором `id-spq-ets-unotice`;
- идентификатор технической спецификации, определяющей синтаксис, используемый
для создания документа, содержащего политику подписи. Определяется
идентификатором `id-spq-ets-docspec`.

Квалификаторы имеют следующий синтаксис:

    SigPolicyQualifierId ::= OBJECT IDENTIFIER

    id-spq-ets-uri OBJECT IDENTIFIER ::= { 
        iso(1) member-body(2) us(840) rsadsi(113549) 
        pkcs(1) pkcs9(9) smime(16) id-spq(5) 1
    }
    SPuri ::= IA5String

    id-spq-ets-unotice OBJECT IDENTIFIER ::= { 
        iso(1) member-body(2) us(840) rsadsi(113549) 
        pkcs(1) pkcs9(9) smime(16) id-spq(5) 2
    }
    SPUserNotice ::= SEQUENCE {
        noticeRef NoticeReference OPTIONAL, 
        explicitText DisplayText OPTIONAL
    }
    NoticeReference ::= SEQUENCE {
        organization DisplayText, 
        noticeNumbers SEQUENCE OF INTEGER
    }
    DisplayText ::= CHOICE {
        visibleString VisibleString  (SIZE (1..200)),
        bmpString BMPString          (SIZE (1..200)),
        utf8String UTF8String        (SIZE (1..200))
    }

    id-spq-ets-docspec OBJECT IDENTIFIER ::= { 
        itu-t(0) identified-organization(4)
        etsi(0) cades(19122) id-spq (2) 1
    }
    SPDocSpecification ::= CHOICE {
        oid OBJECT IDENTIFIER,
        uri IA5String 
    }


### 9.2.13 <a name="cades213"></a>Атрибут `SignaturePolicyStore`
<!--- ; 5.2.10 -->

Атрибуту назначается следующий идентификатор:

    id-aa-ets-sigPolicyStore OBJECT IDENTIFIER ::= {
        itu-t(0) identified-organization(4)
        etsi(0) cades(19122) attributes(1) 3
    }

Синтаксис атрибута описывается типом `SignaturePolicyStore`:

    SignaturePolicyStore ::= SEQUENCE {
        spDocSpec SPDocSpecification,
        spDocument SignaturePolicyDocument
    }
    SPDocSpecification ::= CHOICE {
        oid OBJECT IDENTIFIER,
        uri IA5String
    }
    SignaturePolicyDocument ::= CHOICE {
        sigPolicyEncoded OCTET STRING,
        sigPolicyLocalURI IA5String
    }

Компонент `spDocument` содержит либо закодированный документ с политикой подписи
в компоненте `sigPolicyEncoded`, либо URI, указывающий на документ в локальном
хранилище, в компоненте `sigPolicyLocalURI`.

>Примечание — В отличие от `SPuri`, `sigPolicyLocalURI` указывает на локальный 
файл.

Компонент `spDocSpec` указывает на техническую спецификацию, определяющую
синтаксис политики подписи.

>Примечание 1 — Ответственность за доступность корректного документа ложится на
участника, добавляющего политику подписи в хранилище.

>Примечание 2 — Атрибут `SignaturePolicyStore` является неподписанным. Это
обусловлено тем, что любые изменения документа с политикой подписи или ссылки на
него приведут к признанию подписи недействительной.

<!--- Требование k -->
>Примечание 3 — Данный атрибут включается только в случае, когда атрибут
`SignaturePolicyIdentifier` также включен и содержит в компоненте
`sigPolicyHash` хэш-значение документа политики подписи. Иначе данный атрибут
включаться НЕ ДОЛЖЕН.

### 9.2.14 <a name="cades214"></a>Атрибут `ContentReference`
<!--- 5.10.1; 5.2.11 -->

Атрибуту назначается следующий идентификатор:

    id-aa-contentReference   OBJECT IDENTIFIER ::= { 
        iso(1) member-body(2) us(840) rsadsi(113549) 
        pkcs(1) pkcs-9(9) smime(16) id-aa(2) 10 
    }

Синтаксис атрибута описывается типом `ContentReference`, определенным в
[[ESS]](#biblio.ESS):

    ContentReference ::= SEQUENCE {
        contentType ContentType,
        signedContentIdentifier ContentIdentifier,
        originatorSignatureValue OCTET STRING 
    }

В РЭЦП, на которую ссылается данный атрибут, должен быть указан атрибут
`ContentIdentifier`, а соответствующее значение указывается в компоненте
`signedContentIdentifier` данного атрибута. Компонент `contentType` содержит 
тип содержимого, а `originatorSignatureValue` — значение подписи РЭЦП, на 
которую ссылается атрибут.

### 9.2.15 <a name="cades215"></a>Атрибут `ContentIdentifier`
<!--- 5.10.2; 5.2.12 -->

Атрибуту назначается следующий идентификатор:

    id-aa-contentIdentifier OBJECT IDENTIFIER ::= { 
        iso(1) member-body(2) us(840) rsadsi(113549) 
        pkcs(1) pkcs-9(9) smime(16) id-aa(2) 7
    }

Синтаксис атрибута описывается типом `ContentIdentifier`, 
определенным в [[ESS]](#biblio.ESS):

    ContentIdentifier ::= OCTET STRING

Атрибут содержит уникальный идентификатор, связанный с документом.

Для обеспечения уникальности, атрибут `ContentIdentifier` СЛЕДУЕТ формировать
как конкатенацию идентификационной информации пользователя (такой как имя
пользователя или открытый ключ), строки типа `GeneralizedTime` и случайного
числа.

## 9.3 <a name="cades3"></a>Синтаксис атрибута штампа времени

### 9.3.1 <a name="cades31"></a>Атрибут `SignatureTimeStamp`
<!--- 6.1.1; 5.3 -->

Атрибуту назначается следующий идентификатор:

    id-aa-signatureTimeStampToken OBJECT IDENTIFIER ::= { 
        iso(1) member-body(2) us(840) rsadsi(113549) 
        pkcs(1) pkcs-9(9) smime(16) id-aa(2) 14
    }

Синтаксис атрибута описывается типом `SignatureTimeStampToken`:

    SignatureTimeStampToken ::= TimeStampToken

Тип `TimeStampToken` определен в СТБ 34.101.82.

Штамп времени вырабатывается от значения подписи, указываемого в компоненте
`SignerInfo.signature`, без учета тега и длины. РЭЦП МОЖЕТ содержать несколько
экземпляров этого атрибута от разных служб штампов времени.

>Примечание — В случае нескольких подписей штампы времени 
МОГУТ проставляться на значения подписей только некоторых или всех
подписантов, содержащихся в `SignedData`.

<!--- Требование l -->
При кодировании значений атрибута ДОЛЖНЫ использоваться отличительные правила.

<!--- Требование m 
Штампы времени должны выставляться до истечения срока действия или отзыва
сертификата подписанта.
-->

## 9.4 <a name="cades4"></a>Синтаксис атрибутов проверочных данных

### 9.4.1 <a name="cades41"></a>Атрибут `CompleteCertificateReferences`
<!--- 6.2.1; A.1.1.1 -->

Атрибуту назначается следующий идентификатор:

    id-aa-ets-certificateRefs OBJECT IDENTIFIER ::= { 
        iso(1) member-body(2) us(840) rsadsi(113549) 
        pkcs(1) pkcs-9(9) smime(16) id-aa(2) 21
    }

Синтаксис атрибута описывается типом `CompleteCertificateRefs`:

    CompleteCertificateRefs ::=  SEQUENCE OF OtherCertID
    OtherCertID ::= SEQUENCE {
        otherCertHash OtherHash,
        issuerSerial IssuerSerial OPTIONAL 
    }
    OtherHash ::= CHOICE {
        sha1Hash OtherHashValue, -- This contains a SHA-1 hash
        otherHash OtherHashAlgAndValue 
    }

Ссылка представляет собой хэш-значение, вычисленное от кодового представления
сертификата, полученного с помощью отличительных правил. Хэш-значение
указывается в компоненте `otherCertHash`.
<!--- Требование g -->
Компонент `issuerSerial` НЕ ДОЛЖЕН быть включен в значения типа `OtherCertID`.

Хэш-значения, вычисленные по алгоритму SHA-1, указываются в компоненте
`sha1Hash`, другие хэш-значения указываются в компоненте `otherCertHash`.

>Примечание — Копии значений сертификатов могут храниться 
в атрибуте `CertificateValues` либо в компоненте `SignedData.certificates`.

Атрибут МОЖЕТ содержать ссылки на цепочки сертификатов модулей штампов времени,
предоставляющих штампы времени. В этом случае ссылки на сертификаты указываются
как атрибуты соответствующих штампов времени.

### 9.4.2 <a name="cades42"></a>Атрибут `CertificateValues`
<!--- 6.3.3; A.1.1.2 -->

Атрибуту назначается следующий идентификатор:

    id-aa-ets-certValues OBJECT IDENTIFIER ::= { 
        iso(1) member-body(2) us(840) rsadsi(113549) 
        pkcs(1) pkcs-9(9) smime(16) id-aa(2) 23
    }

Синтаксис атрибута описывается типом `CertificateValues`:

    CertificateValues ::= SEQUENCE OF Certificate

Тип `Certificate` определен в СТБ 34.101.19. 

Атрибут ДОЛЖЕН содержать только сертификаты, ссылки на которые указаны в
атрибутах `CompleteCertificateReferences`, `AttributeCertificateReferences` и
`SigningCertificate`, и которые не содержатся в `SignedData.certificates`.
Атрибут `AttributeCertificateValues` в формате CAdES не используется.

Атрибут МОЖЕТ содержать информацию о сертификатах модулей штампов времени,
предоставляющих штампы времени, если эти сертификаты еще не включены в них как
часть подписей служб штампов времени. В этом случае неподписанный атрибут
добавляется к структуре `SignedData` соответствующего штампа времени.
<!--- Требований нет -->

### 9.4.3 <a name="cades43"></a>Атрибут `CompleteRevocationReferences`
<!--- 6.2.2; A.1.2.1 -->

Атрибуту назначается следующий идентификатор:

    id-aa-ets-revocationRefs OBJECT IDENTIFIER ::= { 
        iso(1) member-body(2) us(840) rsadsi(113549) 
        pkcs(1) pkcs-9(9) smime(16) id-aa(2) 22
    }

Синтаксис атрибута описывается типом `CompleteRevocationRefs`:

    CompleteRevocationRefs ::=  SEQUENCE OF CrlOcspRef
    CrlOcspRef ::= SEQUENCE {
        crlids   [0] CRLListID   OPTIONAL,
        ocspids  [1] OcspListID  OPTIONAL,
        otherRev [2] OtherRevRefs OPTIONAL 
    }

Атрибут содержит элементы типа `CrlOcspRef`, соответствующие списку 1 из
описания атрибута `CompleteRevocationReferences`, и ДОЛЖЕН начинаться с
аттестатов отзыва сертификата подписанта. Аттестаты отзыва ДОЛЖНЫ включаться в
порядке перечисления соответствующих сертификатов в атрибуте
`CompleteCertificateReferences`.
Затем МОГУТ следовать аттестаты отзыва из списка 2.

    CRLListID ::= SEQUENCE {
        crls SEQUENCE OF CrlValidatedID 
    }
    CrlValidatedID ::= SEQUENCE {
        crlHash OtherHash,
        crlIdentifier CrlIdentifier OPTIONAL 
    }
    CrlIdentifier ::= SEQUENCE {
        crlissuer Name,
        crlIssuedTime UTCTime,
        crlNumber INTEGER OPTIONAL 
    }

При создании значения типа `CrlValidatedID` значение `crlHash` ДОЛЖНО быть
вычислено по кодовому представлению СОС, полученному с использованием
отличительных правил. Компонент `crlIdentifier` СЛЕДУЕТ указывать, если СОС
нельзя определить другим способом.

Компонент `crlIdentifier` ДОЛЖЕН идентифицировать СОС с использованием имени
издателя, времени выпуска списка, которое ДОЛЖНО соответствовать времени в
компоненте `thisUpdate` искомого СОС, и компонента `crlNumber`, если он задан.
Если идентифицированный СОС является ПСОС, то ДОЛЖНЫ быть включены ссылки на
весь набор ПСОС для формирования полного СОС, включаемого в проверочные данные.

    OcspListID ::= SEQUENCE {
        ocspResponses SEQUENCE OF OcspResponsesID 
    }
    OcspResponsesID ::= SEQUENCE {
        ocspIdentifier OcspIdentifier,
        ocspRefHash OtherHash OPTIONAL  -- must be included
    }
    OcspIdentifier ::= SEQUENCE {
        ocspResponderID ResponderID, -- As in OCSP response data
        producedAt GeneralizedTime  -- As in OCSP response data
    }
    OtherRevRefs ::= SEQUENCE {
        otherRevRefType OtherRevRefType, 
        otherRevRefs ANY DEFINED BY otherRevRefType 
    }
    OtherRevRefType ::= OBJECT IDENTIFIER

Компонент `ocspIdentifier` ДОЛЖЕН идентифицировать ответ OCSP с помощью имени
издателя и времени выдачи ответа OCSP, которое должно соответствовать времени в
выданном ответе OCSP.
Компонент `ocspRefHash` является необязательным для совместимости; РЕКОМЕНДУЕТСЯ
всегда включать этот компонент.
Реализации, проверяющие подпись, могут принимать подписи без этого элемента. Но
следует учитывать, что его отсутствие позволяет проводить атаки с подменой
ответов OCSP, например, при компрометации ключей службы OCSP. Реализации,
принимающие подписи без этого элемента, МОГУТ использовать сторонние механизмы
для гарантии того, что ни один из ключей службы OCSP не был скомпрометирован на
время проверки.

>Примечание 1 — Копии СОС и ответов OCSP МОГУТ храниться в атрибуте
`RevocationValues`.

>Примечание 2 — Рекомендуется использовать данный атрибут вместо атрибута
`OtherRevocationInfoFormat`, определенного в СТБ 34.101.23, для обеспечения
обратной совместимости.

Синтаксис и семантика других ссылок на СОС выходят за рамки настоящего
стандарта. Для определения других форм информации об отозванных сертификатах
используется тип `OtherRevRefType`.

Атрибут МОЖЕТ содержать ссылки на полный набор СОС и ответов OCSP, которые
использовались для проверки цепочки сертификатов модулей штампов времени. В этом
случае неподписанный атрибут добавляется к структуре `SignedData`
соответствующего штампа времени.
<!--- Требований нет -->

### 9.4.4 <a name="cades44"></a>Атрибут `RevocationValues`
<!--- 6.3.4; A.1.2.1 -->

Атрибуту назначается следующий идентификатор:

    id-aa-ets-revocationValues OBJECT IDENTIFIER ::= { 
        iso(1) member-body(2) us(840) rsadsi(113549) 
        pkcs(1) pkcs-9(9) smime(16) id-aa(2) 24
    }

Синтаксис атрибута описывается типом `RevocationValues`:

    RevocationValues ::=  SEQUENCE {
        crlVals      [0] SEQUENCE OF CertificateList OPTIONAL,
        ocspVals     [1] SEQUENCE OF BasicOCSPResponse OPTIONAL,
        otherRevVals [2] OtherRevVals OPTIONAL
    }
    OtherRevVals ::= SEQUENCE {
        otherRevValType OtherRevValType, 
        otherRevVals ANY DEFINED BY OtherRevValType 
    }
    OtherRevValType ::= OBJECT IDENTIFIER

Атрибут ДОЛЖЕН содержать аттестаты отзыва, ссылки на которые перечислены в
атрибутах `CompleteRevocationReferences` и `AttributeRevocationReferences`, и
которые не содержатся в компоненте `SignedData.crls`.
Другие элементы НЕ ДОЛЖНЫ быть включены в этот атрибут.
Атрибут `AttributeRevocationValues` в формате CAdES не используется.

Синтаксис и семантика других аттестатов отзыва сертификатов, указываемых в типе
`OtherRevVals`, выходят за рамки настоящего стандарта.

Для определения других форм информации об отозванных сертификатах используется
тип `OtherRevRefType`.

Тип `CertificateList` определен в СТБ 34.101.19.
Тип `BasicOCSPResponse` определен в СТБ 34.101.26.

Атрибут МОЖЕТ содержать аттестаты отзыва сертификатов модулей штампов времени,
включая СОС и ответы OCSP, если эти сертификаты еще не включены как часть
подписей модулей штампов времени. В этом случае неподписанный атрибут
добавляется к структуре `SignedData` соответствующего штампа времени.

>Примечание — РЕКОМЕНДУЕТСЯ использовать данный атрибут вместо типа
`OtherRevocationInfoFormat`, определенного в СТБ 34.101.23, для обеспечения
обратной совместимости.

### 9.4.5 <a name="cades45"></a>Атрибут `AttributeCertificateReferences`
<!--- 6.2.3; A.1.3 -->

Атрибуту назначается следующий идентификатор:

    id-aa-ets-attrCertificateRefs OBJECT IDENTIFIER ::= { 
        iso(1) member-body(2) us(840) rsadsi(113549) 
        pkcs(1) pkcs-9(9) smime(16) id-aa(2) 44
    }

Синтаксис атрибута описывается типом `AttributeCertificateRefs`:

    AttributeCertificateRefs ::=  SEQUENCE OF OtherCertID

>Примечание — Копии значений сертификатов МОГУТ содержаться в атрибуте
`CertificateValues` или в компоненте `SignedData.certificates`. Атрибутный
сертификат ДОЛЖЕН содержаться в атрибуте `SignerAttributes`.

<!--- Требование n -->
Данный атрибут НЕ ДОЛЖЕН использоваться, если атрибут `SignerAttributes` не
содержит удостоверенные атрибуты или подписанные утверждения подписанта.

### 9.4.6 <a name="cades46"></a>Атрибут `AttributeCertificateValues`
<!--- ; XAdES 5.4.3 -->

Атрибут `AttributeCertificateValues` в формате CAdES не используется,
а соответствующие сертификаты указываются в атрибуте 
`CertificateValues`.

### 9.4.7 <a name="cades47"></a>Атрибут `AttributeRevocationReferences`
<!--- 6.2.4; A.1.4 -->

Атрибуту назначается следующий идентификатор:

    id-aa-ets-attrRevocationRefs OBJECT IDENTIFIER ::= { 
        iso(1) member-body(2) us(840) rsadsi(113549) 
        pkcs(1) pkcs-9(9) smime(16) id-aa(2) 45
    }

Синтаксис атрибута описывается типом `AttributeRevocationRefs`:
    
    AttributeRevocationRefs ::=  SEQUENCE OF CrlOcspRef

>Примечание — Копии значений аттестатов отзыва МОГУТ содержаться
в атрибуте `RevocationValues` или в компоненте `SignedData.crls`.

Если один или несколько СОС не являются полными, а содержат приращение к
предыдущему, то атрибут ДОЛЖЕН содержать полный набор ПСОС, необходимый для
построения полного СОС.

<!--- Требование n -->
Данный атрибут НЕ ДОЛЖЕН использоваться, если атрибут `SignerAttributes` не
содержит удостоверенные атрибуты или подписанные утверждения подписанта.

### 9.4.8 <a name="cades48"></a>Атрибут `AttributeRevocationValues`
<!--- ; XAdES 5.4.3 -->

Атрибут `AttributeRevocationValues` в формате CAdES не используется, а
соответствующие аттестаты отзыва указываются в атрибуте `RevocationValues`.

### 9.4.9 <a name="cades49"></a>Атрибут `RefsOnlyTimeStamp`
<!--- 6.3.6; A.1.5.1 -->

Атрибуту назначается следующий идентификатор:

    id-aa-ets-certCRLTimestamp OBJECT IDENTIFIER ::= { 
        iso(1) member-body(2) us(840) rsadsi(113549) 
        pkcs(1) pkcs-9(9) smime(16) id-aa(2) 26
    }

Синтаксис атрибута описывается типом `TimestampedCertsCRLs`:

    TimestampedCertsCRLs ::= TimeStampToken

Штамп времени вырабатывается от конкатенации в указанном порядке значений
атрибутов `CompleteCertificateReferences` и `CompleteRevocationReferences`,
включая компоненты `attrType` и `attrValues` (с типом и длиной), но не включая
тип и длину внешнего контейнера `SEQUENCE`.

Атрибуты, к которым применяется штамп времени, СЛЕДУЕТ кодировать с
использованием отличительных правил. Если отличительные правила не используются,
то двоичное кодирование объектов АСН.1, к которым применяется штамп времени,
ДОЛЖНО быть сохранено с целью обеспечения согласованного повторного вычисления
хэш-значения.

<!--- Замечание 5 -->
>Примечание — Несколько значений данного атрибута, выработанных разными модулями
штампов времени, МОГУТ содержаться в РЭЦП. При этом в набор
`SignerInfo.unsignedAttrs` ДОЛЖЕН быть добавлен новый элемент, соответствующий
значению данного атрибута.

### 9.4.10 <a name="cades410"></a>Атрибут `SigAndRefsTimeStamp`
<!--- 6.3.5; A.1.5.2 -->

Атрибуту назначается следующий идентификатор:

    id-aa-ets-escTimeStamp OBJECT IDENTIFIER ::= { 
        iso(1) member-body(2) us(840) rsadsi(113549) 
        pkcs(1) pkcs-9(9) smime(16) id-aa(2) 25
    }

Синтаксис атрибута описывается типом `ESCTimeStampToken`:

    ESCTimeStampToken ::= TimeStampToken

Штамп времени вырабатывается от конкатенации в указанном порядке представления
компонента `SignerInfo.signature`, включая поля тега и длины, и значений
атрибутов `SignatureTimeStamp`, `CompleteCertificateReferences` и
`CompleteRevocationReferences`, включая компоненты `attrType` и `attrValues`,
включая поля тега и длины, но не включая поля тега и длины внешнего типа
`SEQUENCE`.

Атрибуты, к которым применяется штамп времени, СЛЕДУЕТ кодировать с
использованием отличительных правил. Если отличительные правила не используются,
то двоичное кодирование объектов АСН.1, к которым применяется штамп времени,
ДОЛЖНО быть сохранено с целью обеспечения согласованного повторного вычисления
хэш-значения.

<!--- Замечание 5 -->
>Примечание — Несколько значений данного атрибута, выработанных разными модулями
штампов времени, МОГУТ содержаться в РЭЦП. При этом в набор
`SignerInfo.unsignedAttrs` ДОЛЖЕН быть добавлен новый элемент, соответствующий
значению данного атрибута.

## 9.5 <a name="cades5"></a>Синтаксис атрибутов архивных проверочных данных


### 9.5.1 <a name="cades51"></a>Атрибут `TimeStampValidationData`
<!--- ; 5.5.2 -->

Атрибуту назначается следующий идентификатор:

    id-aa-ATSHashIndex-v3 OBJECT IDENTIFIER ::= {
        itu-t(0) identified-organization(4)
        etsi(0) cades(19122) attributes(1) 5
    }

Синтаксис атрибута описывается типом `ATSHashIndexV3`:

    ATSHashIndexV3 ::= SEQUENCE {
        hashIndAlgorithm AlgorithmIdentifier,
        certificatesHashIndex SEQUENCE OF OCTET STRING,
        crlsHashIndex SEQUENCE OF OCTET STRING,
        unsignedAttrValuesHashIndex SEQUENCE OF OCTET STRING 
    }

Значение атрибута должно быть закодировано с использованием отличительных
правил.

Компонент `hashIndAlgorithm` содержит идентификатор алгоритма хэширования,
используемого для вычисления хэш-значений, содержащихся в компонентах
`certificatesHashIndex`, `crlsHashIndex`, `unsignedAttrValuesHashIndex`. Этот же 
алгоритм хэширования должен использоваться при вычислении штампа времени
атрибута `ArchiveTimeStamp`.

Компонент `certificatesHashIndex` содержит список хэш-значений, вычисленных от
всех элементов типа `CertificateChoices`, содержащихся в компоненте
`certificates` объекта типа `SignedData` на момент выработки штампа времени
`ArchiveTimeStamp`. Другие хэш-значения не могут содержаться в списке
`certificatesHashIndex`.

Компонент `crlsHashIndex` содержит список хэш-значений, вычисленных от всех
элементов типа `RevocationInfoChoice`, содержащихся в компоненте `crls` объекта
типа `SignedData` на момент выработки штампа времени `ArchiveTimeStamp`. Другие
хэш-значения не могут содержаться в списке `crlsHashIndex`.

Компонент `unsignedAttrValuesHashIndex` содержит список хэш-значений, 
вычисленных от элементов типа `Attribute`, содержащихся в компонентах 
`unsignedAttrs` всех объектов типа `SignerInfo` на момент выработки штампа 
времени `ArchiveTimeStamp`. Для каждого элемента `Attribute` и для каждого 
значения в его компоненте `Attribute.attrValues` это значение предваряется 
значением `Attribute.attrType` и хэшируется. Другие хэш-значения не могут 
содержаться в списке `unsignedAttrValuesHashIndex`. При обработке списка 
проверяется, что он содержит хэш-значения всех пар (`Attribute.attrType`, 
значение в `Attribute.attrValues`) и только эти хэш-значения. 

Все перечисленные хэш-значения вычисляются от закодированных элементов, включая
поля тега и длины. Элементы типа `OtherCertificateFormat` должны быть
закодированы с использованием отличительных правил, за исключением случая
использования варианта `otherCert`, при котором способ кодирования сохраняется.

>Примечание — Использование атрибута `TimeStampValidationData` позволяет
добавлять сертификаты, информацию об отзыве, неподписанные атрибуты после
выработки штампа времени `ArchiveTimeStamp`. Поэтому при проверке атрибута
`TimeStampValidationData` требуется для каждого хэш-значения искать
соответствующий элемент, а не наоборот.

### 9.5.2 <a name="cades52"></a>Атрибут `ArchiveTimeStamp`
<!--- ; 5.5.3 -->

Атрибуту назначается следующий идентификатор:

    id-aa-ets-archiveTimestampV3 OBJECT IDENTIFIER ::= {
        itu-t(0) identified-organization(4)
        etsi(0) electronic-signature-standard(1733) attributes(2) 4
    }

Синтаксис атрибута описывается типом `ArchiveTimeStampToken`:

    ArchiveTimeStampToken ::= TimeStampToken

Входным значением при вычислении хэш-значения `messageImprint` штампа времени
является конкатенация хэш-значения от подписанных данных и определенных
элементов в закодированном виде, включая тег и длину, в порядке, перечисленном
ниже:

1. Компонент `SignedData.encapContentInfo.eContentType`.
2. Хэш-значение от исходного подписываемого документа. Хэш-значение вычисляется
для тех же исходных данных, что и хэш-значение, содержащееся в подписанном
атрибуте `MessageDigest`. Алгоритм хэширования ДОЛЖЕН совпадать с алгоритмом,
используемым при выработке штампа времени `ArchiveTimeStamp`. Идентификатор
алгоритма хэширования ДОЛЖЕН быть включен в компонент
`SignedData.digestAlgorithms`.
3. Компоненты `version`, `sid`, `digestAlgorithm`, `signedAttrs`,
`signatureAlgorithm` и `signature` внутри элемента `SignedData.signerInfos`, для
которого вырабатывается штамп времени, в указанном порядке.
4. Единственный элемент типа `ATSHashIndexV3`, содержащийся в атрибуте
`TimeStampValidationData`.

Штамп времени `ArchiveTimeStamp` ДОЛЖЕН содержать один неподписанный атрибут
`TimeStampValidationData`, использованный на шаге 4.

>Примечание 1 — Включение атрибута `TimeStampValidationData` на шаге 4
гарантирует, что все существенные компоненты РЭЦП защищены штампом времени.

>Примечание 2 — При проверке подписи атрибут `TimeStampValidationData` выступает
в качестве доказательства существования на момент выработки штампа времени всех
элементов, использованных при вычислении хэш-значения `messageImprint`. Это
гарантирует, что проверка подписи основана на аттестатах, которые действительно
существовали в прошлом.

>Примечание 3 — Удостоверяющие подписи, содержащиеся в неподписанном атрибуте
`Countersignature`, МОГУТ не содержать независимый атрибут `ArchiveTimeStamp`,
так как они защищены штампом времени `ArchiveTimeStamp` как неподписанные
атрибуты.

Перед формированием атрибута `ArchiveTimeStamp` структура `SignedData` ДОЛЖНА
быть дополнена всеми аттестатами, еще не включенными в структуру. Аттестаты
МОГУТ включать сертификаты, списки отзыва сертификатов, OCSP ответы, требуемые
для проверки всех подписанных объектов внутри РЭЦП, включая подписи, в том числе
удостоверяющие, штампы времени, OCSP ответы, сертификаты, атрибутные
сертификаты, подписанные утверждения и списки отзыва.

>Примечание 4 — Аттестаты, уже включенные в объект типа `SignedData`, например,
как часть штампа времени, не требуется включать повторно.

При создании атрибута `ArchiveTimeStamp` ДОЛЖНЫ использоваться отличительные
правила кодирования с сохранением кодирования любого подписанного элемента,
содержащегося в атрибуте. Кодовое представление также ДОЛЖНО быть сохранено для
всех существующих неподписанных атрибутов и компонентов, используемых при
вычислении хэш-значения `messageImprint` данного атрибута.



# 10 <a name="xades"></a>Формат XAdES

## 10.1 <a name="xades1"></a>Общие положения

Язык XML, определенный в базовой спецификации [[2]](#biblio.XML) и других
подчиненных ей, описывает иерархически организованные структуры данных,
называемые XML-документами. Документ содержит элементы, возможно вложенные друг
в друга, элементы могут иметь атрибуты. Структура элементов и атрибутов задается
XML-схемами.

Правила подписания XML-документов определены в [[5]](#biblio.XML-DSIG) и
представлены в СТБ 34.101.50 (приложение Е). Правила называются XML-DSig (от
англ. XML Digital Signature). Формат XAdES уточняет данные правила.

Атрибуты РЭЦП формата XAdES задаются XML-элементами, схемы которых определяются
либо непосредственно в XML-DSig, либо в [10.5](#xades5) – [10.8](#xades8).
Атрибуты объединяются в XML-контейнеры, описанные в [10.2](#xades2). Контейнер
содержит XML-элементы, сам являясь XML-элементом. В [10.3](#xades3) определяются
правила включения контейнеров атрибутов в РЭЦП.

Следует отличать атрибут подписи от атрибута XML-элемента. В настоящем разделе
под "атрибутом" понимается атрибут подписи, представленный XML-элементом. Термин
"XML-атрибут" относится к атрибуту XML-элемента.

Многие из определяемых далее XML-элементов содержат XML-атрибут `Id`. Этот
XML-атрибут идентифицирует элемент в пределах XML-документа и может
использоваться для ссылки на элемент из других частей документа.

Для однозначной глобальной идентификации элементов в XML используются
пространства имен. Пространство имен покрывает группу элементов с отличающимися
именами. Пространству назначается уникальный URI-идентификатор, который
выступает в роли имени пространства. URI-идентификатор добавляется к именам
элементов, определенных в пространстве, делая имена уникальными уже за пределами
пространства. В определении пространства может задаваться короткий префикс,
предназначенный для замены длинного идентификатора.

В XAdES используются следующие пространства имен: 

- http://uri.etsi.org/01903/v1.3.2#;
- http://uri.etsi.org/01903/v1.4.1#;
- http://www.w3.org/2000/09/xmldsig# (префикс `ds`);
- http://www.w3.org/2001/XMLSchema (префикс `xsd`).

В частности, в пространстве http://www.w3.org/2000/09/xmldsig# определены
элементы `ds:Object`, `ds:Signature` и `ds:Reference`, задействованные в XAdES.

Пространство имен, определенное URI-идентификатором
http://uri.etsi.org/01903/v1.3.2#, СЛЕДУЕТ вводить в XML-документ следующим
образом:
 
    <xsd:schema targetNamespace="http://uri.etsi.org/01903/v1.3.2#"
    xmlns:ds="http://www.w3.org/2000/09/xmldsig#" xmlns="http://uri.etsi.org/01903/v1.3.2#"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema" elementFormDefault="qualified">

Пространство имен, определенное URI-идентификатором 
http://uri.etsi.org/01903/v1.4.1#, СЛЕДУЕТ вводить в XML-документ следующим 
образом: 

    <xsd:schema targetNamespace="http://uri.etsi.org/01903/v1.4.1#"
    xmlns:ds="http://www.w3.org/2000/09/xmldsig#" xmlns="http://uri.etsi.org/01903/v1.4.1#"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xades="http://uri.etsi.org/01903/v1.3.2#"
    elementFormDefault="qualified">

Данные подписываются в два этапа. На первом этапе данные преобразуются в строку
октетов с помощью так называемых трансформаций. Трансформации состоят в
приведении данных к каноническому виду (канонизация), исключении базовой ЭЦП в
случае вложенной подписи, кодировании и др. Канонизация направлена на исключение
избыточности, присущей XML-документам: два логически эквивалентных документа
будут иметь один и тот же канонический вид. Некоторые атрибуты РЭЦП обеспечивают
опциональные возможности для указания алгоритма канонизации, используемого при
вычислении канонической формы. При создании новой РЭЦП, все такие атрибуты
ДОЛЖНЫ содержать идентификатор алгоритма канонизации.

При дополнении РЭЦП новым атрибутом, XML-схема которого предусматривает
идентификатор алгоритма канонизации, атрибут ДОЛЖЕН содержать этот
идентификатор.

## 10.2 <a name="xades2"></a>Контейнеры атрибутов

### 10.2.1 <a name="xades21"></a>Контейнер `QualifyingProperties`

Контейнер `QualifyingProperties` содержит атрибуты РЭЦП.

Синтаксис `QualifyingProperties` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->

    <xsd:element name="QualifyingProperties" type="QualifyingPropertiesType"/>

    <xsd:complexType name="QualifyingPropertiesType">
        <xsd:sequence>
            <xsd:element ref="SignedProperties" minOccurs="0"/>
            <xsd:element ref="UnsignedProperties" minOccurs="0"/>
        </xsd:sequence>
        <xsd:attribute name="Target" type="xsd:anyURI" use="required"/>
        <xsd:attribute name="Id" type="xsd:ID" use="optional"/>
    </xsd:complexType>  

Вложенные контейнеры `SignedProperties`, `UnsignedProperties` описываются 
в [10.2.2](#xades22), [10.2.3](#xades23).

XML-атрибут `Target` ссылается на XML-атрибут `Id` соответствующего элемента
`ds:Signature`.

XML-атрибут `Target` содержит URI с простым именем фрагмента XPointer. Если РЭЦП
оборачивает элемент `QualifyingProperties`, то часть XML-атрибута `Target`,
которая не является фрагментом XPointer, ДОЛЖНА быть пустой. В противном 
случае — НЕ ДОЛЖНА.

>Примечание — Простое имя (от англ. bare-name) — упрощенная форма записи 
фрагмента XPointer. Например, запись #Signature является простым именем 
для #xpointer(id("Signature")). 

РЭЦП НЕ ДОЛЖНА содержать пустой контейнер `QualifyingProperties`.

### 10.2.2 <a name="xades22"></a>Контейнер `SignedProperties`

Контейнер `SignedProperties`, вложенный в `QualifyingProperties`, 
содержит подписанные атрибуты РЭЦП. 

Синтаксис `SignedProperties` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->

    <xsd:element name="SignedProperties" type="SignedPropertiesType" />

    <xsd:complexType name="SignedPropertiesType">
        <xsd:sequence>
            <xsd:element ref="SignedSignatureProperties" minOccurs="0"/>
            <xsd:element ref="SignedDataObjectProperties" minOccurs="0"/>
        </xsd:sequence>
        <xsd:attribute name="Id" type="xsd:ID" use="optional"/>
    </xsd:complexType> 

Вложенные контейнеры `SignedSignatureProperties`, 
`SignedDataObjectProperties` описываются  в [10.2.4](#xades24), 
[10.2.5](#xades25).

РЭЦП НЕ ДОЛЖНА содержать пустой контейнер `SignedProperties`.

### 10.2.3 <a name="xades23"></a>Контейнер `UnsignedProperties`

Контейнер `UnsignedProperties`, вложенный в `QualifyingProperties`,
содержит неподписанные атрибуты РЭЦП.

Синтаксис `UnsignedProperties` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->

    <xsd:element name="UnsignedProperties" type="UnsignedPropertiesType" />

    <xsd:complexType name="UnsignedPropertiesType">
        <xsd:sequence>
            <xsd:element ref="UnsignedSignatureProperties" minOccurs="0"/>
            <xsd:element ref="UnsignedDataObjectProperties" minOccurs="0"/>
        </xsd:sequence>
        <xsd:attribute name="Id" type="xsd:ID" use="optional"/>
    </xsd:complexType> 

Вложенные контейнеры `UnsignedSignatureProperties`, 
`UnsignedDataObjectProperties` описываются  в [10.2.6](#xades26), 
[10.2.7](#xades27).

РЭЦП НЕ ДОЛЖНА содержать пустой контейнер `UnsignedProperties`. 

### 10.2.4 <a name="xades24"></a>Контейнер `SignedSignatureProperties`

Контейнер `SignedSignatureProperties`, вложенный в `SignedProperties`,
содержит атрибуты, которые описывают подпись или подписанта. 

Синтаксис `SignedSignatureProperties` определяется следующей XML-схемой: 

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#"-->

    <xsd:element name="SignedSignatureProperties"
    type="SignedSignaturePropertiesType" />

    <xsd:complexType name="SignedSignaturePropertiesType">
        <xsd:sequence>
            <xsd:element ref="SigningTime" minOccurs="0"/>
            <xsd:element ref="SigningCertificate" minOccurs="0"/>
            <xsd:element ref="SigningCertificateV2" minOccurs="0"/>
            <xsd:element ref="SignaturePolicyIdentifier" minOccurs="0"/>
            <xsd:element ref="SignatureProductionPlace" minOccurs="0"/>
            <xsd:element ref="SignatureProductionPlaceV2" minOccurs="0"/>
            <xsd:element ref="SignerRole" minOccurs="0"/>
            <xsd:element ref="SignerRoleV2" minOccurs="0"/>
            <xsd:any namespace="##other" minOccurs="0" maxOccurs="unbounded"/>
        </xsd:sequence>
        <xsd:attribute name="Id" type="xsd:ID" use="optional"/>
    </xsd:complexType> 

Вложенные элементы-атрибуты описываются в [10.5](#xades5). 
Элементы `SignatureProductionPlace` и `SignerRole` являются 
устаревшими, приводятся только для справки и НЕ ДОЛЖНЫ включаться в контейнер.

РЭЦП НЕ ДОЛЖНА содержать пустой контейнер `SignedSignatureProperties`.

### 10.2.5 <a name="xades25"></a>Контейнер `SignedDataObjectProperties`

Контейнер `SignedDataObjectProperties`, вложенный в `SignedProperties`,
содержит атрибуты, которые описывают объекты подписанного документа. 

Синтаксис `SignedDataObjectProperties` определяется следующей XML-схемой: 

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->

    <xsd:complexType name="SignedDataObjectPropertiesType">
        <xsd:sequence>
            <xsd:element ref="DataObjectFormat" minOccurs="0" maxOccurs="unbounded"/>
            <xsd:element ref="CommitmentTypeIndication" minOccurs="0"/>
            <xsd:element ref="AllDataObjectsTimeStamp" minOccurs="0" maxOccurs="unbounded"/>
            <xsd:element ref="IndividualDataObjectsTimeStamp" minOccurs="0" maxOccurs="unbounded"/>
            <xsd:any namespace="##other" minOccurs="0" maxOccurs="unbounded"/>
        </xsd:sequence>
        <xsd:attribute name="Id" type="xsd:ID" use="optional"/>
    </xsd:complexType>  

Вложенные элементы-атрибуты описываются в [10.5](#xades5).

РЭЦП НЕ ДОЛЖНА содержать пустой элемент `SignedDataObjectProperties`.

### 10.2.6 <a name="xades26"></a>Контейнер `UnsignedSignatureProperties`

Контейнер `UnsignedSignatureProperties`, вложенный в `UnsignedProperties`,
содержит атрибуты, которые описывают подпись или подписанта. 

Синтаксис `UnsignedSignatureProperties` определяется следующей XML-схемой: 

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->

    <xsd:element name="UnsignedSignatureProperties"
    type="UnsignedSignaturePropertiesType"/>

    <xsd:complexType name="UnsignedSignaturePropertiesType">
        <xsd:choice maxOccurs="unbounded">
            <xsd:element ref="CounterSignature" />
            <xsd:element ref="SignatureTimeStamp" />
            <xsd:element ref="CompleteCertificateRefs"/>
            <xsd:element ref="CompleteRevocationRefs"/>
            <xsd:element ref="AttributeCertificateRefs"/>
            <xsd:element ref="AttributeRevocationRefs" />
            <xsd:element ref="SigAndRefsTimeStamp" />
            <xsd:element ref="RefsOnlyTimeStamp" />
            <xsd:element ref="CertificateValues" />
            <xsd:element ref="RevocationValues"/>
            <xsd:element ref="AttrAuthoritiesCertValues" />
            <xsd:element ref="AttributeRevocationValues"/>
            <xsd:element ref="ArchiveTimeStamp" />
            <xsd:any namespace="##other"/>
        </xsd:choice>
        <xsd:attribute name="Id" type="xsd:ID" use="optional"/>
    </xsd:complexType>  

Вложенные элементы-атрибуты описываются в [10.5](#xades5) – [10.8](#xades8).

РЭЦП НЕ ДОЛЖНА содержать пустой элемент `UnsignedSignatureProperties`.

>Примечание — Некоторые элементы являются устаревшими. Поэтому ДОЛЖНЫ 
использоваться их аналоги из пространства имен с идентификатором 
"http://uri.etsi.org/01903/v1.4.1#".

### 10.2.7 <a name="xades27"></a>Контейнер `UnsignedDataObjectProperties`

Контейнер `UnsignedDataObjectProperties`, вложенный в `UnsignedProperties`,
содержит неподписанные атрибуты, которые описывают объекты подписанного
документа.

Синтаксис `UnsignedDataObjectProperties` определяется следующей XML-схемой: 
    
    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->

    <xsd:element name="UnsignedDataObjectProperties" type="UnsignedDataObjectPropertiesType"/>

    <xsd:complexType name="UnsignedDataObjectPropertiesType">
        <xsd:sequence>
            <xsd:element name="UnsignedDataObjectProperty" type="AnyType" maxOccurs="unbounded"/>
        </xsd:sequence>
        <xsd:attribute name="Id" type="xsd:ID" use="optional"/>
    </xsd:complexType>  

Вложенные элементы-атрибуты имеют тип `AnyType`, описанный в [10.4.1](#xades41).

РЭЦП НЕ ДОЛЖНА содержать пустой элемент `UnsignedDataObjectProperties`.

### 10.2.8 <a name="xades28"></a>Элемент `QualifyingPropertiesReference`

Элемент `QualifyingPropertiesReference` содержит ссылку на контейнер 
`QualifyingProperties`, который не является потомком элемента `ds:Signature` 
(например, хранится в другом XML-документе).

Синтаксис `QualifyingPropertiesReference` определяется следующей XML-схемой: 

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->

    <xsd:element name="QualifyingPropertiesReference"
    type="QualifyingPropertiesReferenceType"/>

    <xsd:complexType name="QualifyingPropertiesReferenceType">
        <xsd:attribute name="URI" type="xsd:anyURI" use="required"/>
        <xsd:attribute name="Id" type="xsd:ID" use="optional"/>
    </xsd:complexType>  

XML-атрибут `URI` содержит простое имя фрагмента XPointer и 
ссылается на контейнер `QualifyingProperties`. Часть данного XML-атрибута, 
которая не является фрагментом XPointer, ДОЛЖНА идентифицировать документ, 
в котором содержится контейнер, а фрагмент XPointer ДОЛЖЕН 
идентифицировать сам контейнер.

## 10.3 <a name="xades3"></a>Включение атрибутов в подпись

### 10.3.1 <a name="xades31"></a>Способы включения

Для включения атрибутов в РЭЦП используется элемент `ds:Object`. 
Включение выполняется двумя способами: 
 
1. Прямое включение. В элемент `ds:Object` вкладывается элемент 
`QualifyingProperties`.
2. Непрямое включение. В элемент `ds:Object` вкладывается один элемент или более
`QualifyingPropertiesReference`. Каждый из этих элементов содержит ссылку на
один элемент `QualifyingProperties`. При этом элемент `QualifyingProperties` НЕ
ДОЛЖЕН быть потомком элемента `ds:Signature`.

В РЭЦП базовых профилей элементы ДОЛЖНЫ включаться явно.

На включение накладываются следующие ограничения:

- все экземпляры `QualifyingProperties`, напрямую включенные в РЭЦП, и все 
экземпляры `QualifyingPropertiesReference` ДОЛЖНЫ содержаться в элементе 
`ds:Object`;
- в элементе `ds:Object` МОЖЕТ содержаться не более одного экземпляра 
`QualifyingProperties`; 
- все подписанные атрибуты ДОЛЖНЫ содержаться в одном элементе 
`QualifyingProperties`. При этом либо данный элемент ДОЛЖЕН быть дочерним для 
элемента `ds:Object` (прямое включение), либо на него должен ссылаться
элемент `QualifyingPropertiesReference` (непрямое включение);
- в элементе `ds:Object` МОЖЕТ содержаться любое число 
(в том числе ни одного) экземпляров `QualifyingPropertiesReference`.

Кроме элементов `ds:Object`, содержащих `QualifyingProperties` или 
`QualifyingPropertiesReference`, РЭЦП МОЖЕТ содержать элементы 
`ds:Object` с другим содержимым. Ограничения на порядок следования 
элементов `ds:Object` в элементе `ds:Signature`, представляющем РЭЦП, не 
накладываются.

### 10.3.2 <a name="xades32"></a>Подписанные атрибуты

Все подписанные атрибуты ДОЛЖНЫ быть дочерними для элемента `SignedProperties`,
вложенного в элемент `QualifyingProperties`.

Элемент `ds:Reference`, вложенный в РЭЦП, ДОЛЖЕН быть составлен таким образом,
чтобы элемент `SignedProperties` учитывался при вычислении хэш-значения.

Элемент `ds:Reference` ДОЛЖЕН включать XML-атрибут `Type` со значением
"http://uri.etsi.org/01903#SignedProperties". Это значение говорит о том, что
данные, использованные для вычисления хэш-значения, являются элементом
`SignedProperties`.

## 10.4 <a name="xades4"></a>Вспомогательные типы данных

### 10.4.1 <a name="xades41"></a>Тип `AnyType`

Тип `AnyType` описывает последовательность произвольных XML-элементов, которые
имеют неограниченную длину. В элементах типа допускается неограниченное число
XML-атрибутов.

Тип `AnyType` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->
  
    <xsd:element name="Any" type="AnyType"/>
   
    <xsd:complexType name="AnyType" mixed="true">  
        <xsd:sequence minOccurs="0" maxOccurs="unbounded">  
            <xsd:any namespace="##any" processContents="lax"/>  
        </xsd:sequence>  
        <xsd:anyAttribute namespace="##any"/>  
    </xsd:complexType>  

### 10.4.2 <a name="xades42"></a>Тип `ObjectIdentifierType`

Тип `ObjectIdentifierType` описывает уникальный постоянный идентификатор
объекта данных. Тип дополнительно поддерживает описание объекта и ссылки на
документы, в которых имеется дополнительная информация об объекте.

Тип `ObjectIdentifierType` определяется следующей XML-схемой:

     <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->

    <xsd:element name="ObjectIdentifier" type="ObjectIdentifierType"/>
  
    <xsd:complexType name="ObjectIdentifierType">  
        <xsd:sequence>  
            <xsd:element name="Identifier" type="IdentifierType"/>  
            <xsd:element name="Description" type="xsd:string" minOccurs="0"/>  
            <xsd:element name="DocumentationReferences"  
            type="DocumentationReferencesType" minOccurs="0"/>  
        </xsd:sequence>  
    </xsd:complexType>
  
    <xsd:complexType name="IdentifierType">  
        <xsd:simpleContent>  
            <xsd:extension base="xsd:anyURI">  
                <xsd:attribute name="Qualifier" type="QualifierType"  
                use="optional"/>  
            </xsd:extension>  
        </xsd:simpleContent>  
    </xsd:complexType>
  
    <xsd:simpleType name="QualifierType">  
        <xsd:restriction base="xsd:string">  
            <xsd:enumeration value="OIDAsURI"/>  
            <xsd:enumeration value="OIDAsURN"/>  
        </xsd:restriction>  
    </xsd:simpleType>
  
    <xsd:complexType name="DocumentationReferencesType">  
        <xsd:sequence maxOccurs="unbounded">  
            <xsd:element name="DocumentationReference" type="xsd:anyURI"/>  
        </xsd:sequence>  
    </xsd:complexType>  

Элемент `Identifier` содержит постоянный (неизменяемый) идентификатор.
Поддерживаются два механизма идентификации:

- объекту назначается URI-идентификатор. В этом случае 
элемент `Identifier` ДОЛЖЕН содержать URI-идентификатор, 
а XML-атрибут `Qualifier` НЕ ДОЛЖЕН присутствовать;
- объекту назначается идентификатор АСН.1. В этом случае 
значение элемента `Identifier` ДОЛЖНО содержать идентификатор АСН.1, 
закодированный как URI или как URN. Если идентификатор закодирован как 
URN, то XML-атрибут `Qualifier` ДОЛЖЕН принимать значение "OIDAsURN" и
ДОЛЖНЫ использоваться правила кодирования, установленные в 
[[20]](#biblio.URN). 
Если идентификатор закодирован как URI, который не является URN, 
то XML-атрибут `Qualifier` ДОЛЖЕН принимать значение "OIDAsURI". 

Если объекту назначен и идентификатор АСН.1, и URI-идентификатор, то в элементе
`Identifier` СЛЕДУЕТ отдавать предпочтение URI-идентификатору.

Элемент `Description` содержит неформальный текст, описывающий объект. 

Элемент `DocumetationReferences` содержит произвольное количество ссылок,
указывающих на пояснительную документацию по объекту данных.

### 10.4.3 <a name="xades43"></a>Тип `EncapsulatedPKIDataType`

Тип `EncapsulatedPKIDataType` используется для включения в РЭЦП 
аттестатов. 

Тип `EncapsulatedPKIDataType` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->
  
    <xsd:element name="EncapsulatedPKIData" type="EncapsulatedPKIDataType"/>
  
    <xsd:complexType name="EncapsulatedPKIDataType">  
      <xsd:simpleContent>  
        <xsd:extension base="xsd:base64Binary">  
          <xsd:attribute name="Id" type="xsd:ID" use="optional"/>  
          <xsd:attribute name="Encoding" type="xsd:anyURI" use="optional"/>  
        </xsd:extension>  
      </xsd:simpleContent>  
    </xsd:complexType> 

Тип инкапсулирует кодовое представление аттестата. Правила кодирования
определяются XML-атрибутом `Encoding`. Этот атрибут может принимать 
следующие значения: 

- "http://uri.etsi.org/01903/v1.2.2#DER" – аттестат представляет собой 
АСН.1-данные и для их кодирования используются отличительные правила; 
- "http://uri.etsi.org/01903/v1.2.2#BER" – аттестат представляет собой 
АСН.1-данные и для их кодирования используются базовые правила.

Отсутствие `Encoding` означает, что аттестат представляет собой 
АСН.1-данные, закодированные с помощью отличительных правил. 

Полученная в результате кодирования строка октетов кодируется еще раз 
по правилам Base64. 

### 10.4.4 <a name="xades44"></a>Типы данных для управления штампами времени

#### 10.4.4.1 <a name="xades441"></a>Тип `GenericTimeStampType`

Тип `GenericTimeStampType` является базовым для остальных типов, описывающих
штампы времени. Тип спроектирован так, что в РЭЦП можно включать штампы времени
как в формате СТБ 34.101.82, так и в формате XML. Можно включать несколько
штампов для одних и тех же данных (например, штампы времени выпущенные
различными службами). Штампы можно проставлять на элементы РЭЦП, объекты
подписанного документа, внешние данные. Можно указывать, какие элементы
покрывает штамп и как следует обрабатывать эти элементы, чтобы вычислить
хэш-значение, отсылаемое службе штампов времени.

Тип `GenericTimeStampType` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->
  
    <xsd:element name="Include" type="IncludeType"/>
  
    <xsd:complexType name="IncludeType">  
        <xsd:attribute name="URI" type="xsd:anyURI" use="required"/>  
        <xsd:attribute name="referencedData" type="xsd:boolean" use="optional"/>  
    </xsd:complexType>
  
    <xsd:element name="ReferenceInfo" type="ReferenceInfoType"/>
  
    <xsd:complexType name="ReferenceInfoType">  
        <xsd:sequence>  
            <xsd:element ref="ds:DigestMethod"/>  
            <xsd:element ref="ds:DigestValue"/>  
        </xsd:sequence>  
        <xsd:attribute name="Id" type="xsd:ID" use="optional"/>  
        <xsd:attribute name="URI" type="xsd:anyURI" use="optional"/>  
    </xsd:complexType>
  
    <xsd:complexType name="GenericTimeStampType" abstract="true">  
        <xsd:sequence>  
            <xsd:choice minOccurs="0">  
                <xsd:element ref="Include" minOccurs="0" maxOccurs="unbounded"/>  
                <xsd:element ref="ReferenceInfo" maxOccurs="unbounded"/>  
            </xsd:choice>  
            <xsd:element ref="ds:CanonicalizationMethod" minOccurs="0"/>  
            <xsd:choice maxOccurs="unbounded">  
                <xsd:element name="EncapsulatedTimeStamp" 
                type="EncapsulatedPKIDataType"/>  
                <xsd:element name="XMLTimeStamp" type="AnyType"/>  
            </xsd:choice>  
        </xsd:sequence>  
        <xsd:attribute name="Id" type="xsd:ID" use="optional"/>  
    </xsd:complexType>  

Элемент `ds:CanonicalizationMethod` определяет алгоритм канонизации
XML-элементов, которые покрывает штамп.

Элемент `EncapsulatedTimeStamp` содержит штамп времени в формате, определенном в
СТБ 34.101.82.

Элемент `XMLTimeStamp` содержит штамп времени в формате XML. 

#### 10.4.4.2 <a name="xades442"></a>Тип `XAdESTimeStampType`

Тип `XAdESTimeStampType` используется для включения в РЭЦП штампов времени,
проставленных на элементы РЭЦП и, возможно, подписанного документа.

Тип `XAdESTimeStampType` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->
  
    <xsd:element name="XAdESTimeStamp" type="XAdESTimeStampType"/>
  
    <xsd:complexType name="XAdESTimeStampType">  
        <xsd:complexContent>  
            <xsd:restriction base="GenericTimeStampType">  
                <xsd:sequence>  
                    <xsd:element ref="Include" minOccurs="0" maxOccurs="unbounded"/>  
                    <xsd:element ref="ds:CanonicalizationMethod" minOccurs="0"/>  
                    <xsd:choice maxOccurs="unbounded">  
                        <xsd:element name="EncapsulatedTimeStamp" type="EncapsulatedPKIDataType"/>  
                        <xsd:element name="XMLTimeStamp" type="AnyType"/>  
                    </xsd:choice>  
                </xsd:sequence>  
                <xsd:attribute name="Id" type="xsd:ID" use="optional"/>  
            </xsd:restriction>  
        </xsd:complexContent>  
    </xsd:complexType> 

Штампы времени, определенные в [10.5.8.1](#xades581), [10.6](#xades6),
[10.7.5](#xades75), [10.7.6](#xades76) и [10.8.2](#xades82), неявно определяют
покрытые ими элементы РЭЦП или подписанного документа.

Элемент `Include` определяет покрытие явно. Элемент содержит набор ссылок на
элементы, которые учитываются при вычислении хэш-значения, используемого в
дальнейшем при постановке штампа времени. Порядок ссылок задает порядок
следования элементов при их хэшировании.

Ссылка задается в XML-атрибуте `URI` элемента `Include`.

Если штамп времени и покрытый им элемент находятся в одном документе, то ссылка
ДОЛЖНА быть простым именем фрагмента XPointer.

Если штамп времени и покрытый им элемент находятся в разных документах, то
ссылка ДОЛЖНА представлять собой путь с простым именем фрагмента XPointer.

При этом если покрытый штампом элемент обернут РЭЦП, то основная (т.е. та,
которая не является фрагментом XPointer) часть ссылки ДОЛЖНА быть равна основной
части XML-атрибута `Target` элемента `QualifyingProperties`.

Если же покрытый штампом элемент не обернут РЭЦП, то основная часть ссылки
ДОЛЖНА быть равна основной части XML-атрибута `URI` элемента
`QualifyingPropertiesReference`, который ссылается на элемент
`QualifyingProperties`.

Если элемент, на который ссылается XML-атрибут `URI`, не является элементом
`ds:Reference`, то XML-атрибут `referencedData` НЕ ДОЛЖЕН включаться в
`Include`. В противном случае, XML-атрибут `referencedData` МОЖЕТ
включаться.

#### 10.4.4.3 <a name="xades443"></a>Тип `OtherTimeStampType`

Тип `OtherTimeStampType` описывает штампы времени на внешние объекты данных.

Тип `OtherTimeStampType` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->
  
    <xsd:element name="OtherTimeStamp" type="OtherTimeStampType"/>
  
    <xsd:complexType name="OtherTimeStampType">  
        <xsd:complexContent>  
            <xsd:restriction base="GenericTimeStampType">  
                <xsd:sequence>  
                    <xsd:element ref="ReferenceInfo" maxOccurs="unbounded"/>  
                    <xsd:element ref="ds:CanonicalizationMethod" minOccurs="0"/>  
                    <xsd:choice>  
                        <xsd:element name="EncapsulatedTimeStamp"  
                        type="EncapsulatedPKIDataType"/>  
                        <xsd:element name="XMLTimeStamp" type="AnyType"/>  
                    </xsd:choice>  
                </xsd:sequence>  
                <xsd:attribute name="Id" type="xsd:ID" use="optional"/>
            </xsd:restriction>
        </xsd:complexContent 
    </xsd:complexType>  

Каждый элемент `ReferenceInfo` содержит хэш-значение одного внешнего объекта
данных. Элемент `ds:DigestMethod` определяет используемый алгоритм хэширования.
Элемент `ds:DigestValue` содержит хэш-значение объекта данных. Хэш-значение
кодируется по правилам Base64.

## 10.5 <a name="xades5"></a>Базовые атрибуты

### 10.5.1 <a name="xades51"></a>Атрибут `SigningTime`

Атрибут `SigningTime` задается одноименным элементом.

Синтаксис элемента `SigningTime` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->

    <xsd:element name="SigningTime" type="xsd:dateTime"/>

### 10.5.2 <a name="xades52"></a>Атрибут `SigningCertificate`

В зависимости от используемого алгоритма хэширования атрибут
`SigningCertificate` задается одним из элементов: `SigningCertificate` или
`SigningCertificateV2`.

При использовании алгоритма хэширования SHA-1, ДОЛЖЕН использоваться элемент
`SigningCertificate`, синтаксис которого определяется следующей XML-схемой:

 <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->
  
    <xsd:element name="SigningCertificate" type="CertIDListType"/>
  
    <xsd:complexType name="CertIDListType">  
        <xsd:sequence>
            <xsd:element name="Cert" type="CertIDType" maxOccurs="unbounded"/>  
        </xsd:sequence>  
    </xsd:complexType>
  
    <xsd:complexType name="CertIDType">  
        <xsd:sequence>  
            <xsd:element name="CertDigest" type="DigestAlgAndValueType"/>  
            <xsd:element name="IssuerSerial" type="ds:X509IssuerSerialType"/>  
        </xsd:sequence>  
        <xsd:attribute name="URI" type="xsd:anyURI" use="optional"/>  
    </xsd:complexType>
  
    <xsd:complexType name="DigestAlgAndValueType">  
        <xsd:sequence>  
            <xsd:element ref="ds:DigestMethod"/>  
            <xsd:element ref="ds:DigestValue"/>  
        </xsd:sequence>  
    </xsd:complexType>  

При использовании алгоритмов хэширования, отличных от SHA-1, ДОЛЖЕН
использоваться элемент `SigningCertificateV2`, синтаксис которого определяется
следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->
  
    <xsd:element name="SigningCertificateV2" type="CertIDListV2Type"/>
  
    <xsd:complexType name="CertIDListV2Type">  
        <xsd:sequence>
            <xsd:element name="Cert" type="CertIDTypeV2" maxOccurs="unbounded"/>  
        </xsd:sequence>  
    </xsd:complexType>
  
    <xsd:complexType name="CertIDTypeV2">  
        <xsd:sequence>  
            <xsd:element name="CertDigest" type="DigestAlgAndValueType"/>  
            <xsd:element name="IssuerSerialV2" type="xsd:base64Binary" minOccurs="0"/>  
        </xsd:sequence>  
        <xsd:attribute name="URI" type="xsd:anyURI" use="optional"/>  
    </xsd:complexType>
  
    <xsd:complexType name="DigestAlgAndValueType">  
        <xsd:sequence>  
            <xsd:element ref="ds:DigestMethod"/>  
            <xsd:element ref="ds:DigestValue"/>  
        </xsd:sequence>  
    </xsd:complexType>  

Элемент `CertDigest` содержит хэш-значение целевого сертификата. При этом
вложенный в `CertDigest` элемент `DigestMethod` определяет алгоритм хэширования,
а вложенный элемент `DigestValue` – хэш-значение сертификата, закодированное по
правилам Base64.

Элемент `IssuerSerialV2` содержит кодовое представление экземпляра типа
`IssuerSerial`. При кодировании сначала применяются отличительные правила (DER),
а затем правила Base64.

XML-атрибут `URI` содержит ссылку, по которой размещается целевой сертификат.
Ссылка не является обязательной, поскольку существуют и другие способы получения
сертификата.

Подписант НЕ ДОЛЖЕН создавать XML-атрибут `URI` для дочерних элементов элемента
`Cert`.

Ссылки на сертификаты НЕ ДОЛЖНЫ содержать элемент `IssuerSerialV2`.

>Примечание — Введение двух элементов для описания атрибута `SigningCertificate`
позволяет устранить недостатки при изначальном проектировании и поддержать
совместимость с устаревшими реализациями. В тех случаях когда совместимость не
нужна, следует избегать использования в атрибуте алгоритма хэширования SHA-1,
признанного криптографически нестойким.

### 10.5.3 <a name="xades53"></a>Атрибут `CommitmentTypeIndication`

Атрибут `CommitmentTypeIndication` задается одноименным элементом.

Синтаксис `CommitmentTypeIndication` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->

    <xsd:element name="CommitmentTypeIndication" type="CommitmentTypeIndicationType"/>
  
    <xsd:complexType name="CommitmentTypeIndicationType">  
        <xsd:sequence>  
            <xsd:element name="CommitmentTypeId"  
            type="ObjectIdentifierType"/>  
            <xsd:choice>  
                <xsd:element name="ObjectReference" type="xsd:anyURI"  
                maxOccurs="unbounded"/>  
                <xsd:element name="AllSignedDataObjects"/>  
            </xsd:choice>  
            <xsd:element name="CommitmentTypeQualifiers"  
            type="CommitmentTypeQualifiersListType" minOccurs="0"/>  
        </xsd:sequence>  
    </xsd:complexType>
  
    <xsd:complexType name="CommitmentTypeQualifiersListType">  
        <xsd:sequence>  
            <xsd:element name="CommitmentTypeQualifier"  
            type="AnyType" minOccurs="0" maxOccurs="unbounded"/>  
        </xsd:sequence>  
    </xsd:complexType>  

Элемент `CommitmentTypeId` описывает обязательство подписанта. Вложенный элемент
`Identifier` содержит URI-идентификатор обязательства. При этом элемент
`Identifier` НЕ ДОЛЖЕН иметь XML-атрибута `Qualifier`, т.е. URI-идентификатор НЕ
ДОЛЖЕН представлять идентификатор АСН.1.

Каждый элемент `ObjectReference` ссылается на один элемент `ds:Reference` внутри
элемента `ds:SignedInfo` или `ds:Manifest`.

Если обязательство касается только части подписанных данных, то элемент
`CommitmentTypeIndication` ДОЛЖЕН содержать элемент `ObjectReference` для
каждого из объектов подписанных данных, на которые направлено данное
обязательство. Если обязательство направлено на все подписанные данные, то
элемент `CommitmentTypeIndication` ДОЛЖЕН содержать один пустой элемент
`AllSignedDataObjects` или по одному элементу `ObjectReference` для каждого из
объектов подписанных данных, кроме элемента `SignedProperties`.

Элемент `CommitmentTypeQualifiers` позволяет задать дополнительную информацию об
обязательстве.

### 10.5.4 <a name="xades54"></a>Атрибут `DataObjectFormat`

Атрибут `DataObjectFormat` задается одноименным элементом.

Синтаксис `DataObjectFormat` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->

    <xsd:element name="DataObjectFormat" type="DataObjectFormatType"/>

    <xsd:complexType name="DataObjectFormatType">
        <xsd:sequence>
            <xsd:element name="Description" type="xsd:string" minOccurs="0"/>
            <xsd:element name="ObjectIdentifier" type="ObjectIdentifierType"
            minOccurs="0"/>
            <xsd:element name="MimeType" type="xsd:string" minOccurs="0"/>
            <xsd:element name="Encoding" type="xsd:anyURI" minOccurs="0"/>
        </xsd:sequence>
        <xsd:attribute name="ObjectReference" type="xsd:anyURI"
        use="required"/>
    </xsd:complexType>

Элемент `Description` содержит текстовую информацию, связанную с целевым
объектом.

Элемент `ObjectIdentifier` содержит идентификатор типа целевого объекта.
Идентификатор назначается службой, которая объявляла тип.

Элемент `MimeType` описывает MIME-тип целевого объекта. 

Элемент `Encoding` описывает кодировку целевого объекта. 

Элемент `DataObjectFormat` ДОЛЖЕН содержать, по крайней мере, один из элементов
`Description`, `ObjectIdentifier` или `MimeType`.

XML-атрибут `ObjectReference` ссылается на элемент `ds:Reference`, вложенный в
`ds:SignedInfo`, или на подписанный элемент `ds:Manifest`, ссылающийся на
целевой объект.

Если элемент `DataObjectFormat` ссылается на элемент `ds:Reference`, который в
свою очередь ссылается на элемент `ds:Object`, и если этот элемент `ds:Object`
содержит элемент `MimeType` и атрибут `Encoding`, то этот элемент `MimeType` и
XML-атрибут ДОЛЖНЫ иметь одинаковые значения.

Для каждого целевого объекта, кроме элемента `SignedProperties`, ДОЛЖЕН быть
создан один элемент `DataObjectFormat`.

Элемент `DataObjectFormat` ДОЛЖЕН содержать:

- не более одного экземпляра `Description`;
- не более одного экземпляра `ObjectIdentifier`;
- ровно один экземпляр `MimeType`;
- не более одного экземпляра `Encoding`;
- ровно один экземпляр `ObjectReference`.

### 10.5.5 <a name="xades55"></a>Атрибут `SignerLocation`

Атрибут `SignerLocation` задается элементом `SignatureProductionPlaceV2`.

Синтаксис `SignatureProductionPlaceV2` определяется следующей XML-схемой: 

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->
  
    <xsd:element name="SignatureProductionPlaceV2"   type="SignatureProductionPlaceV2Type"/>
  
    <xsd:complexType name="SignatureProductionPlaceV2Type">  
        <xsd:sequence>  
            <xsd:element name="City" type="xsd:string" minOccurs="0"/>  
            <xsd:element name="StreetAddress" type="xsd:string" minOccurs="0"/>  
            <xsd:element name="StateOrProvince" type="xsd:string" minOccurs="0"/>  
            <xsd:element name="PostalCode" type="xsd:string" minOccurs="0"/>  
            <xsd:element name="CountryName" type="xsd:string" minOccurs="0"/>  
        </xsd:sequence>  
    </xsd:complexType>  

Пустой элемент `SignatureProductionPlaceV2` НЕ ДОЛЖЕН включаться в РЭЦП.

### 10.5.6 <a name="xades56"></a>Атрибут `SignerAttributes`

Атрибут `SignerAttributes` задается элементом `SignerRoleV2`.

Синтаксис `SignerRoleV2` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->
  
    <xsd:element name="SignerRoleV2" type="SignerRoleV2Type"/>
  
    <xsd:complexType name="SignerRoleV2Type">  
        <xsd:sequence>  
            <xsd:element ref="ClaimedRoles" minOccurs="0"/>  
            <xsd:element ref="CertifiedRolesV2" minOccurs="0"/>  
            <xsd:element ref="SignedAssertions" minOccurs="0"/>  
        </xsd:sequence>  
    </xsd:complexType>
  
    <xsd:element name="ClaimedRoles" type="ClaimedRolesListType"/>  
    <xsd:element name="CertifiedRolesV2" type="CertifiedRolesListTypeV2"/>  
    <xsd:element name="SignedAssertions" type="SignedAssertionsListType"/>
  
    <xsd:complexType name="ClaimedRolesListType">  
        <xsd:sequence>  
            <xsd:element name="ClaimedRole" type="AnyType" maxOccurs="unbounded"/>  
        </xsd:sequence>  
    </xsd:complexType>
  
    <xsd:complexType name="CertifiedRolesListTypeV2">  
        <xsd:sequence>  
            <xsd:element name="CertifiedRole" type="CertifiedRoleTypeV2"   maxOccurs="unbounded"/>  
        </xsd:sequence>  
    </xsd:complexType>
  
    <xsd:complexType name="CertifiedRoleTypeV2">  
        <xsd:choice>  
            <xsd:element ref="X509AttributeCertificate"/>  
            <xsd:element ref="OtherAttributeCertificate"/>  
        </xsd:choice>  
    </xsd:complexType>
  
    <xsd:element name="X509AttributeCertificate" type="EncapsulatedPKIDataType"/>  
    <xsd:element name="OtherAttributeCertificate" type="AnyType"/>
  
    <xsd:complexType name="SignedAssertionsListType">  
        <xsd:sequence>  
            <xsd:element ref="SignedAssertion" maxOccurs="unbounded"/>  
        </xsd:sequence>  
    </xsd:complexType>
  
    <xsd:element name="SignedAssertion" type="AnyType"/>  

Элемент `ClaimedRoles` содержит непустую последовательность ролей, заявленную
пользователем, но не заверенную.

Элемент `CertifiedRolesV2` содержит непустую последовательность заверенных ролей
пользователя. Заверенные роли представляют собой атрибутные сертификаты.
Сертификаты СТБ 34.101.67 ДОЛЖНЫ кодироваться по правилам Base64 и размещаться в
элементе `X509AttributeCertificate`. Атрибутные сертификаты других типов должны
размещаться в `OtherAttributeCertificate`. Их содержание выходит за рамки
настоящего стандарта.

Элемент `SignedAssertions` содержит непустую последовательность утверждений,
подписанных некоторым поставщиком услуг доверия. Подписанное утверждение
сильнее, чем заявленная роль, но слабее, чем атрибутный сертификат. Содержание
`SignedAssertions` выходит за рамки настоящего стандарта.

Пустой элемент `SignerRoleV2` не ДОЛЖЕН создаваться.

### 10.5.7 <a name="xades57"></a>Контрподписи

### 10.5.7.1 <a name="xades571"></a>Контрподпись с идентификатором

Контрподписи назначается URI-идентификатор 
<a name="http://uri.etsi.org/01903#CountersignedSignature">"http://uri.etsi.org/01903#CountersignedSignature"</a>. 
Если РЭЦП содержит элемент `ds:Reference`, в XML-атрибуте `Type` которого 
указан данный идентификатор, то РЭЦП является контрподписью, а элемент 
`ds:Reference` при этом ссылается на основную подпись.

Элемент `ds:Reference` контрподписи ДОЛЖЕН быть построен так, чтобы подписывался
элемент `ds:SignatureValue` основной подписи. При обработке `ds:Reference`
ДОЛЖНЫ применяться все правила XML-DSig.

### 10.5.7.2 <a name="xades572"></a>Атрибут `CounterSignature`

Атрибут `CounterSignature` задается одноименным элементом.

Синтаксис `CounterSignature` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->

    <xsd:element name="CounterSignature" type="CounterSignatureType" />

    <xsd:complexType name="CounterSignatureType">
        <xsd:sequence>
            <xsd:element ref="ds:Signature"/>
        </xsd:sequence>
    </xsd:complexType>

Элемент `CounterSignature` содержит подпись в формате XML-DSig или XAdES. В этой
подписи элемент `ds:SignedInfo` ДОЛЖЕН содержать один элемент `ds:Reference`,
ссылающийся на элемент `ds:SignatureValue` из РЭЦП, для которой создается данная
контрподпись.

Элемент `ds:DigestValue` вышеупомянутого элемента `ds:Reference` контрподписи
содержит хэш-значение полного (и канонизированного) элемента `ds:SignatureValue`
(т.е. включая открывающий и закрывающий теги). Хэш-значение кодируется по
правилам Base64.

Элемент `CounterSignature` дополнительно к ссылке на элемент `ds:SignatureValue`
РЭЦП может содержать ссылки на другие объекты, например, на элементы
`ds:SignatureValue` других контрподписей, включенных в РЭЦП.

### 10.5.8 <a name="xades58"></a>Штампы времени на объекты данных

#### 10.5.8.1 <a name="xades581"></a>Атрибут `AllDataObjectsTimeStamp`

Атрибут `AllDataObjectsTimeStamp` задается одноименным элементом.

Синтаксис `AllDataObjectsTimeStamp` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->

    <xsd:element name="AllDataObjectsTimeStamp" type="XAdESTimeStampType"/>

Элемент `AllDataObjectsTimeStamp` описывает штамп времени от всех элементов
`ds:Reference` внутри элемента `ds:SignedInfo`, кроме одного, ссылающегося на
элемент `SignedProperties`. Покрытые элементы ДОЛЖНЫ описываться в штампе
неявно.

Покрытые элементы ДОЛЖНЫ обрабатываться в порядке их появления. ДОЛЖНА
применяться модель обработки ссылок, определенная в [[5]](#biblio.XML-DSIG).
После обработки (перед хэшированием) элементы ДОЛЖНЫ канонизироваться.

#### 10.5.8.2 <a name="xades582"></a>Атрибут `IndividualDataObjectsTimeStamp`

Атрибут `IndividualDataObjectsTimeStamp` задается одноименным элементом. 

Синтаксис `IndividualDataObjectsTimeStamp` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->

    <xsd:element name="IndividualDataObjectsTimeStamp" type="XAdESTimeStampType"/>

Элемент `IndividualDataObjectsTimeStamp` описывает штамп времени от объектов
данных, заданных явно во вложенных в штамп элементах `Include`. Элементы
`Include` ДОЛЖНЫ содержать ссылки на те элементы `ds:Reference`, которые
ссылаются на целевые объекты данных.

В каждом элементе `Include` ДОЛЖЕН присутствовать XML-атрибут `referencedData`
со значением "true".

Обработка данных перед хэшированием выполняется так же, как в 
[10.5.8.1](#xades581). 

## 10.5.9 <a name="xades59"></a>Атрибут `SignaturePolicyIdentifier`

### 10.5.9.1 <a name="xades591"></a>Синтаксис

Атрибут `SignaturePolicyIdentifier` задается одноименным элементом.

Синтаксис `SignaturePolicyIdentifier` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->

    <xsd:element name="SignaturePolicyIdentifier" type="SignaturePolicyIdentifierType"/>

    <xsd:complexType name="SignaturePolicyIdentifierType">
        <xsd:choice>
            <xsd:element name="SignaturePolicyId" type="SignaturePolicyIdType"/>
            <xsd:element name="SignaturePolicyImplied"/>
        </xsd:choice>
    </xsd:complexType>

    <xsd:complexType name="SignaturePolicyIdType">
        <xsd:sequence>
            <xsd:element name="SigPolicyId" type="ObjectIdentifierType"/>
            <xsd:element ref="ds:Transforms" minOccurs="0"/>
            <xsd:element name="SigPolicyHash" type="DigestAlgAndValueType"/>
            <xsd:element name="SigPolicyQualifiers"
            type="SigPolicyQualifiersListType" minOccurs="0"/>
        </xsd:sequence>
    </xsd:complexType>

    <xsd:complexType name="SigPolicyQualifiersListType">
        <xsd:sequence>
            <xsd:element name="SigPolicyQualifier" type="AnyType"
            maxOccurs="unbounded"/>
        </xsd:sequence>
    </xsd:complexType>

Элемент `SignaturePolicyId` используется для ссылки на политику подписи в явном
виде. Пустой элемент `SignaturePolicyImplied` используется для неявной ссылки на
политику подписи. Элемент указывает на то, что подписанные данные и другие
внешние объекты подразумевают определенную политику подписи.

Элемент `SigPolicyId` идентифицирует конкретную версию политики подписи.

Элемент `ds:Transforms` содержит преобразования, выполненные над документом
политики подписи, перед вычислением хэш-значения. Модель обработки для данных
преобразований (трансформаций) ДОЛЖНА определяться в соответствии с
[[5]](#biblio.XML-DSIG).

Элемент `SigPolicyHash` содержит идентификатор алгоритма хэширования и
хэш-значение, полученное после обработки элементов `SigPolicyId` и, если
присутствует, `ds:Transforms`.

### 10.5.9.2 <a name="xades592"></a>Квалификаторы политики подписи

Определены три квалификатора политики подписи:

- URL, по которому можно получить копию политики подписи. Задается 
элементом `SPURI`;
- уведомление, предъявляемое пользователю при каждой проверке подписи. 
Задается элементом `SPUserNotice`; 
- идентификатор технической спецификации, определяющий синтаксис
документа с описанием политики подписи. Задается элементом 
`SPDocSpecification`. 

Синтаксис элементов `SPURI` и `SPUserNotice` определяется следующей
XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->

    <xsd:element name="SPURI" type="xsd:anyURI"/>
    <xsd:element name="SPUserNotice" type="SPUserNoticeType"/>

    <xsd:complexType name="SPUserNoticeType">
        <xsd:sequence>
            <xsd:element name="NoticeRef" type="NoticeReferenceType"
            minOccurs="0"/>
            <xsd:element name="ExplicitText" type="xsd:string"
            minOccurs="0"/>
        </xsd:sequence>
    </xsd:complexType>

    <xsd:complexType name="NoticeReferenceType">
        <xsd:sequence>
            <xsd:element name="Organization" type="xsd:string"/>
            <xsd:element name="NoticeNumbers" type="IntegerListType"/>
        </xsd:sequence>
    </xsd:complexType>

    <xsd:complexType name="IntegerListType">
        <xsd:sequence>
            <xsd:element name="int" type="xsd:integer" minOccurs="0"
            maxOccurs="unbounded"/>
        </xsd:sequence>
    </xsd:complexType>

Элемент `ExplicitText` содержит текст отображаемого уведомления.

Элемент `NoticeRef` содержит название организации (элемент `Organization`) и
идентифицирует по номерам (элемент `NoticeNumbers`) уведомления, созданные этой
организацией.

Синтаксис элемента `SPDocSpecification` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.4.1#"-->

    <xsd:element name="SPDocSpecification" type="xades:ObjectIdentifierType"/>
     
### 10.5.10 <a name="xades510"></a>Атрибут `SignaturePolicyStore`

Атрибут `SignaturePolicyStore` задается одноименным элементом.

Синтаксис `SignaturePolicyStore` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.4.1#" -->
  
    <xsd:element name="SignaturePolicyStore" type="SignaturePolicyStoreType"/>
  
    <xsd:complexType name="SignaturePolicyStoreType">  
        <xsd:sequence>  
            <xsd:element ref="SPDocSpecification"/>  
            <xsd:choice>  
                <xsd:element name="SignaturePolicyDocument" type="xsd:base64Binary"/>  
                <xsd:element name="SigPolDocLocalURI" type="xsd:anyURI"/>  
            </xsd:choice>  
        </xsd:sequence>  
    </xsd:complexType>  

Элемент `SignaturePolicyDocument` содержит документ, определяющий политику
подписи. Документ кодируется по правилам Base64.

Элемент `SigPolDocLocalURI` содержит URI-идентификатор, который ссылается на
локальное хранилище, в котором размещен документ с политикой подписи. В отличие
от `SPuri`, `SigPolDocLocalURI` указывает на локальный файл.

Элемент `SPDocSpecification` указывает на техническую спецификацию, определяющую
синтаксис политики подписи.

Атрибут `SignaturePolicyStore` может включаться в подпись, только если включен
атрибут `SignaturePolicyIdentifier` и в его элементе `SigPolicyHash` указано
хэш-значение документа с политикой подписи. Если условия не выполнены, то
атрибут `SignaturePolicyStore` НЕ ДОЛЖЕН включаться в подпись.

### 10.6 <a name="xades6"></a>Атрибут `SignatureTimeStamp`

Синтаксис элемента `SignatureTimeStamp` определяется следующей XML-схемой: 

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->

    <xsd:element name="SignatureTimeStamp" type="XAdESTimeStampType"/>

Элемент описывает штамп времени от элемента `ds:SignatureValue`. 
Покрытый элемент ДОЛЖЕН описываться в штампе неявно.

## 10.7 <a name="xades7"></a>Атрибуты-аттестаты

### 10.7.1 <a name="xades71"></a>Атрибут `CompleteCertificateReferences`

Атрибут `CompleteCertificateReferences` задается элементом 
`CompleteCertificateRefsV2`.

Синтаксис `CompleteCertificateRefsV2` определяется следующей XML-схемой: 

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.4.1#" -->

    <xsd:element name="CompleteCertificateRefsV2" type="xades:CertIDListV2Type"/>

Если атрибут включен в подпись, то все указанные в нем сертификаты
ДОЛЖНЫ присутствовать либо в элементе `ds:KeyInfo`, либо в атрибуте 
`CertificateValues`.

### 10.7.2 <a name="xades72"></a>Атрибут `CompleteRevocationReferences`

Атрибут `CompleteRevocationReferences` задается элементом 
`CompleteRevocationRefs`. 

Синтаксис `CompleteRevocationRefs` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->

    <xsd:element name="CompleteRevocationRefs"
    type="CompleteRevocationRefsType"/>

    <xsd:complexType name="CompleteRevocationRefsType">
        <xsd:sequence>
            <xsd:element name="CRLRefs" type="CRLRefsType" minOccurs="0"/>
            <xsd:element name="OCSPRefs" type="OCSPRefsType" minOccurs="0"/>
            <xsd:element name="OtherRefs" type="OtherCertStatusRefsType"
            minOccurs="0"/>
        </xsd:sequence>
        <xsd:attribute name="Id" type="xsd:ID" use="optional"/>
    </xsd:complexType>

    <xsd:complexType name="CRLRefsType">
        <xsd:sequence>
            <xsd:element name="CRLRef" type="CRLRefType"
            maxOccurs="unbounded"/>
        </xsd:sequence>
    </xsd:complexType>

    <xsd:complexType name="CRLRefType">
        <xsd:sequence>
            <xsd:element name="DigestAlgAndValue"
            type="DigestAlgAndValueType"/>
            <xsd:element name="CRLIdentifier" type="CRLIdentifierType"
            minOccurs="0"/>
        </xsd:sequence>
    </xsd:complexType>

    <xsd:complexType name="CRLIdentifierType">
        <xsd:sequence>
            <xsd:element name="Issuer" type="xsd:string"/>
            <xsd:element name="IssueTime" type="xsd:dateTime" />
            <xsd:element name="Number" type="xsd:integer" minOccurs="0"/>
        </xsd:sequence>
        <xsd:attribute name="URI" type="xsd:anyURI" use="optional"/>
    </xsd:complexType>

    <xsd:complexType name="OCSPRefsType">
        <xsd:sequence>
            <xsd:element name="OCSPRef" type="OCSPRefType"
            maxOccurs="unbounded"/>
        </xsd:sequence>
    </xsd:complexType>

    <xsd:complexType name="OCSPRefType">
        <xsd:sequence>
            <xsd:element name="OCSPIdentifier" type="OCSPIdentifierType"/>
            <xsd:element name="DigestAlgAndValue"
            type="DigestAlgAndValueType"
            minOccurs="0"/>
        </xsd:sequence>
    </xsd:complexType>

    <xsd:complexType name="ResponderIDType">
        <xsd:choice>
            <xsd:element name="ByName" type="xsd:string"/>
            <xsd:element name="ByKey" type="xsd:base64Binary"/>
        </xsd:choice>
    </xsd:complexType>

    <xsd:complexType name="OCSPIdentifierType">
        <xsd:sequence>
            <xsd:element name="ResponderID" type="ResponderIDType"/>
            <xsd:element name="ProducedAt" type="xsd:dateTime"/>
        </xsd:sequence>
        <xsd:attribute name="URI" type="xsd:anyURI" use="optional"/>
    </xsd:complexType>

    <xsd:complexType name="OtherCertStatusRefsType">
        <xsd:sequence>
            <xsd:element name="OtherRef" type="AnyType"
            maxOccurs="unbounded"/>
        </xsd:sequence>
    </xsd:complexType>

Пустой атрибут `CompleteRevocationRefs` НЕ ДОЛЖЕН включаться в подпись.

Элемент `CRLRefs` содержит последовательность ссылок на СОС. 

Каждый элемент `CRLRef`, дочерний для `CRLRefs`, содержит ссылку на СОС. 

Вложенный в `CRLRef` элемент `DigestAlgAndValue` содержит идентификатор
алгоритма хэширования и хэш-значение СОС. Хэш-значение кодируется по правилам
Base64. Перед хэшированием СОС кодируется по отличительным правилам (DER).

Вложенный в `CRLRef` элемент `CRLIdentifier` содержит имя эмитента в элементе
`Issuer`, время создания СОС в элементе `IssueTime` и номер СОС в необязательном
элементе `Number`.

XML-атрибут `URI` элемента `CRLRef` является адресом, по которому можно получить
СОС.

Если один или более из указанных СОС является ПСОС, то атрибут
`CompleteRevocationRefs` содержит ссылки на все СОС, необходимые для
формирования полного списка.

Элемент `OCSPRefs` содержит последовательность ссылок на OCSP-ответы. Каждый
элемент `OCSPRef`, вложенный в `OCSPRefs`, содержит одну ссылку на один
OCSP-ответ.

Вложенный в `OCSPRef` элемент `OCSPIdentifier` содержит идентификатор
OCSP-сервера в элементе `ResponderID`. Если OCSP-сервер идентифицируется по
имени, то это имя включается в элемент `ByName`, дочерний для `ResponderID`.

### 10.7.3 <a name="xades73"></a>Атрибут `AttributeCertificateReferences`

Атрибут `AttributeCertificateReferences` задается элементом 
`AttributeCertificateRefsV2`.

Синтаксис `AttributeCertificateRefsV2` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.4.1#"-->

    <xsd:element name="AttributeCertificateRefsV2" type="xades:CertIDListV2Type"/>

### 10.7.4 <a name="xades74"></a>Атрибут `AttributeRevocationReferences`

Атрибут `AttributeRevocationReferences` задается элементом 
`AttributeRevocationRefs`.

Синтаксис `AttributeRevocationRefs` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->

    <xsd:element name="AttributeRevocationRefs" type="CompleteRevocationRefsType"/>
    
### 10.7.5 <a name="xades75"></a>Атрибут `SigAndRefsTimeStamp`

Атрибут `SigAndRefsTimeStamp` задается элементом `SigAndRefsTimeStampV2`. 

Синтаксис `SigAndRefsTimeStampV2` определяется следующей XML-схемой: 

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.4.1#"-->

    <xsd:element name="SigAndRefsTimeStampV2" type="xades:XAdESTimeStampType"/>

Элемент `SigAndRefsTimeStampV2` описывает штамп времени, который покрывает
следующие элементы РЭЦП:

- элемент `ds:SignatureValue`; 
- все атрибуты `SignatureTimeStamp`, входящие в РЭЦП;
- атрибут `СompleteCertificateReferences`; 
- атрибут `CompleteRevocationReferences`;
- атрибут `AttributeCertificateReferences` (если присутствует);
- атрибут `AttributeRevocationReferences` (если присутствует).

Покрытые элементы ДОЛЖНЫ хэшироваться в том порядке, в котором они указаны выше.
Перед хэшированием каждый из элементов ДОЛЖЕН канонизироваться.

Если штамп `SigAndRefsTimeStampV2` и все неподписанные атрибуты, на которые он
проставлен, имеют общий родительский элемент, то покрытые элементы ДОЛЖНЫ
описываться в штампе неявно. Хэш-значение штампа ДОЛЖНО вычисляться от элемента
`ds:SignatureValue` и тех элементов, которые встречаются до штампа.

Если штамп `SigAndRefsTimeStampV2` и некоторые неподписанные атрибуты, на
которые он проставлен, не имеют общего родительского элемента, то ссылка на
`ds:SignatureValue` ДОЛЖНА задаваться неявно, а ссылки на все остальные элементы
– явно, с помощью вложенных в штамп элементов `Include`.

### 10.7.6 <a name="xades76"></a>Атрибут `RefsOnlyTimeStamp`

Атрибут `RefsOnlyTimeStamp` задается элементом `RefsOnlyTimeStampV2`. 

Синтаксис `RefsOnlyTimeStampV2` определяется следующей XML-схемой: 

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.4.1#"-->

    <xsd:element name="RefsOnlyTimeStampV2" type="xades:XAdESTimeStampType"/>

Элемент `RefsOnlyTimeStampV2` описывает штамп времени, который покрывает
следующие элементы РЭЦП:

- все атрибуты `SignatureTimeStamp`, присутствующие в РЭЦП;
- атрибут `СompleteCertificateReferences`; 
- атрибут `CompleteRevocationReferences`;
- атрибут `AttributeCertificateReferences` (если присутствует);
- атрибут `AttributeRevocationReferences`  (если присутствует).

Покрытые элементы ДОЛЖНЫ хэшироваться в том порядке, в котором они указаны выше.
Перед хэшированием каждый из элементов ДОЛЖЕН канонизироваться.

Если штамп `RefsOnlyTimeStampV2` и все неподписанные атрибуты, на которые он
проставлен, имеют общий родительский элемент, то покрытые элементы ДОЛЖНЫ
описываться в штампе неявно. Хэш-значение штампа ДОЛЖНО вычисляться от элемента
`ds:SignatureValue` и тех элементов, которые встречаются до штампа.

Если штамп `RefsOnlyTimeStampV2` и некоторые неподписанные атрибуты, на которые
он проставлен, не имеют общего родительского элемента, то ссылки на атрибуты
ДОЛЖНЫ задаваться явно, с помощью вложенных в штамп элементов `Include`.

### 10.7.7 <a name="xades77"></a>Атрибут `CertificateValues`

Атрибут `CertificateValues` задается одноименным элементом.

Синтаксис `CertificateValues` определяется следующей XML-схемой: 

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->
  
    <xsd:element name="CertificateValues" type="CertificateValuesType"/>
  
    <xsd:complexType name="CertificateValuesType">  
        <xsd:choice minOccurs="0" maxOccurs="unbounded">  
            <xsd:element name="EncapsulatedX509Certificate"  
            type="EncapsulatedPKIDataType"/>  
            <xsd:element name="OtherCertificate" type="AnyType"/>  
        </xsd:choice>  
        <xsd:attribute name="Id" type="xsd:ID" use="optional"/>  
    </xsd:complexType>

Элемент `EncapsulatedX509Certificate` содержит СОК в формате, определенном 
в СТБ 34.101.19. Сертификат ДОЛЖЕН кодироваться по правилам Base64.

Элемент `OtherCertificate` зарезервирован для будущих альтернативных версий 
сертификата.

### 10.7.8 <a name="xades78"></a>Атрибут `RevocationValues`

Атрибут `RevocationValues` задается одноименным элементом.

Синтаксис `RevocationValues` определяется следующей XML-схемой: 

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->
  
    <xsd:element name="RevocationValues" type="RevocationValuesType"/>
  
    <xsd:complexType name="RevocationValuesType">  
        <xsd:sequence>  
            <xsd:element name="CRLValues" type="CRLValuesType"  
            minOccurs="0"/>
            <xsd:element name="OCSPValues" type="OCSPValuesType"  
            minOccurs="0"/>  
            <xsd:element name="OtherValues" type="OtherCertStatusValuesType"
            minOccurs="0"/>  
        </xsd:sequence>  
        <xsd:attribute name="Id" type="xsd:ID" use="optional"/>  
    </xsd:complexType>
  
    <xsd:complexType name="CRLValuesType">  
        <xsd:sequence>  
            <xsd:element name="EncapsulatedCRLValue"
            type="EncapsulatedPKIDataType"
            maxOccurs="unbounded"/>  
        </xsd:sequence>  
    </xsd:complexType>
  
    <xsd:complexType name="OCSPValuesType">  
        <xsd:sequence>  
            <xsd:element name="EncapsulatedOCSPValue"
            type="EncapsulatedPKIDataType" maxOccurs="unbounded"/>  
        </xsd:sequence>  
    </xsd:complexType>
  
    <xsd:complexType name="OtherCertStatusValuesType">  
        <xsd:sequence>
            <xsd:element name="OtherValue" type="AnyType"
            maxOccurs="unbounded"/>
        </xsd:sequence>  
    </xsd:complexType>

Элемент `CRLValues` содержит последовательность СОС в формате, определенном в
СТБ 34.101.19. Каждый вложенный в `CRLValues` элемент `EncapsulatedCRLValue`
содержит отдельный СОС. СОС ДОЛЖЕН кодироваться по правилам Base64.

Элемент `OCSPValues` содержит последовательность OCSP-ответов. Каждый вложенный
в `OCSPValues` элемент `EncapsulatedOCSPValue` содержит отдельный OCSP-ответ.

Элемент `OtherValues` зарезервирован для будущих альтернативных версий
аттестатов отзыва. Семантика и синтаксис этого элемента выходят за рамки
настоящего стандарта.

### 10.7.9 <a name="xades79"></a>Атрибут `AttributeCertificateValues`

Атрибут `AttributeCertificateValues` задается элементом
`AttrAuthoritiesCertValues`.

Синтаксис `AttributeCertificateValues` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->
  
    <xsd:element name="AttrAuthoritiesCertValues" type="CertificateValuesType"/>

### 10.7.10 <a name="xades710"></a>Атрибут `AttributeRevocationValues`  

Атрибут `AttributeRevocationValues` задается одноименным элементом.

Синтаксис `AttributeRevocationValues` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.3.2#" -->

    <xsd:element name="AttributeRevocationValues" type="RevocationValuesType"/>

## 10.8 <a name="xades8"></a>Атрибуты архивной проверки

### 10.8.1 <a name="xades81"></a>Атрибут `TimeStampValidationData`

Если РЭЦП должна включать все аттестаты, необходимые для проверки штампа
времени, но некоторые из аттестатов отсутствуют, то ДОЛЖЕН быть создан атрибут
`TimeStampValidationData`, содержащий недостающие аттестаты. Этот атрибут ДОЛЖЕН
быть добавлен в контейнер `UnsignedSignatureProperties` сразу после целевого
штампа времени.

Атрибут `TimeStampValidationData` описывается одноименным элементом.

Синтаксис `TimeStampValidationData` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.4.1#"-->
  
    <xsd:element name="TimeStampValidationData" type="ValidationDataType"/>
  
    <xsd:complexType name="ValidationDataType">  
        <xsd:sequence>  
            <xsd:element ref="xades:CertificateValues" minOccurs="0"/>  
            <xsd:element ref="xades:RevocationValues" minOccurs="0"/>  
        </xsd:sequence>  
        <xsd:attribute name="Id" type="xsd:ID" use="optional"/>  
        <xsd:attribute name="URI" type="xsd:anyURI" use="optional"/>  
    </xsd:complexType>

Элемент `CertificateValues` содержит сертификаты, используемые при проверке
штампов времени.

Элемент `RevocationValues` содержит аттестаты отзыва, используемые при проверке
штампов времени.

Если включенные в `TimeStampValidationData` аттестаты относятся к штампу
`SignatureTimeStamp`, `RefsOnlyTimeStamp`, `SigAndRefsTimeStamp` или 
`ArchiveTimeStamp`, то атрибут `URI` НЕ ДОЛЖЕН присутствовать.

Если аттестаты относятся к штампам `IndividualDataObjectsTimeStamp` или 
`AllDataObjectsTimeStamp`, то XML-атрибут `URI` ДОЛЖЕН присутствовать и 
ссылаться на элемент, содержащий штамп.

### 10.8.2 <a name="xades82"></a>Атрибут `ArchiveTimeStamp`

Перед созданием и добавлением к РЭЦП нового атрибута `ArchiveTimeStamp`
в подпись ДОЛЖНЫ быть включены все аттестаты, необходимые для проверки:

- СОК подписанта документа;
- СОК подписанта каждой контрподписи, включенной в РЭЦП;
- каждого атрибутного сертификата и подписанного заявления, включенных в 
  РЭЦП; 
- СОК службы штампов времени для каждого штампа, включенного в РЭЦП.

Атрибут `ArchiveTimeStamp` МОЖЕТ содержать более одного штампа 
времени, из выданных различными службами штампов времени.

Атрибут `ArchiveTimeStamp` задается одноименным элементом.

Синтаксис `ArchiveTimeStamp` определяется следующей XML-схемой: 

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.4.1#-->

    <xsd:element name="ArchiveTimeStamp" type="XAdESTimeStampType"/>

Если штамп `ArchiveTimeStamp` и все неподписанные атрибуты, на которые он
проставлен, имеют общий родительский элемент, то покрытые элементы ДОЛЖНЫ
описываться в штампе неявно. Строка октетов, которая хэшируется перед
постановкой штампа, ДОЛЖНА строиться следующим образом:

1. Начать с пустой результирующей строки октетов.

2. Обработать все ссылки `ds:Reference` в порядке их появления внутри 
элемента `SignedInfo`, в том числе ссылку на `SignedProperties`. 
Для каждой ссылки:

  - применить модель обработки ссылок, определенную в 
    [[5]](#biblio.XML-DSIG) (пункт 4.4.3.2); 
  - если результатом обработки является набор XML-элементов, то канонизировать 
    его;
  - объединить полученные октеты с результирующей строкой октетов.

3. Обработать последовательно элементы `ds:SignedInfo`, `ds:SignatureValue`,
`ds:KeyInfo` (если присутствуют). Канонизировать каждый элемент и объединить
полученные октеты с результирующей строкой октетов.

4. Обработать неподписанные атрибуты, которые встречаются до текущего штампа
`ArchiveTimeStamp`, в порядке их появления внутри элемента
`UnsignedSignatureProperties`. Канонизировать каждый из атрибутов и объединить
полученные октеты с результирующей строкой октетов. Применить следующие правила:

  + атрибут `CertificateValues` ДОЛЖЕН быть добавлен к РЭЦП, если в подписи
    отсутствуют некоторые из СОК, необходимых для ее проверки;
  + атрибут `RevocationValues` ДОЛЖЕН быть добавлен к РЭЦП, если в подписи
    отсутствуют некоторые из аттестатов отзыва, необходимых для ее проверки;
  + атрибут `AttributeCertificateValues` ДОЛЖЕН быть добавлен к РЭЦП, если в
    подписи отсутствуют некоторые из СОК, необходимых для проверки атрибутных
    сертификатов и подписанных утверждений, включенных в подпись.
  + атрибут `AttributeRevocationValues` ДОЛЖЕН быть добавлен к РЭЦП, если в
    подписи отсутствуют некоторые из аттестатов отзыва, необходимых для 
    проверки атрибутных сертификатов и подписанных утверждений, включенных в 
    подпись.

5. Обработать все элементы `ds:Object`, кроме того, который содержит элемент
`QualifyingProperties`, в порядке их появления. Канонизировать каждый из
элементов и добавить к результирующей строке октетов.

Если штамп `ArchiveTimeStamp` и некоторые неподписанные атрибуты, на которые он
проставлен, не имеют общего родительского элемента, то ссылки на неподписанные
атрибуты ДОЛЖНЫ задаваться явно, с помощью вложенных в штамп элементов
`Include`.

Элемент `Include` ДОЛЖЕН создаваться для каждого неподписанного атрибута, уже
включенного в РЭЦП. Элементы `Include` ДОЛЖНЫ добавляться в том же порядке, в
котором неподписанные атрибуты обрабатываются при вычислении хэш-значения штампа
времени. Элементы `Include` ДОЛЖНЫ создаваться только для неподписанных
атрибутов.

Строка октетов, по которой строится хэш-значение штампа, должна строиться по
описанному выше алгоритму. Только на шаге 4 атрибуты обрабатываются в порядке,
заданном ссылками `Include`.

### 10.8.3 <a name="xades83"></a>Атрибут `RenewedDigests`

Атрибут `RenewedDigests` задается одноименным элементом.

Синтаксис `RenewedDigests` определяется следующей XML-схемой:

    <!-- targetNamespace="http://uri.etsi.org/01903/v1.4.1#" -->
  
    <xsd:element name="RenewedDigests" type="RenewedDigestsType"/>
  
    <xsd:complexType name="RenewedDigestsType">  
        <xsd:sequence>  
            <xsd:element ref="ds:DigestMethod"/>  
            <xsd:element ref="RecomputedDigestValue" maxOccurs="unbounded"/>  
        </xsd:sequence>  
        <xsd:attribute name="Id" type="xsd:ID" use="optional"/>  
    </xsd:complexType>
  
    <xsd:element name="RecomputedDigestValue" type="RecomputedDigestValueType"/>
  
    <xsd:complexType name="RecomputedDigestValueType">  
        <xsd:simpleContent>  
            <xsd:extension base="ds:DigestValueType">  
                <xsd:attribute name="Order" type="xsd:integer" use="required"/>  
            </xsd:extension>  
        </xsd:simpleContent>  
    </xsd:complexType>  

Элемент `ds:DigestMethod` задает алгоритм хэширования.

Каждый элемент `RecomputedDigestValue` содержит хэш-значение одного из объектов
подписанных данных, на которые имеются ссылки внутри элемента `ds:Manifest`.
Хэш-значение кодируется по правилам Base64.

При проверке РЭЦП, каждый элемент `RenewedDigests` ДОЛЖЕН обрабатываться
следующим образом:

1. Взять первый элемент `RecomputedDigestValue`.

2. Взять элемент `ds:Reference`, указанный в XML-атрибуте `Order` 
обрабатываемого элемента `RecomputedDigestValue`.

3. Обработать элемент `ds:Reference` в соответствии с моделью обработки ссылок,
заданной в [[5]](#biblio.XML-DSIG), подпункт 4.4.3.2. Если невозможно
получить ссылочные октеты, то уведомить об этом и перейти к шагу 6.

4. Вычислить хэш-значение от полученных октетов.

5. Если вычисленное хэш-значение не совпадает с заявленным, то уведомить 
об этом и перейти к шагу 6.

6. Если остались необработанные элементы `RecomputedDigestValue`, взять 
следующий такой элемент и перейти к шагу 2; в противном случае – закончить.

## 10.9 <a name="xades9"></a>Требования по реализации РЭЦП формата XAdES

В этом подразделе определяются дополнительные требования к подписи XAdES.
Требования относятся ко всем базовым профилям.

Помимо атрибутов, указанных в разделе [7](#profiles), РЭЦП ДОЛЖНА содержать
следующие элементы:

- элемент `ds:KeyInfo/X509Data` (ровно один экземпляр);
- элемент `ds:SignedInfo/ds:CanonicalizationMethod` (ровно один экземпляр);
- элемент `ds:Reference` (не менее двух экземпляров).

Также РЭЦП МОЖЕТ содержать элемент `ds:Reference/ds:Transforms` (не более одного
экземпляра).

Подписант ДОЛЖЕН включать в подэлемент `X509Certificate` элемента
`ds:KeyInfo/X509Data` свой СОК. Подписанту РЕКОМЕНДУЕТСЯ включать в
`ds:KeyInfo/X509Data` все сертификаты, которые могут понадобиться верификатору
при построении цепочки сертификатов.

В `ds:SignedInfo/ds:CanonicalizationMethod` ДОЛЖЕН указываться один из следующих
идентификаторов алгоритмов канонизации:

-  "http://www.w3.org/2006/12/xml-c14n11";
-  "http://www.w3.org/2001/10/xml-exc-c14n#";
-  "http://www.w3.org/TR/2001/REC-xml-c14n-20010315";
-  "http://www.w3.org/2006/12/xml-c14n11#WithComments";
-  "http://www.w3.org/2001/10/xml-exc-c14n#WithComments";
-  "http://www.w3.org/TR/2001/REC-xml-c14n-20010315#WithComments".

Если выбранная трансформация является канонизацией, то один из этих
идентификаторов ДОЛЖЕН быть указан в XML-атрибуте `Algorithm` элемента
`ds:Reference/ds:Transforms`.

В `ds:SignedInfo/ds:CanonicalizationMethod` и `ds:Reference/ds:Transforms`
подписанту НЕ РЕКОМЕНДУЕТСЯ использовать алгоритмы канонизации
"WithComments".

Если трансформация, заданная атрибутом `Transform`, не является канонизацией, то
в XML-атрибуте `Algorithm` элемента `ds:Reference/ds:Transforms` РЕКОМЕНДУЕТСЯ
задавать одно из следующих значений:

-  "http://www.w3.org/2000/09/xmldsig#base64";
-  "http://www.w3.org/2001/10/xml-exc-c14n#";
-  "http://www.w3.org/TR/2001/REC-xml-c14n-20010315";
-  "http://www.w3.org/2006/12/xml-c14n11#WithComments";
-  "http://www.w3.org/2001/10/xml-exc-c14n#WithComments";
-  "http://www.w3.org/TR/2001/REC-xml-c14n-20010315#WithComments".

Аттестаты штампа времени ДОЛЖНЫ быть включены в атрибут
`TimeStampValidationData` или содержаться в самом штампе времени. Аттестаты
штампа времени РЕКОМЕНДУЕТСЯ включать в атрибут `TimeStampValidationData`.

СЛЕДУЕТ избегать дублирования сертификатов в пределах одной РЭЦП.
                                                                                                  
# 11 <a name="pades"></a>Формат PAdES

## 11.1 <a name="pades1"></a>Общие положения

PDF, переносимый формат данных, определен базовой спецификацией
[[18]](#biblio.PDF). PDF описывает структуру цифровых документов, которые
можно обрабатывать на разных платформах. На самом низком уровне PDF-документ
представляет собой последовательность октетов. Из октетов согласно определенным
синтаксическим правилам составляются объекты. Объекты являются базовыми
логическими элементами PDF, они задают структуру и содержание документа. Объекты
могут вкладываться в другие объекты или ссылаться по имени на другие объекты.
Определены контейнеры двух типов: массив — упорядоченная последовательность
объектов и словарь — ассоциативная таблица пар объектов "ключ — значение".

В PDF предусмотрено расширение формата, т.е. добавление в базовый формат новых
объектов и изменение существующих. Использованные расширения указываются в
специальном словаре  `extensions`.

PDF-документы могут подписываться. ЭЦП добавляется в документ, т.е. является
вложенной. Формат подписи описывается в [11.2](#pades2). PAdES расширяет данный
формат и налагает на него ряд ограничений. Расширения и уточнения PAdES
описываются в [11.3](#pades3), [11.4](#pades4).

## 11.2 <a name="pades2"></a>Электронная цифровая подпись PDF

### 11.2.1 <a name="pades21"></a>Словарь `Sig`

ЭЦП хранится внутри документа в специальном словаре `Sig`. В поле `Contents`
словаря хранится базовая ЭЦП и возможно некоторые атрибуты РЭЦП, в других полях
словаря — другие атрибуты.

Хэш-значение, используемое для выработки базовой ЭЦП, вычисляется от набора
октетов, составляющих определенную часть документа. Способы задания целевого
набора октетов описаны в [11.2.2](#pades22).

Структура словаря `Sig` определена в таблице [1](#tab1). В данной таблице, как и во всех
последующих таблицах раздела, в столбце "Обязательность" значение "Опц."
означает, что поле при каких-то условиях может отсутствовать, а значение 
"Обяз." — то, что поле присутствует всегда и имеет непустое значение.

**Таблица 1**. <a name="tab1"></a> Словарь `Sig`

| Ключ (поле) |  Тип |Обязательность| Значение  |
|-------------|------|-----------|-----------|
| Type        | name | Опц.      | `"Sig"`      |
| Filter      | name | Обяз.     | Идентификатор обработчика подписи (см. [11.2.3](#pades23)) |
| SubFilter   | name | Опц.      | Идентификатор кодировки подписи (например, `"ETSI.CAdES.detached"`) |
| Contents    | byte string|Обяз.| Базовая ЭЦП |
| Cert|array или byte string | Опц.| Используется в случае, если СОК не содержится в конверте, хранящемся в `Contents`|
| ByteRange| array | Обяз.         | Массив пар чисел, определяющий набор фрагментов документа, подлежащих включению к выработке хэш-значения|
| Reference| array| Опц.           | Массив словарей `SigRef`, определяющих с помощью механизма трансформаций данные, которые будут подписываться     |
| Changes | array | Опц.           | Специальным образом определяет изменения в документе, сделанные на момент подписания по сравнению с состоянием на момент предыдущего подписания (применяется в случае контрподписей)|
| Name    | text string| Опц.      | Имя подписанта (если его нельзя получить из других источников, например из СОК)|
| M       | date     |   Опц.      | Время подписания (если его нельзя получить из конверта, хранящегося в поле `Contents`)|
| Location| text string| Опц.      | Место подписания (имя хоста, географическое расположение)|
| Reason  | text string| Опц.      | Причины (мотивы), побудившие к подписанию (например, "Я согласен, ....") |
| ContactInfo| text string| Опц.   | Контактные данные подписанта|
| V          | integer | Опц.      | Версия формата словаря `Sig` (значение `1` означает что поле `Reference` обязательное, по умолчанию — `0`) |
| Prop_Build | dictionary| Опц.    | Информация о состоянии системы во время подписания, например идентификатор обработчика подписи, версия программного обеспечения, операционная система |
| Prop_AuthTime| integer| Опц.     | Количество секунд, прошедших с момента последней аутентификации подписанта  |
| Prop_AuthType| name| Опц.        | Метод аутентификации подписанта (например `"PIN"`, `"Password"`, `"Fingerprint"`) |

В таблице [1](#tab1) и других таблицах раздела используются следующие базовые типы 
PDF:

* integer — целое число;
* string — строка;
* name — строка, которая является именем (идентификатором) объекта;
* array — массив;
* dictionary — словарь;
* stream — поток, последовательность октетов, подходящая для данных 
большого объема, например картинок.

Базовый тип `string` уточняется следующими подтипами:

* text string — текст;
* byte string — строка октетов;
* date — время и дата.

Словарь `Sig` может размещаться в документе различными способами. 
Например, словарь `Sig` может быть значением определенного поля PDF-формы, 
или определенный объект документа может содержать ссылку на словарь.
Полная информация о вариантах размещения словаря `Sig` в документе PDF 
содержится в [[18]](#biblio.PDF). 

### 11.2.2 <a name="pades22"></a>Задание подписываемых данных

Существует два способа задания той части документа, которая будет подписываться.

Основной cпособ состоит в использовании поля `ByteRange` словаря `Sig`. Это поле
представляет собой массив пар целых чисел. Каждая пара задает фрагмент
документа. Первое число пары является номером первого октета фрагмента, второе
число — длиной фрагмента. Заданные парами фрагменты конкатенируются и
подписываются.

Альтернативный способ состоит в использовании специального словаря `SigRef`, в
котором указывается так называемый метод трансформации. Этот метод применяется к
документу или его части, на выходе получается набор октетов, подлежащих
подписанию. Детали использования словаря `SigRef` определены в
[[18]](#biblio.PDF).

И в первом, и во втором случаях, обработчик подписи при выработке ЭЦП
добивается, чтобы поле `Contents`, в котором будет содержаться базовая ЭЦП, было
исключено из подписываемых данных. Так, в случае использования `ByteRange`,
обработчику подписи следует сначала зарезервировать определенное количество
октетов под поле `Contents`, а только затем указать `ByteRange` и подписать
данные.

### 11.2.3 <a name="pades23"></a>Обработчик подписи

Обработчик подписи — это программа, которая отвечает за выработку, проверку и
дополнение РЭЦП. Подписи различных видов (например, различных профилей) могут
обрабатываться различными обработчиками.

Идентификатор обработчика (или его префикс) регистрируется в специальном реестре
согласно требованиям [[18]](#biblio.PDF) (приложение E). Идентификатор может
выбираться разработчиком программного обеспечения с учетом требований
уникальности и однозначности определения.

В поле `Filter` словаря `Sig` указывается идентификатор обработчика подписи. Это
может быть либо обработчик, с помощью которого была выработана РЭЦП, либо
обработчик, который рекомендуется использовать при проверке и дополнении
подписи. Несмотря на рекомендации, верификатор может использовать любой другой
обработчик подписи, поддерживающий кодировку, указанную в поле `SubFilter` (см.
[11.2.4](#pades24)).

### 11.2.4 <a name="pades24"></a>Кодировка подписи PDF

Кодировка подписи PDF — это формат значения поля `Contents` в словаре `Sig`.
Идентификатор кодировки указывается обработчиком подписи в поле `SubFilter` во
время выработки ЭЦП. При последующей работе с подписью (дополнение, проверка)
должен использоваться подходящий обработчик подписи — тот, который поддерживает
заданную кодировку.

Обычно при реализации подписи PDF используются такие кодировки, что поле
`Contents` содержит только базовую ЭЦП (без атрибутов). Однако в PAdES
используется кодировка CAdES, и это значит, что в `Contents` хранится не просто
базовая подпись, а РЭЦП формата CAdES. Вложенная в `Contents` подпись CAdES
называется конвертом.

## 11.3 <a name="pades3"></a>PAdES на основе CAdES

### 11.3.1 <a name="pades31"></a>Основные положения

Формат PAdES расширяет базовый формат подписи PDF-документов. Для указания на
расширение в словарь `extensions` СЛЕДУЕТ добавить следующий элемент:

```
<</ESIC
  <</BaseVersion /1.7
    /ExtensionLevel 2
  >>
>>

```

Здесь и далее используется синтаксис словаря PDF. Согласно этому синтаксису,
строка `"ESIC"` — это ключ элемента словаря. Значением элемента является
вложенный словарь с двумя ключами `"BaseVersion"` и `"ExtensionLevel"` и их
значениями — строкой `"/1.7"` и числом 2 соответственно.

### 11.3.2 <a name="pades32"></a>Кодировка CAdES

Кодировкой подписи для PAdES является формат CAdES. Это означает, что поле
`Contents` ДОЛЖНО содержать кодовое представление подписи CAdES одного из
профилей. Соответственно, в поле `SubFilter` ДОЛЖНА быть указана кодировка,
определяющая использование CAdES: `"ETSI.CAdES.detached"`.

При использовании CAdES многие атрибуты РЭЦП (например, СОК) содержатся в
конверте, хранящемся в поле `Contents`, и могут не указываться в соответствующих
полях словаря `Sig`. В частности, поле `Cert` словаря `Sig` НЕ ДОЛЖНО
использоваться.

Использование CAdES в PAdES имеет следующие особенности:
 
- атрибут `SigningTime` НЕ ДОЛЖЕН использоваться. Для определения времени 
служит поле `M` словаря `Sig`;
- атрибут `ContentType` ДОЛЖЕН принимать значение `"id-data"`;
- атрибут `ContentReference` НЕ ДОЛЖЕН использоваться;
- атрибут `ContentHints` НЕ ДОЛЖЕН использоваться;
- атрибут `SignerLocation` НЕ ДОЛЖЕН использоваться. Вместо него 
используется поле `Location` словаря `Sig`;
- атрибут `Countersignature` НЕ ДОЛЖЕН использоваться. Для управления 
контрподписями используется другой механизм, описанный в [11.3.4](#pades34).

### 11.3.3 <a name="pades33"></a>Ограничения на `ByteRange`

В PAdES разрешается использовать только 2 фрагмента в поле `ByteRange`
словаря `Sig`:

<!-- Хотя в ISO 32000-1 это только рекомендуется -->  

- от начала документа до поля `Contents` словаря `Sig`;
- от поля `Contents` до конца документа.

Таким образом, подписываются все октеты, задающие содержимое документа и 
атрибуты РЭЦП, хранящиеся в словаре `Sig`.

### 11.3.4 <a name="pades34"></a>Контрподписи

В PAdES контрподписи реализуются следующим образом. Каждый из подписантов
создает в документе свой словарь `Sig`, содержимое которого заполняется в
соответствии с текущим состоянием документа на момент подписания (PDF позволяет
иметь несколько словарей `Sig`).

Каждый из словарей задает свой `ByteRange` так, что фрагмент для каждой
следующей подписи включает в себя фрагмент для предыдущей. Каждый новый словарь
добавляется в конец документа. Таким образом удается избежать ситуации, когда
предыдущий фрагмент покрывает словарь следующей подписи.

### 11.3.5 <a name="pades35"></a>Дополнительные объекты для долгосрочных подписей

### 11.3.5.1 <a name="pades351"></a>Расширения

В долгосрочных РЭЦП профилей B-LT и B-LTA используются специальные расширения
формата PDF: `"Document security store"` (DSS) и `"Document Time-stamp"` (DTS).
Расширение DSS служит для хранения аттестатов. Расширение DTS служит для
хранения штампа времени. Аттестаты СЛЕДУЕТ хранить в объектах расширений, а не в
атрибутах CAdES. При этом упрощается процесс дополнения подписи, учитывается
специфика управления PDF-документами.

Объекты расширений DSS и DTS создаются в документе в процессе дополнения
подписи. Дополнений может быть несколько, при каждом дополнении в документе
создается определенный набор объектов:

- при дополнении подписи до профиля B-LT создается набор объектов расширения
DSS;
- при дополнении подписи профиля B-LT до подписи профиля B-LTA создаются объекты
расширения DTS;
- при дополнении подписи профиля B-LTA до новой подписи профиля B-LTA создаются
новые объекты DSS (с аттестатами для предыдущих штампов времени) и новые объекты
DTS.

Таким образом, документ с подписью профиля B-LT ДОЛЖЕН содержать объекты
расширения DSS, а документ с подписью профиля B-LTA ДОЛЖЕН содержать один или
несколько наборов объектов DSS и DTS.

Для указания на использование расширений DSS и DTS в словарь `extensions` 
(см. [11.3.1](#pades31)) СЛЕДУЕТ добавить следующий элемент:
 
```
<</ESIC
  <</BaseVersion /1.7
    /ExtensionLevel 1
  >>
>>
```

#### 11.3.5.2 <a name="pades352"></a>Расширение DSS

DSS представляет собой словарь внутри документа, служащий хранилищем для
различных аттестатов. Аттестаты могут относиться к одной или нескольким подписям
PAdES на основе CAdES, к одной или нескольким подписям XAdES в XML-вставках 
(см. [11.4](#pades4)), к встречающимся в документе штампам времени.
 
Расширение DSS описывается словарем `DSS` и словарями `Signature VRI`. Словарь
`DSS` является единственным для всего документа, тогда как каждый из словарей
`Signature VRI` служит для описания определенной подписи (если таковых в
документе несколько, например в случае контрподписей).
 
Поле `VRI` словаря `DSS` ДОЛЖНО храниться в специальном месте документа — так
называемой инкрементальной секции (`"incremental section"`, см.
[[18]](#biblio.PDF)).
 
При проверке подписи, верификатор имеет несколько источников аттестатов. При
поиске аттестатов РЕКОМЕНДУЕТСЯ последовательно проверять сначала словари
`Signature VRI`, затем словарь `DSS`, затем данные, хранящиеся в `Contents`, или
подписи XAdES в XML-вставках.
 
### Структуры словарей `DSS` и `Signature VRI` определены в таблицах [2](#tab2) и [3](#tab3).

**Таблица 2**. <a name="tab2"></a> Словарь `DSS`
 
| Ключ (поле) |  Тип |Обязательность| Значение  |
|-------------|------|-----------|-----------|
| Type        | Name | Опц.      | DSS      |
 VRI      | dictionary | Опц.     | Словарь, ключами которого являются хэш-значения подписей (алгоритм SHA-1), значениями — соответствующие подписям словари `Signature VRI` |
| Certs|        Array|  Опц.| Массив объектов (или ссылок на объекты) типа stream, каждый из которых задает сертификат |
| OCSPs|        Array|  Опц.| Массив объектов (или ссылок на объекты) типа stream, каждый из которых задает OCSP-ответ |
| CRLs|        Array|  Опц.| Массив объектов (или ссылок на объекты) типа stream, каждый из которых задает СОС |

**Таблица 3**. <a name="tab3"></a> Словарь `Signature VRI`

| Ключ (поле) |  Тип |Обязательность| Значение  |
|-------------|------|-----------|-----------|
| Type        | Name | Опц.      | VRI      |
| Cert|        Array|  Опц.| Массив объектов (или ссылок на объекты) типа stream, каждый из которых задает СОК |
| OCSP|        Array|  Опц.| Массив объектов (или ссылок на объекты) типа stream, каждый из которых задает OCSP-ответ |
| CRL|        Array|  Опц.| Массив объектов (или ссылок на объекты) типа stream, каждый из которых задает СОС |
|TU| Date| Опц. | Время создания словаря |
|TS| Stream| Опц. | Штамп времени, соответствующий времени создания данного `Signature VRI` |

#### 11.3.5.3 <a name="pades353"></a>Расширение DTS

Расширение DTS задается словарем `DocTimeStamp`, который хранится в 
документе после словаря `DSS`.
 
Словарь `DocTimeStamp` представляет собой измененный словарь `Sig`.
Изменения описаны в таблице [4](#tab4).

**Таблица 4**. <a name="tab4"></a> Словарь `DocTimeStamp` (изменения относительно `Sig`)

| Ключ (поле) |  Тип |Обязательность| Значение  |
|-------------|------|-----------|-----------|
| Type        | Name | Опц.      | `"DocTimeStamp"`      |
| SubFilter   | Name | Обяз.     | Идентификатор кодировки (`"ETSI.RFC3161"`, или другой, определенный разработчиками системы) |
| Contents    | Byte string | Обяз.| Штамп времени в формате, определенном в СТБ 34.101.82 |
|V            | Integer     | Опц. | 0 | 

Словарь `DocTimeStamp` НЕ ДОЛЖЕН содержать поля `Cert`, `Reference`,
`Changes`, `R`, `Prop_AuthTime`, `Prop_AuthType`.

В словарь НЕ РЕКОМЕНДУЕТСЯ включать поля `Name`, `M`, `Location`, `Reason`,
`ContactInfo` (соответствующие данные присутствуют в конверте, хранящемся в
`Contents`). Верификатору СЛЕДУЕТ игнорировать перечисленные поля при проверке
подписи.

## 11.4 <a name="pades4"></a>PAdES для XML-вставок

Документ PDF может содержать в себе данные в формате XML. Эти данные
представляют собой XML-документ, вложенный в определенный объект PDF.

Вложенный XML-документ МОЖЕТ подписываться. Его подпись XAdES также будет
вложена в PDF-документ как часть XML-документа.

Уже подписанный XML-документ МОЖЕТ быть повторно подписан как часть
PDF-документа. При этом ДОЛЖНА вырабатываться описанная выше подпись PAdES на
основе CAdES.

Для долгосрочных подписей XAdES (профили B-LT и B-LTA) МОГУТ использоваться
расширения DSS и DTS, описанные в [11.3.5](#pades35). Тогда объекты этих
расширений ДОЛЖНЫ включать аттестаты для подписей XAdES.


# <a name="profileEx"></a>Приложение A (рекомендуемое). Расширенные профили

## A.1 <a name="profilesEx1"></a>Общие положения

В настоящем приложении определяются 8 расширенных профилей РЭЦП: E-BES, E-EPES,
E-T, E-C, E-A, E-X, E-X-L, E-X-Long. Профили E-X, E-X-L и E-A могут быть двух
типов.

Профили разбиваются на две группы: профили, не допускающие ссылки на аттестаты
проверки (E-BES, E-EPES, E-T и E-A типа 1), и профили, допускающие ссылки (E-C,
E-X, E-X-L, E-X-Long, E-A типа 2). Профили первой группы являются уточнениями
базовых профилей, однако не расширяют их какими-либо атрибутами. Профили второй
группы позволяют уменьшить размер подписи за счет замены аттестатов проверки на
ссылки на эти аттестаты. Предусмотрены механизмы защиты ссылок.

Расширенные профили связаны друг с другом. Профиль E-EPES строится на основе
E-BES, E-T — на основе E-BES или E-EPES, E-C — на основе E-T, E-X и E-X-Long —
на основе E-C, E-X-L — на основе E-X. Профиль E-A может строиться двумя
различными способами: на основе E-T или на основе профилей, допускающих ссылки
на аттестаты проверки.

РЭЦП любого расширенного профиля формата XAdES разрешают включение атрибутов
двумя способами, описанными в разделе [10](#xades) (прямое и непрямое
включения).

Процессы управления подписями профиля B-B переносятся на подписи профилей E-BES
и E-EPES.

Процессы управления подписями профилей B-T и B-LT переносятся на подписи
профилей E-T, E-C, E-X, E-X-L и E-X-Long.

Процессы управления подписями профиля B-LTA переносятся на подписи профилей E-A
(типов 1 и 2).

## A.2 <a name="profilesEx2"></a>Профили, не допускающие ссылки на аттестаты проверки

### A.2.1 <a name="profilesEx21"></a>Профили E-BES и E-EPES

Профили E-BES и E-EPES уточняют профиль B-B в следующих аспектах.

В РЭЦП профиля E-BES или E-EPES МОЖЕТ содержаться атрибут `SigningTime`.

В РЭЦП профиля E-BES НЕ РЕКОМЕНДУЕТСЯ включение атрибутов 
`SignaturePolicyStore` и `SignaturePolicyIdentifier`.

В РЭЦП профиля E-EPES, наоборот, ДОЛЖЕН быть включен атрибут
`SignaturePolicyIdentifier`. Включение атрибута `SignaturePolicyStore` возможно
только при условии, что атрибут `SignaturePolicyIdentifier` содержит
хэш-значение от документа регламента подписи.

Остальные требования остаются прежними.

### A.2.2 <a name="profilesEx22"></a>Профиль E-T

Профиль E-T является аналогом профиля B-T.

### A.2.3 <a name="profilesEx23"></a>Профиль E-A типа 1

Профиль E-A типа 1 является аналогом профиля B-LTA.

## A.3 <a name="profilesEx3"></a>Профили, допускающие ссылки на аттестаты проверки

### A.3.1 <a name="profilesEx31"></a>Профиль E-С

Дополнительно к атрибутам РЭЦП профиля E-T, РЭЦП данного профиля ДОЛЖНА 
содержать следующие атрибуты: 

- `CompleteCertificateReferences`;
- `CompleteRevocationReferences`.

Если в РЭЦП используются атрибутные сертификаты, то РЭЦП профиля E-С 
ДОЛЖНА содержать следующие атрибуты:

- `AttributeCertificateReferences`;
- `AttributeRevocationReferences`.

### A.3.2 <a name="profilesEx32"></a>Профиль E-X

Данный профиль позволяет включать в РЭЦП штамп времени только на ссылки 
(атрибут `RefsOnlyTimeStamp`) или на ссылки вместе с подписью (атрибут 
`SigAndRefsTimeStamp`). В зависимости от выбранного варианта различают два 
типа данного профиля. 

РЭЦП профиля E-X типа 1 ДОЛЖНА содержать атрибут `SigAndRefsTimeStamp`.

РЭЦП профиля E-X типа 2 ДОЛЖНА содержать атрибут `RefsOnlyTimeStamp`.

### A.3.3 <a name="profilesEx33"></a>Профиль E-X-Long

Профиль E-X-Long строится на профиле E-С путем добавления СОК и атрибутных 
сертификатов, а также аттестатов их отзыва. Следует избегать дублирования
сертификатов и аттестатов отзыва в пределах одной подписи. 

### A.3.4 <a name="profilesEx34"></a>Профиль E-X-L

Данный профиль является расширением профиля E-X и также может быть двух 
типов: профиль E-X-L типа 1 и профиль E-X-L типа 2. 

Профиль E-X-L типа 1 строится на профилях E-X типа 1 и E-X-Long путем 
включения в РЭЦП всех атрибутов, которые свойственны данными профилями. 

Профиль E-X-L типа 2 строится на профилях E-X типа 2 и E-X-Long путем 
включения в РЭЦП всех атрибутов, которые свойственны данными профилями. 

#### A.3.5 <a name="profilesEx35"></a>Профиль E-A типа 2

Данный профиль строится на основании всех вышеупомянутых профилей, 
допускающих ссылки на аттестаты проверки. Также РЭЦП данного профиля 
ДОЛЖНА содержать атрибут `ArchiveTimeStamp`. 

РЭЦП класса XAdES-E-A типа 2 ДОЛЖНА содержать атрибут `RenewedDigests`. 


# <a name="biblio"></a>Библиография 

[1] <a name="biblio.URI"></a> 
Berners-Lee T., Fielding R., Masinter L. 
Uniform Resource Identifier (URI): Generic Syntax. 
Request for Comments: 3986, 2005 
(Унифицированный идентификатор ресурса (URI): общий синтаксис)

[2] <a name="biblio.XML"></a> 
Bray T., Paoli J., Sperberg-McQueen C.M., Maler E., Yergeau F., Cowan J. 
Extensible Markup Language (XML) 1.1 (Second Edition). 
W3C Recommendation, 2006
(Расширяемый язык разметки (XML) 1.1 (вторая редакция))

[3] <a name="biblio.XPONTER"></a>
DeRose S., Maler E., Daniel R. 
The XML Pointer Language (XPointer). 
World Wide Web Consortium (W3C) Recommendation, 2001 
(Язык указателей XML (XPointer))

[4] <a name="biblio.SHA1"></a>
Eastlake 3rd D., Jones P.
US Secure Hash Algorithm 1 (SHA1). 
Request for Comments: 3174, 2001 
(Алгоритм хэширования США версии 1 (SHA1))

[5] <a name="biblio.XML-DSIG"></a>
Eastlake D., Reagle J., Solo D., Hirsch F., Nyström M., Roessler T., Yiu K. 
XML Signature Syntax and Processing Version 1.1. 
W3C Recommendation, 2013
(Синтаксис и обработка XML-подписи. Версия 1.1)

[6] <a name="biblio.XADES1"></a> 
ETSI EN 319 132-1 V1.1.1. 
Electronic Signatures and Infrastructures (ESI); XAdES digital signatures; 
Part 1: Building blocks and XAdES baseline signatures.
European Telecommunications Standards Institute, 2016
(Электронные подписи и инфраструктуры (ESI). Цифровые подписи XAdES. 
Часть 1. Базовые блоки и базовые подписи XAdES)

[7] <a name="biblio.XADES2"></a> 
ETSI EN 319 132-2 V1.1.1.
Electronic Signatures and Infrastructures (ESI);
XAdES digital signatures; Part 2: Extended XAdES signatures.
European Telecommunications Standards Institute, 2016
(Электронные подписи и инфраструктуры (ESI). Цифровые подписи XAdES. 
Часть 2. Расширенные подписи XAdES)

[8] <a name="biblio.CADES1"></a> 
ETSI TS 319 122-1 V1.1.1.
Electronic Signatures and Infrastructures (ESI); CAdES digital signatures;
Part 1: Building blocks and CAdES baseline signatures.
European Telecommunications Standards Institute, 2016
(Электронные подписи и инфраструктуры (ESI). Цифровые подписи CAdES. 
Часть 1. Базовые блоки и базовые подписи CAdES)

[9] <a name="biblio.CADES2"></a> 
ETSI TS 319 122-2 V1.1.1.
Electronic Signatures and Infrastructures (ESI); CAdES digital signatures;
Part 2: Extended CAdES signatures.
European Telecommunications Standards Institute, 2016
(Электронные подписи и инфраструктуры (ESI). CAdES цифровые подписи. 
Часть 2. Расширенные подписи CAdES)

[10] <a name="biblio.PADES1"></a> 
ETSI TS 102 778-1 V1.1.1.
Electronic Signatures and Infrastructures (ESI);
PDF Advanced Electronic Signature Profiles;
Part 1: PAdES Overview — a framework document for PAdES.
European Telecommunications Standards Institute, 2009
(Электронные подписи и инфраструктуры (ESI). Профили расширенных 
электронных подписей PDF. 
Часть 1. Обзор PAdES – базовый документ для PAdES)

[11] <a name="biblio.PADES2"></a> 
ETSI TS 102 778-2 V1.2.1.
Electronic Signatures and Infrastructures (ESI);
PDF Advanced Electronic Signature Profiles;
Part 2: PAdES Basic — Profile based on ISO 32000-1.
European Telecommunications Standards Institute, 2009
(Электронные подписи и инфраструктуры (ESI). Профили расширенных 
электронных подписей PDF. Часть 2. PAdES Basic – профиль на основе ISO 
32000-1)

[12] <a name="biblio.PADES3"></a> 
ETSI TS 102 778-3 V1.1.2.
Electronic Signatures and Infrastructures (ESI);
PDF Advanced Electronic Signature Profiles;
Part 3: PAdES Enhanced — PAdES-BES and PAdES-EPES Profiles.
European Telecommunications Standards Institute, 2009
(Электронные подписи и инфраструктуры (ESI). Профили расширенных 
электронных подписей PDF. Часть 3. Усовершенствованные PAdES – профили 
PAdES-BES и PAdES-EPES)

[13] <a name="biblio.PADES4"></a> 
ETSI TS 102 778-4 V1.1.1.
Electronic Signatures and Infrastructures (ESI);
PDF Advanced Electronic Signature Profiles;
Part 4: PAdES Long Term — PAdES-LTV Profile.
European Telecommunications Standards Institute, 2009
(Электронные подписи и инфраструктуры (ESI). Профили расширенных 
электронных подписей PDF. Часть 4. Долгосрочный PAdES – профиль 
PAdES-LTV)

[14] <a name="biblio.PADES5"></a> 
ETSI TS 102 778-5 V1.1.1.
Electronic Signatures and Infrastructures (ESI);
PDF Advanced Electronic Signature Profiles;
Part 5: PAdES for XML Content — Profiles for XAdES signatures.
European Telecommunications Standards Institute, 2009
(Электронные подписи и инфраструктуры (ESI). Профили расширенных 
электронных подписей PDF. Часть 5. PAdES для XML-контента – профили для 
подписей XAdES)

[15] <a name="biblio.PROCESSES"></a> 
ETSI TS 119 102-1 V1.0.1.
Electronic Signatures and Infrastructures (ESI);
Procedures for Creation and Validation
of AdES Digital Signatures; Part 1: Creation and Validation.
European Telecommunications Standards Institute, 2015
(Электронные подписи и инфраструктуры (ESI). Процедуры создания и проверки 
цифровых подписей AdES. Часть 1. Создание и проверка)

[16] <a name="biblio.MIME"></a> 
Freed N., Borenstein N. 
Multipurpose Internet Mail Extensions (MIME) Part One: Format of Internet 
Message Bodies. 
Request for Comments: 2045, 1996
(Многоцелевые расширения электронной почты в Интернете (MIME). Часть 
первая: формат содержимого сообщений Интернет)

[17] <a name="biblio.ESS"></a>
Hoffman P. 
Enhanced Security Services for S/MIME. 
Request for Comments: 2634, 1999
(Расширенные службы безопасности для S/MIME)

[18] <a name="biblio.PDF"></a> 
ISO 32000-1:2008 
Document management – Portable document format – Part 1: PDF 1.7. 
International Organization for Standardization, 2008
(Управление документами. Переносимый формат документов. Часть 1. PDF 1.7)

[19] <a name="biblio.BASE64"></a>
Josefsson S. 
The Base16, Base32, and Base64 Data Encodings. 
Request for Comments: 4648, 2006
(Кодирование данных Base16, Base32 и Base64)

[20] <a name="biblio.URN"></a> 
Mealling M. A URN Namespace of Object Identifiers. 
Request for Comments: 3061, 2001
(Пространство URN имен идентификаторов объектов)

[21] <a name="biblio.ESSUPD"></a> 
Schaad J. 
Enhanced Security Services (ESS) Update: Adding CertID Algorithm Agility. 
Request for Comments: 5035, 2007
(Обновление для усовершенствованных служб безопасности (ESS): Добавление 
алгоритмической гибкости через CertID)